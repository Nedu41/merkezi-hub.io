<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Merkezi Hub v5.5.2</title>
<meta http-equiv="Cache-Control" content="max-age=31536000, must-revalidate"> 

<style>
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
.btn.pulsing { animation: pulse 1s infinite; }
.btn.success { background: #4CAF50 !important; color: white !important; }
.btn.error { background: #cf6679 !important; color: white !important; }
.btn.warning { background: #ff9800 !important; color: black !important; }

/* MQTT Kontrol iÃ§in yeni stil */
.mqtt-control {
    background: #1a1a1a;
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
    border: 1px solid #333;
}
.mqtt-status {
    font-size: 0.85em;
    padding: 5px 10px;
    border-radius: 4px;
    margin: 5px 0;
    display: inline-block;
}
.mqtt-connected { background: #2E7D32; color: white; }
.mqtt-disconnected { background: #C62828; color: white; }
.mqtt-topic { font-family: monospace; background: #111; padding: 2px 6px; border-radius: 3px; }

body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: #121212; 
    color: #eee; 
    margin: 0; 
    padding-bottom: 20px; 
    font-size: 14px;
}
.header { 
    background: #222; 
    color: #03dac6; 
    padding: 12px; 
    text-align: center; 
    font-size: 1.1em; 
    font-weight: bold; 
    border-bottom: 2px solid #333; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
}
.header span { font-size: 0.8em; color: #888; }
.nav { 
    background: #1a1a1a; 
    padding: 8px; 
    display: flex; 
    justify-content: center; 
    gap: 10px; 
    border-bottom: 1px solid #333; 
    flex-wrap: wrap;
}
.nav a { 
    color: #888; 
    text-decoration: none; 
    font-size: 0.85em; 
    padding: 6px 12px; 
    border-radius: 4px; 
    transition: 0.3s; 
    white-space: nowrap;
}
.nav a.active { background: #3700b3; color: #fff; }

.grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
    gap: 10px; 
    padding: 10px; 
    max-width: 800px; 
    margin: 0 auto; 
}
.card { 
    background: #1e1e1e; 
    border: 1px solid #333; 
    border-radius: 10px; 
    padding: 10px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.5); 
    position: relative; 
    display: flex; 
    flex-direction: column; 
    transition: transform 0.2s; 
}
.card:hover { transform: translateY(-2px); }
.card-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 8px; 
    border-bottom: 1px solid #333; 
    padding-bottom: 5px; 
}
.dev-name { 
    font-weight: bold; 
    font-size: 0.95em; 
    color: #fff; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    max-width: 100px; 
}
.status-dot { 
    width: 10px; 
    height: 10px; 
    border-radius: 50%; 
    background: #555; 
    display: inline-block; 
    margin-right: 5px; 
}
.online-dot { background: #03dac6; box-shadow: 0 0 5px #03dac6; }
.offline-dot { background: #cf6679; }
.timer-icon-btn { 
    background: transparent; 
    border: none; 
    color: #bb86fc; 
    cursor: pointer; 
    font-size: 1.2em; 
    padding: 0 5px; 
}

.relay-row { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    margin-bottom: 8px; 
    background: #252525; 
    padding: 6px; 
    border-radius: 6px; 
}
.relay-label { 
    font-size: 0.8em; 
    color: #aaa; 
    font-weight: bold; 
    width: 25px; 
}
.btn { 
    flex-grow: 1; 
    padding: 8px 5px; 
    border: none; 
    border-radius: 6px; 
    font-weight: bold; 
    font-size: 0.85em; 
    cursor: pointer; 
    transition: 0.2s; 
    text-transform: uppercase; 
    letter-spacing: 0.5px; 
    min-height: 36px;
}
.on { background: #03dac6; color: #000; }
.off { background: #333; color: #ccc; border: 1px solid #444; }
.off:hover { background: #444; }
.sched-info { 
    font-size: 0.65em; 
    color: #bb86fc; 
    text-align: center; 
    margin-top: -3px; 
    margin-bottom: 5px; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    min-height: 14px;
}

.section { 
    margin-top: 5px; 
    background: #2a2a2a; 
    padding: 10px; 
    border-radius: 8px; 
    display: none; 
    border: 1px solid #444; 
    font-size: 0.85em; 
}
.days { 
    display: flex; 
    justify-content: space-between; 
    gap: 2px; 
    margin: 10px 0; 
}
.days label { 
    width: 28px; 
    height: 28px; 
    line-height: 28px; 
    background: #444; 
    color: #eee; 
    border-radius: 4px; 
    text-align: center; 
    cursor: pointer; 
    font-size: 0.75em; 
    font-weight: bold; 
}
.days input[type="checkbox"]:checked + label { background: #bb86fc; color: #000; }
.days input[type="checkbox"] { display: none; }

input[type="time"], input[type="text"], input[type="number"], select { 
    background: #111; 
    border: 1px solid #444; 
    color: #fff; 
    padding: 8px; 
    border-radius: 4px; 
    width: 100%; 
    box-sizing: border-box; 
    font-size: 14px;
}
.action-btns { display: flex; gap: 5px; margin-top: 10px; }

.settings-container { 
    max-width: 600px; 
    margin: 10px auto; 
    padding: 15px; 
    background: #1f1f1f; 
    border-radius: 8px; 
}
table { width: 100%; border-collapse: collapse; }
td { padding: 10px; border-bottom: 1px solid #333; }

.github-info { 
    background: #1a1a1a; 
    padding: 8px 12px; 
    border-radius: 4px; 
    font-size: 0.85em; 
    color: #888; 
    text-align: center;
    margin: 10px auto;
    border: 1px solid #333;
    max-width: 800px;
}
.github-info.active { border-color: #4CAF50; color: #4CAF50; }
.github-info.inactive { border-color: #cf6679; color: #cf6679; }

/* MQTT Kontrol Paneli */
.mqtt-panel {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 15px;
    margin: 15px auto;
    max-width: 800px;
    border: 1px solid #333;
}
.mqtt-panel h3 {
    color: #03dac6;
    margin-top: 0;
    border-bottom: 1px solid #333;
    padding-bottom: 8px;
}
.mqtt-topics {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 15px;
}
.mqtt-topic-item {
    background: #252525;
    padding: 12px;
    border-radius: 5px;
    border-left: 4px solid #bb86fc;
}
.mqtt-topic-item h4 {
    margin: 0 0 8px 0;
    color: #bb86fc;
    font-size: 0.9em;
}
.mqtt-topic-value {
    font-family: monospace;
    background: #111;
    padding: 6px;
    border-radius: 3px;
    font-size: 0.85em;
    word-break: break-all;
    min-height: 20px;
}

/* Loading spinner */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #03dac6;
    animation: spin 1s ease-in-out infinite;
    margin-right: 10px;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* IP Kontrol Paneli */
.ip-control {
    background: #1a1a1a;
    padding: 10px;
    border-radius: 8px;
    margin: 10px auto;
    border: 1px solid #333;
    max-width: 800px;
    text-align: center;
}
.ip-display {
    background: #111;
    padding: 8px 12px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
    margin: 5px 0;
    display: inline-block;
}
.ip-display.connected { color: #4CAF50; border: 1px solid #4CAF50; }
.ip-display.disconnected { color: #cf6679; border: 1px solid #cf6679; }

</style>
</head>
<body>

<div class="header">
    <div>MERKEZÄ° HUB v5.5.2</div>
    <span id="clock">00:00</span>
</div>

<div class="nav">
  <a href="/" id="nav1" onclick="route('/');return false;">ğŸ“Š Panel</a>
  <a href="/settings" id="nav2" onclick="route('/settings');return false;">âš™ï¸ Cihazlar</a>
  <a href="/weather" id="nav3" onclick="route('/weather');return false;">ğŸŒ¤ï¸ Oto-Hava</a>
  <a href="/mqtt" id="nav4" onclick="route('/mqtt');return false;">ğŸ“¡ MQTT</a>
</div>

<div id="content">
    <div style="text-align:center;padding:40px;color:#888">
        <div class="loading"></div>
        <div>Sistem yÃ¼kleniyor...</div>
    </div>
</div>

<!-- ESP32 IP Kontrol Paneli -->
<div class="ip-control">
    <div style="display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap">
        <button class="btn" onclick="setupESP32IP()" style="background:#bb86fc;font-size:0.9em">
            ğŸŒ ESP32 IP Ayarla
        </button>
        <button class="btn" onclick="showIPInfo()" style="background:#FF9800;font-size:0.9em">
            â„¹ï¸ IP Bilgisi
        </button>
        <div class="ip-display disconnected" id="ipDisplay">
            ESP32 IP: AyarlanmadÄ±
        </div>
    </div>
    <div id="ipStatus"></div>
</div>

<div id="githubStatus" class="github-info inactive">GitHub: YÃ¼kleniyor...</div>

<script>
// ===================== DEÄÄ°ÅKENLER =====================
let DEVICES = [];
let STATUS = {};
let CURRENT_WEATHER = {};
let WEATHER_CONFIG = {};
let APP_STATUS = {
    loading: true,
    error: null,
    lastUpdate: null
};

// ESP32 IP Adresi
let ESP32_BASE_URL = '';

const daysName = ["Pt","Sa","Ã‡a","Pe","Cu","Ct","Pz"];

// MQTT Topic'ler
const MQTT_TOPICS = {
    RELAY1_SET: 'nejat/relay/1/set',
    RELAY1_STATE: 'nejat/relay/1/state',
    RELAY2_SET: 'nejat/relay/2/set',
    RELAY2_STATE: 'nejat/relay/2/state',
    HUB_ONLINE: 'nejat/hub/online',
    HUB_STATUS: 'nejat/hub/status',
    HUB_GITHUB: 'nejat/hub/github',
    HUB_MODE: 'nejat/hub/mode',
    HUB_IP: 'nejat/hub/ip'
};

// ===================== ESP32 IP YÃ–NETÄ°MÄ° =====================
function initESP32Config() {
    // 1. localStorage'da kayÄ±tlÄ± IP'yi kontrol et
    const savedIP = localStorage.getItem('esp32_ip');
    
    // 2. URL parametresinden IP al (Ã¶rnek: ?esp32_ip=192.168.1.100)
    const urlParams = new URLSearchParams(window.location.search);
    const urlIP = urlParams.get('esp32_ip');
    
    // Ã–ncelik sÄ±rasÄ±: URL parametresi > localStorage
    if (urlIP) {
        ESP32_BASE_URL = `http://${urlIP}`;
        localStorage.setItem('esp32_ip', urlIP);
    } else if (savedIP) {
        ESP32_BASE_URL = `http://${savedIP}`;
    }
    
    // IP bilgisini gÃ¶ster
    updateIPDisplay();
}

function setupESP32IP() {
    const currentIP = ESP32_BASE_URL.replace('http://', '') || '192.168.1.100';
    const newIP = prompt(`ESP32'nin IP adresini girin:\n(Ã–rnek: 192.168.1.100)`, currentIP);
    
    if (newIP && newIP.trim()) {
        // IP formatÄ±nÄ± kontrol et
        const ipPattern = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
        if (!ipPattern.test(newIP)) {
            alert('GeÃ§ersiz IP formatÄ±! Ã–rnek: 192.168.1.100');
            return;
        }
        
        ESP32_BASE_URL = `http://${newIP}`;
        localStorage.setItem('esp32_ip', newIP);
        
        // KullanÄ±cÄ±ya bilgi ver
        document.getElementById('ipStatus').innerHTML = `
            <div style="background:#4CAF50;color:white;padding:8px;border-radius:5px;margin:8px 0;font-size:0.9em">
                âœ… IP gÃ¼ncellendi: ${newIP}<br>
                Sayfa yeniden yÃ¼kleniyor...
            </div>
        `;
        
        // IP bilgisini gÃ¼ncelle
        updateIPDisplay();
        
        // 2 saniye sonra sayfayÄ± yenile
        setTimeout(() => location.reload(), 2000);
    }
}

function showIPInfo() {
    const ip = ESP32_BASE_URL.replace('http://', '');
    const message = ip 
        ? `ESP32 IP Adresi: ${ip}\n\nDeÄŸiÅŸtirmek iÃ§in "IP Ayarla" butonunu kullanÄ±n.`
        : 'ESP32 IP adresi henÃ¼z ayarlanmamÄ±ÅŸ.\nLÃ¼tfen "IP Ayarla" butonuna tÄ±klayÄ±n.';
    alert(message);
}

function updateIPDisplay() {
    const ipDisplay = document.getElementById('ipDisplay');
    if (ipDisplay) {
        const displayIP = ESP32_BASE_URL.replace('http://', '');
        if (displayIP) {
            ipDisplay.textContent = `ESP32 IP: ${displayIP}`;
            ipDisplay.className = 'ip-display connected';
        } else {
            ipDisplay.textContent = 'ESP32 IP: AyarlanmadÄ±';
            ipDisplay.className = 'ip-display disconnected';
        }
    }
}

// ===================== TEMEL FONKSÄ°YONLAR =====================
function updateClock() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('tr-TR', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false
    });
    document.getElementById('clock').textContent = timeStr;
}

// Saat gÃ¼ncelleme
updateClock();
setInterval(updateClock, 1000);

function handleError(error, context) {
    console.error(`Hata (${context}):`, error);
    
    let userMessage = error.message;
    
    // Ã–zel hata mesajlarÄ±
    if (error.message.includes('ESP32\'ye baÄŸlanÄ±lamadÄ±') || error.message.includes('Zaman aÅŸÄ±mÄ±')) {
        userMessage = `ğŸŒ BaÄŸlantÄ± HatasÄ±\n\nESP32'ye baÄŸlanÄ±lamÄ±yor.\nIP: ${ESP32_BASE_URL || 'AyarlanmamÄ±ÅŸ'}\n\nLÃ¼tfen IP adresini kontrol edin ve "IP Ayarla" butonuna tÄ±klayÄ±n.`;
    } else if (error.message.includes('Endpoint bulunamadÄ±')) {
        userMessage = `ğŸ”Œ API HatasÄ±\n\nESP32'de ${context} endpoint'i bulunamadÄ±.\nESP32 kodunun Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.`;
    }
    
    APP_STATUS.error = userMessage;
    
    const contentDiv = document.getElementById('content');
    if (contentDiv) {
        contentDiv.innerHTML = `
            <div style="text-align:center;padding:30px;max-width:500px;margin:0 auto">
                <div style="font-size:3em;color:#cf6679;margin-bottom:20px">âš ï¸</div>
                <h3 style="color:#cf6679">Sistem HatasÄ±</h3>
                <div style="background:#1a1a1a;padding:15px;border-radius:8px;margin:20px 0;text-align:left">
                    ${userMessage.replace(/\n/g, '<br>')}
                </div>
                <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:20px">
                    <button class="btn" onclick="location.reload()" style="background:#03dac6">
                        ğŸ”„ Yeniden Dene
                    </button>
                    <button class="btn" onclick="setupESP32IP()" style="background:#bb86fc">
                        ğŸŒ IP Ayarla
                    </button>
                </div>
            </div>
        `;
    }
}

async function fetchWithTimeout(url, options = {}, timeout = 10000) {
    // ESP32 base URL'ini ekle
    const fullUrl = ESP32_BASE_URL ? ESP32_BASE_URL + url : url;
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    
    try {
        const response = await fetch(fullUrl, {
            ...options,
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response;
    } catch (error) {
        clearTimeout(timeoutId);
        
        // Network hatasÄ± iÃ§in Ã¶zel mesaj
        if (error.name === 'AbortError') {
            throw new Error(`Zaman aÅŸÄ±mÄ±: ${url} yÃ¼klenemedi`);
        } else if (error.message.includes('Failed to fetch')) {
            throw new Error(`ESP32'ye baÄŸlanÄ±lamadÄ±. IP: ${ESP32_BASE_URL}`);
        }
        
        throw error;
    }
}

async function fetchDevices() {
    try {
        const response = await fetchWithTimeout("/get_devices");
        DEVICES = await response.json();
        return DEVICES;
    } catch (error) {
        handleError(error, "Cihazlar yÃ¼klenirken");
        // VarsayÄ±lan cihaz listesi
        DEVICES = [
            { name: "Salon", ip: "192.168.1.100" },
            { name: "Mutfak", ip: "192.168.1.101" }
        ];
        return DEVICES;
    }
}

async function fetchStatus() {
    try {
        const response = await fetchWithTimeout("/fetch_status");
        const data = await response.json();
        
        STATUS = data.devices || {};
        CURRENT_WEATHER = data.weather || {};
        WEATHER_CONFIG = data.weather_config || {};
        
        // GitHub durumunu gÃ¼ncelle
        const githubStatus = document.getElementById('githubStatus');
        if (githubStatus) {
            if (data.github_mode) {
                githubStatus.textContent = `GitHub: ${data.github_mode.toUpperCase()} MOD`;
                githubStatus.className = data.github_mode === 'github' ? 'github-info active' : 'github-info inactive';
            }
        }
        
        APP_STATUS.lastUpdate = new Date();
        APP_STATUS.loading = false;
        
        return data;
    } catch (error) {
        handleError(error, "Durum yÃ¼klenirken");
        return {};
    }
}

// ===================== NAVÄ°GASYON =====================
function route(path) {
    history.pushState(null, '', path);
    navigate();
    return false;
}

window.onpopstate = navigate;

// GitHub KontrolÃ¼
function githubControl(action) {
    fetchWithTimeout(`/github_control?action=${action}`)
        .then(r => r.text())
        .then(response => {
            alert(response);
            if (action === 'update' || action === 'enable' || action === 'disable') {
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(err => {
            alert('GitHub kontrolÃ¼ baÅŸarÄ±sÄ±z: ' + err.message);
        });
}

// YÃ¼kleme gÃ¶ster/gizle
function showLoading() {
    const content = document.getElementById('content');
    if (content) {
        content.innerHTML = `
            <div style="text-align:center;padding:40px;color:#888">
                <div class="loading"></div>
                <div>Ä°ÅŸlem yapÄ±lÄ±yor...</div>
            </div>
        `;
    }
}

// Geri bildirim
function feedbackSuccess(btnId) {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    
    const originalText = btn.textContent;
    const originalClass = btn.className;
    
    btn.textContent = 'âœ“ OK';
    btn.className = 'btn success';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.textContent = originalText;
        btn.className = originalClass;
        btn.disabled = false;
    }, 2000);
}

// ===================== ANA PANEL =====================
function renderControl() {
    let html = `<div class="grid">`;
    
    if (!DEVICES || DEVICES.length === 0) {
        html += `
            <div style="text-align:center;width:100%;padding:30px;color:#cf6679;grid-column:1/-1">
                <h4>âŒ Cihaz BulunamadÄ±</h4>
                <p>Cihaz eklemek iÃ§in Ayarlar > Cihazlar sekmesine gidin.</p>
                <button class="btn" onclick="route('/settings')" style="margin-top:15px;background:#03dac6">
                    Cihaz Ekle
                </button>
            </div>`;
    } else {
        DEVICES.forEach((dev, i) => {
            html += `
            <div class="card">
                <div class="card-header">
                    <div style="display:flex;align-items:center">
                        <span class="status-dot" id="dot_${i}"></span>
                        <span class="dev-name" title="${dev.ip}">${dev.name}</span>
                    </div>
                    <button class="timer-icon-btn" onclick="openSect(${i})" title="ZamanlayÄ±cÄ± AyarlarÄ±">ğŸ•’</button>
                </div>

                <div class="relay-row">
                    <div class="relay-label">R1</div>
                    <button class="btn off" id="b1_${i}" onclick="toggle(${i},1)">...</button>
                    <button class="btn" onclick="mqttControl('${dev.name}', 1, 'toggle')" style="background:#bb86fc;margin-left:5px;padding:5px 8px;flex:0 0 auto" title="MQTT Kontrol">ğŸ“¡</button>
                </div>
                <div class="sched-info" id="p1_${i}"></div>

                <div class="relay-row">
                    <div class="relay-label">R2</div>
                    <button class="btn off" id="b2_${i}" onclick="toggle(${i},2)">...</button>
                    <button class="btn" onclick="mqttControl('${dev.name}', 2, 'toggle')" style="background:#bb86fc;margin-left:5px;padding:5px 8px;flex:0 0 auto" title="MQTT Kontrol">ğŸ“¡</button>
                </div>
                <div class="sched-info" id="p2_${i}"></div>

                <div class="section" id="sec_${i}">
                    <div style="display:flex;gap:10px;justify-content:center;margin-bottom:10px;">
                        <label style="cursor:pointer">
                            <input type="radio" name="r${i}" value="1" checked onchange="loadProgValues(${i})"> RÃ¶le 1
                        </label>
                        <label style="cursor:pointer">
                            <input type="radio" name="r${i}" value="2" onchange="loadProgValues(${i})"> RÃ¶le 2
                        </label>
                    </div>
                    
                    <div style="display:flex;gap:5px;align-items:center;margin-bottom:10px">
                        <input type="time" id="t1_${i}" value="08:00" style="flex:1"> 
                        <span style="color:#888">-</span> 
                        <input type="time" id="t2_${i}" value="18:00" style="flex:1">
                    </div>

                    <div class="days">
                        ${daysName.map((d,j) => `
                            <input type="checkbox" id="d${i}_${j}">
                            <label for="d${i}_${j}">${d}</label>
                        `).join('')}
                    </div>
                    
                    <div class="action-btns">
                        <button class="btn on" id="saveProgBtn_${i}" onclick="saveProg(${i})">KAYDET</button>
                        <button class="btn off" onclick="clearProg(${i})">SÄ°L</button>
                    </div>
                </div>
            </div>`;
        });
    }
    
    html += `</div>`;
    
    // GitHub ve MQTT kontrol butonlarÄ±
    html += `
    <div style="max-width:800px;margin:20px auto;padding:0 10px">
        <div class="mqtt-control">
            <h4 style="margin:0 0 10px 0;color:#03dac6;text-align:center">ğŸ“¡ MQTT HÄ±zlÄ± Kontrol</h4>
            <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
                <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY1_SET}', 'ON')" style="background:#4CAF50;flex:1;min-width:120px">RÃ¶le1 AÃ‡</button>
                <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY1_SET}', 'OFF')" style="background:#cf6679;flex:1;min-width:120px">RÃ¶le1 KAPAT</button>
                <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY2_SET}', 'ON')" style="background:#4CAF50;flex:1;min-width:120px">RÃ¶le2 AÃ‡</button>
                <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY2_SET}', 'OFF')" style="background:#cf6679;flex:1;min-width:120px">RÃ¶le2 KAPAT</button>
            </div>
        </div>
        
        <div style="margin-top:15px;text-align:center">
            <button class="btn" onclick="githubControl('update')" style="background:#333;margin:5px;min-width:140px">ğŸ”„ GitHub GÃ¼ncelle</button>
            <button class="btn" onclick="githubControl('enable')" style="background:#4CAF50;margin:5px;min-width:140px">âœ… GitHub Aktif</button>
            <button class="btn" onclick="githubControl('disable')" style="background:#cf6679;margin:5px;min-width:140px">âŒ GitHub Pasif</button>
        </div>
    </div>`;
    
    document.getElementById("content").innerHTML = html;
    
    // Durum gÃ¼ncellemesini baÅŸlat
    updateDeviceStatus();
}

// Durum GÃ¼ncelleme
function updateDeviceStatus() {
    fetchStatus().then(() => {
        if (!DEVICES || !Array.isArray(DEVICES)) return;
        
        DEVICES.forEach((dev, i) => {
            const s = STATUS[dev.name] || { r1_state: "OFFLINE", r2_state: "OFFLINE" };
            
            // Online/Offline Durumu
            const online = s.r1_state !== "OFFLINE" && s.r2_state !== "OFFLINE";
            const dot = document.getElementById("dot_" + i);
            if (dot) {
                dot.className = "status-dot " + (online ? "online-dot" : "offline-dot");
            }

            // RÃ¶le DurumlarÄ±
            for (let r = 1; r <= 2; r++) {
                const state = s[`r${r}_state`] || "OFFLINE";
                const btn = document.getElementById(`b${r}_${i}`);
                const prog = document.getElementById(`p${r}_${i}`);

                if (btn) {
                    if (state === "OFFLINE") {
                        btn.textContent = "âŒ HATA";
                        btn.className = "btn error";
                        btn.disabled = true;
                    } else {
                        btn.textContent = state === "ON" ? "âœ… AÃ‡IK" : "â­• KAPALI";
                        btn.className = "btn " + (state === "ON" ? "on" : "off");
                        btn.disabled = false;
                    }
                }
                
                if (prog) {
                    const active = s[`sched_active_r${r}`] === "true";
                    const start = s[`sched_start_r${r}`] || "";
                    const end = s[`sched_end_r${r}`] || "";
                    prog.innerText = active ? `ğŸ•’ ${start} - ${end}` : "";
                }
            }
        });
    }).catch(err => {
        console.error("Durum gÃ¼ncelleme hatasÄ±:", err);
    });
}

// ZamanlayÄ±cÄ± BÃ¶lÃ¼mÃ¼ AÃ§/Kapa
function openSect(i) {
    const allSections = document.querySelectorAll('.section');
    allSections.forEach(sec => {
        sec.style.display = 'none';
    });
    
    const sec = document.getElementById("sec_" + i);
    if (sec) {
        sec.style.display = sec.style.display === "block" ? "none" : "block";
        if (sec.style.display === "block") {
            loadProgValues(i);
        }
    }
}

// SeÃ§ili RÃ¶le
function getRelay(i) {
    const selected = document.querySelector(`input[name="r${i}"]:checked`);
    return selected ? selected.value : "1";
}

// GÃ¼n Maskesi
function getMask(i) {
    let mask = 0;
    for (let j = 0; j < 7; j++) {
        const checkbox = document.getElementById(`d${i}_${j}`);
        if (checkbox && checkbox.checked) {
            mask |= 1 << j;
        }
    }
    return mask;
}

// RÃ¶le Toggle
function toggle(i, r) {
    const dev = DEVICES[i];
    if (!dev) return;
    
    const btn = document.getElementById(`b${r}_${i}`);
    if (!btn) return;
    
    const originalText = btn.textContent;
    const originalClass = btn.className;
    
    // Optimistik UI
    btn.textContent = "â³";
    btn.disabled = true;
    
    // RÃ¶le durumunu belirle
    const action = originalText.includes("AÃ‡IK") ? "off" : "on";
    
    fetchWithTimeout(`/proxy?ip=${encodeURIComponent(dev.ip)}&url=${encodeURIComponent("/control?id=" + r + "&action=" + action)}`)
        .then(response => {
            if (response.ok) {
                btn.textContent = action === "on" ? "âœ… AÃ‡IK" : "â­• KAPALI";
                btn.className = action === "on" ? "btn on" : "btn off";
                // 500ms sonra durumu gÃ¼ncelle
                setTimeout(updateDeviceStatus, 500);
            } else {
                throw new Error("HTTP hatasÄ±");
            }
        })
        .catch(error => {
            console.error("Toggle hatasÄ±:", error);
            btn.textContent = originalText;
            btn.className = originalClass;
            btn.disabled = false;
            alert(`${dev.name} cihazÄ± ile iletiÅŸim kurulamadÄ±.`);
        });
}

// MQTT Kontrol
function mqttPublish(topic, message) {
    console.log(`MQTT Publish: ${topic} -> ${message}`);
    alert(`MQTT komutu gÃ¶nderildi:\n${topic} = ${message}\n\nNot: ESP32'nizde MQTT istemcisi Ã§alÄ±ÅŸÄ±yor olmalÄ±.`);
}

function mqttControl(deviceName, relay, action) {
    const topic = relay === 1 ? MQTT_TOPICS.RELAY1_SET : MQTT_TOPICS.RELAY2_SET;
    let message = action.toUpperCase();
    
    if (action === 'toggle') {
        const deviceIndex = DEVICES.findIndex(d => d.name === deviceName);
        const btn = document.getElementById(`b${relay}_${deviceIndex}`);
        if (btn && btn.textContent.includes('AÃ‡IK')) {
            message = 'OFF';
        } else {
            message = 'ON';
        }
    }
    
    mqttPublish(topic, message);
}

// ZamanlayÄ±cÄ± Kaydet
function saveProg(i) {
    const dev = DEVICES[i];
    if (!dev) return;
    
    const r = getRelay(i);
    const start = document.getElementById(`t1_${i}`).value;
    const end = document.getElementById(`t2_${i}`).value;
    const mask = getMask(i);
    
    if (!mask) {
        alert("LÃ¼tfen en az bir gÃ¼n seÃ§in!");
        return;
    }
    
    const [sh, sm] = start.split(":");
    const [eh, em] = end.split(":");
    
    // Local Storage'a kaydet
    localStorage.setItem(`p_${dev.name}_r${r}_s`, start);
    localStorage.setItem(`p_${dev.name}_r${r}_e`, end);
    localStorage.setItem(`p_${dev.name}_r${r}_m`, mask);
    
    const url = `/save?relay_id=${r}&start_h=${sh}&start_m=${sm}&end_h=${eh}&end_m=${em}&days=${mask}&active=1`;
    fetchWithTimeout(`/proxy?ip=${encodeURIComponent(dev.ip)}&url=${encodeURIComponent(url)}`)
        .then(response => {
            if (response.ok) {
                feedbackSuccess('saveProgBtn_' + i);
                setTimeout(updateDeviceStatus, 1000);
            } else {
                alert("ZamanlayÄ±cÄ± kaydedilemedi!");
            }
        })
        .catch(() => alert("Ä°letiÅŸim hatasÄ±!"));
}

// ZamanlayÄ±cÄ± Temizle
function clearProg(i) {
    const dev = DEVICES[i];
    if (!dev) return;
    
    const r = getRelay(i);
    
    if (!confirm(`"${dev.name}" cihazÄ±nÄ±n R${r} rÃ¶lesi iÃ§in zamanlayÄ±cÄ±yÄ± iptal etmek istiyor musunuz?`)) {
        return;
    }
    
    // Local Storage'dan sil
    localStorage.removeItem(`p_${dev.name}_r${r}_s`);
    localStorage.removeItem(`p_${dev.name}_r${r}_e`);
    localStorage.removeItem(`p_${dev.name}_r${r}_m`);
    
    fetchWithTimeout(`/proxy?ip=${encodeURIComponent(dev.ip)}&url=${encodeURIComponent(`/save?relay_id=${r}&days=0&active=0`)}`)
        .then(() => {
            alert("ZamanlayÄ±cÄ± iptal edildi!");
            setTimeout(updateDeviceStatus, 800);
        })
        .catch(() => alert("Ä°letiÅŸim hatasÄ±!"));
}

// ZamanlayÄ±cÄ± DeÄŸerlerini YÃ¼kle
function loadProgValues(i) {
    const dev = DEVICES[i];
    if (!dev) return;
    
    const r = getRelay(i);
    const s = localStorage.getItem(`p_${dev.name}_r${r}_s`);
    const e = localStorage.getItem(`p_${dev.name}_r${r}_e`);
    const m = localStorage.getItem(`p_${dev.name}_r${r}_m`);
    
    const startInput = document.getElementById(`t1_${i}`);
    const endInput = document.getElementById(`t2_${i}`);
    
    if (startInput) startInput.value = s || "08:00";
    if (endInput) endInput.value = e || "18:00";
    
    const mask = m ? parseInt(m) : 127; // VarsayÄ±lan: tÃ¼m gÃ¼nler
    for (let j = 0; j < 7; j++) {
        const checkbox = document.getElementById(`d${i}_${j}`);
        if (checkbox) {
            checkbox.checked = (mask & (1 << j)) !== 0;
        }
    }
}

// ===================== MQTT KONTROL SAYFASI =====================
function renderMqttControl() {
    let html = `
    <div class="mqtt-panel">
        <h3>ğŸ“¡ MQTT Uzaktan Kontrol Paneli</h3>
        
        <div class="mqtt-status mqtt-disconnected">
            âŒ MQTT: ESP32'ye baÄŸlÄ± deÄŸil
        </div>
        
        <div style="margin:15px 0">
            <h4>MQTT Topic Listesi:</h4>
            <div class="mqtt-topics">
                <div class="mqtt-topic-item">
                    <h4>${MQTT_TOPICS.RELAY1_SET}</h4>
                    <p>RÃ¶le 1 KontrolÃ¼</p>
                    <div class="action-btns">
                        <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY1_SET}', 'ON')" style="background:#4CAF50">AÃ‡</button>
                        <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY1_SET}', 'OFF')" style="background:#cf6679">KAPAT</button>
                    </div>
                </div>
                
                <div class="mqtt-topic-item">
                    <h4>${MQTT_TOPICS.RELAY2_SET}</h4>
                    <p>RÃ¶le 2 KontrolÃ¼</p>
                    <div class="action-btns">
                        <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY2_SET}', 'ON')" style="background:#4CAF50">AÃ‡</button>
                        <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY2_SET}', 'OFF')" style="background:#cf6679">KAPAT</button>
                    </div>
                </div>
                
                <div class="mqtt-topic-item">
                    <h4>${MQTT_TOPICS.HUB_STATUS}</h4>
                    <p>Hub Durum MesajÄ±</p>
                    <div class="action-btns">
                        <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.HUB_STATUS}', 'Test_' + Date.now())" style="background:#2196F3">Test MesajÄ±</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="margin-top:20px">
            <h4>Ã–zel MQTT Komutu:</h4>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <input type="text" id="customTopic" placeholder="nejat/relay/1/set" style="flex:1;min-width:200px" value="${MQTT_TOPICS.RELAY1_SET}">
                <input type="text" id="customMessage" placeholder="ON veya OFF" style="flex:1;min-width:150px">
                <button class="btn on" onclick="sendCustomMqtt()" style="min-width:100px">GÃ¶nder</button>
            </div>
        </div>
    </div>`;
    
    document.getElementById("content").innerHTML = html;
}

function sendCustomMqtt() {
    const topic = document.getElementById('customTopic').value.trim();
    const message = document.getElementById('customMessage').value.trim();
    
    if (!topic || !message) {
        alert('LÃ¼tfen topic ve mesaj girin!');
        return;
    }
    
    mqttPublish(topic, message);
    document.getElementById('customMessage').value = '';
}

// ===================== AYARLAR SAYFASI =====================
function renderSettings() {
    let html = `
    <div class="settings-container">
        <h3>ğŸ“± Cihaz YÃ¶netimi</h3>
        <table id="devicesTable">
            <tr style="background:#2a2a2a">
                <th>Cihaz AdÄ±</th>
                <th>IP Adresi</th>
                <th>Ä°ÅŸlem</th>
            </tr>`;
    
    if (DEVICES.length === 0) {
        html += `
            <tr>
                <td colspan="3" style="text-align:center;padding:20px;color:#888">
                    HenÃ¼z cihaz eklenmemiÅŸ.
                </td>
            </tr>`;
    } else {
        DEVICES.forEach((d, i) => {
            html += `
            <tr>
                <td><input type="text" id="n${i}" value="${d.name || ''}" style="width:100%"></td>
                <td><input type="text" id="i${i}" value="${d.ip || ''}" style="width:100%"></td>
                <td><button class="btn error" onclick="deleteDevice(${i})" title="Sil" style="padding:6px 10px">ğŸ—‘ï¸</button></td>
            </tr>`;
        });
    }
    
    html += `</table>
        <br>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <button class="btn" onclick="addDevice()" style="background:#4CAF50">â• Yeni Cihaz</button>
            <button class="btn on" id="saveDevBtn" onclick="saveDevices()">ğŸ’¾ Kaydet</button>
        </div>
        
        <hr style="border-top:1px solid #333;margin:20px 0">
        
        <h3>âš™ï¸ Sistem Ä°ÅŸlemleri</h3>
        <div style="display:flex;flex-direction:column;gap:10px">
            <button class="btn warning" onclick="restartHub()">ğŸ”„ Hub'Ä± Yeniden BaÅŸlat</button>
            <button class="btn error" onclick="resetWifi()">ğŸ“¡ WiFi AyarlarÄ±nÄ± SÄ±fÄ±rla</button>
            <button class="btn" onclick="route('/mqtt')" style="background:#9C27B0">ğŸ“¡ MQTT Kontrol Paneli</button>
        </div>
    </div>`;
    
    document.getElementById("content").innerHTML = html;
}

function addDevice() {
    const newIndex = DEVICES.length;
    DEVICES.push({
        name: `Cihaz_${newIndex + 1}`,
        ip: "192.168.1."
    });
    renderSettings();
}

function deleteDevice(index) {
    if (confirm(`"${DEVICES[index].name}" cihazÄ±nÄ± silmek istiyor musunuz?`)) {
        DEVICES.splice(index, 1);
        renderSettings();
    }
}

function saveDevices() {
    const devicesToSave = [];
    
    for (let j = 0; j < DEVICES.length; j++) {
        const nameInput = document.getElementById(`n${j}`);
        const ipInput = document.getElementById(`i${j}`);
        
        if (nameInput && ipInput) {
            devicesToSave.push({
                name: nameInput.value.trim(),
                ip: ipInput.value.trim()
            });
        }
    }
    
    if (devicesToSave.length === 0) {
        alert('Kaydedilecek cihaz bulunamadÄ±!');
        return;
    }
    
    fetchWithTimeout("/save_devices", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(devicesToSave)
    })
    .then(response => {
        if (response.ok) {
            feedbackSuccess('saveDevBtn');
            DEVICES = devicesToSave;
        } else {
            alert('Cihazlar kaydedilemedi!');
        }
    })
    .catch(error => {
        alert('Cihazlar kaydedilemedi: ' + error.message);
    });
}

function restartHub() {
    if (confirm("Hub'Ä± yeniden baÅŸlatmak istiyor musunuz?")) {
        fetchWithTimeout("/restart_hub")
            .then(() => {
                alert("Hub yeniden baÅŸlatÄ±lÄ±yor...");
            })
            .catch(() => {
                alert("Yeniden baÅŸlatma komutu gÃ¶nderilemedi!");
            });
    }
}

function resetWifi() {
    if (confirm("WiFi ayarlarÄ±nÄ± sÄ±fÄ±rlamak istiyor musunuz?\n\nCihaz yeniden baÅŸlayacak ve WiFi ayarlama moduna geÃ§ecek.")) {
        fetchWithTimeout("/reset_wifi")
            .then(() => {
                alert("WiFi ayarlarÄ± sÄ±fÄ±rlanÄ±yor...");
            })
            .catch(() => {
                alert("WiFi sÄ±fÄ±rlama komutu gÃ¶nderilemedi!");
            });
    }
}

// ===================== HAVA DURUMU SAYFASI =====================
function renderWeather() {
    fetchStatus().then(() => {
        const c = WEATHER_CONFIG;
        const w = CURRENT_WEATHER;
        
        let statusMessage = "âœ… Sistem Aktif";
        let statusColor = "#03dac6";
        let statusIcon = "âœ…";
        
        if (w.description === "FETCH_ERROR") {
            statusMessage = "âŒ Hava verisi alÄ±namadÄ±";
            statusColor = "#cf6679";
            statusIcon = "âŒ";
        } else if (!w.temp && !w.humidity) {
            statusMessage = "â³ Hava durumu yÃ¼kleniyor...";
            statusColor = "#bb86fc";
            statusIcon = "â³";
        }
        
        let windInfo = "-";
        if (w.wind_speed) {
            windInfo = `${w.wind_speed} m/s`;
            if (w.wind_direction && w.wind_direction !== "-") {
                windInfo += ` ${w.wind_direction}`;
            }
        }
        
        let scoreInfo = "";
        if (w.lightness_score && w.lightness_score > 0) {
            const score = w.lightness_score;
            let scoreText = "";
            let scoreColor = "";
            
            switch(score) {
                case 1:
                    scoreText = "AÃ‡IK HAVA (Bulut â‰¤%25)";
                    scoreColor = "#4CAF50";
                    break;
                case 2:
                    scoreText = "PARÃ‡ALI BULUTLU (%25-95)";
                    scoreColor = "#FF9800";
                    break;
                case 3:
                    scoreText = "KAPALI/GECE (%95+)";
                    scoreColor = "#2196F3";
                    break;
                default:
                    scoreText = `SKOR: ${score}`;
                    scoreColor = "#9C27B0";
            }
            
            scoreInfo = `
            <div style="background:#1a1a1a;padding:15px;border-radius:8px;margin-bottom:20px;border-left:5px solid ${scoreColor}">
                <div style="font-size:1.2em;font-weight:bold;color:${scoreColor};margin-bottom:5px">
                    ğŸ¯ BULUT SKORU: ${score}
                </div>
                <div style="font-size:0.9em;color:#ccc;font-weight:500">
                    ${scoreText}
                </div>
                <div style="font-size:0.8em;color:#888;margin-top:8px">
                    ${c.threshold ? `ğŸ“ EÅŸik DeÄŸer: ${c.threshold}` : ''}
                </div>
            </div>`;
        }
        
        let html = `
        <div class="settings-container">
            <h3>ğŸŒ¤ï¸ Oto Meteoroloji Kontrol</h3>
            
            <div style="background:#222;padding:15px;border-radius:8px;margin-bottom:20px">
                <div style="font-size:1.1em;font-weight:bold;color:#03dac6;margin-bottom:10px">
                    ${w.city_name || c.city || '-'}
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div>ğŸŒ¡ï¸ SÄ±caklÄ±k: <b>${w.temp || '-'}Â°C</b></div>
                    <div>ğŸ’§ Nem: <b>%${w.humidity || '-'}</b></div>
                    <div>â˜ï¸ Bulut: <b>%${w.clouds || '-'}</b></div>
                    <div>ğŸŒ¬ï¸ RÃ¼zgar: <b>${windInfo}</b></div>
                </div>
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid #333">
                    ğŸŒ… GÃ¼n DoÄŸumu: <b>${w.sunrise_time || '-'}</b><br>
                    ğŸŒ‡ GÃ¼n BatÄ±mÄ±: <b>${w.sunset_time || '-'}</b>
                </div>
            </div>
            
            ${scoreInfo}
            
            <div style="background:#1a1a1a;padding:10px;border-radius:5px;margin-bottom:20px;border:2px solid ${statusColor};text-align:center">
                <span style="color:${statusColor};font-weight:bold;font-size:1.1em">
                    ${statusIcon} ${statusMessage}
                </span>
            </div>
            
            <table>
                <tr><td>Aktif:</td><td><input type="checkbox" id="w_active" ${c.active?'checked':''}></td></tr>
                <tr><td>Cihaz:</td><td><select id="w_dev">${DEVICES.map(d=>`<option value="${d.name}" ${c.device_name===d.name?'selected':''}>${d.name}</option>`).join('')}</select></td></tr>
                <tr><td>RÃ¶le:</td><td><select id="w_rel"><option value="1" ${c.relay_id==1?'selected':''}>RÃ¶le 1</option><option value="2" ${c.relay_id==2?'selected':''}>RÃ¶le 2</option></select></td></tr>
                <tr><td>Ä°ÅŸlem:</td><td><select id="w_act"><option value="ON" ${c.action=='ON'?'selected':''}>AÃ‡</option><option value="OFF" ${c.action=='OFF'?'selected':''}>KAPAT</option></select></td></tr>
                <tr><td>EÅŸik:</td><td><select id="w_thr"><option value="1" ${c.threshold==1?'selected':''}>1-Az Bulutlu</option><option value="2" ${c.threshold==2?'selected':''}>2-ParÃ§alÄ±</option><option value="3" ${c.threshold==3?'selected':''}>3-KapalÄ±/Gece</option></select></td></tr>
                <tr><td>Saat:</td><td><div style="display:flex;gap:5px;align-items:center"><input type="time" id="w_start" value="${c.start_time||'17:00'}">-<input type="time" id="w_end" value="${c.end_time||'23:00'}"></div></td></tr>
                <tr><td>RÃ¼zgar EÅŸiÄŸi (m/s):</td><td><input type="number" step="0.1" id="w_wind_threshold" placeholder="15.0" value="${c.wind_threshold||'15.0'}"></td></tr>
                <tr><td>Åehir:</td><td><input type="text" id="w_city" placeholder="Ä°stanbul" value="${c.city||''}"></td></tr>
                <tr><td>Ä°lÃ§e:</td><td><input type="text" id="w_district" placeholder="KadÄ±kÃ¶y" value="${c.district||''}"></td></tr>
                <tr><td>Mahalle:</td><td><input type="text" id="w_neigh" placeholder="Opsiyonel" value="${c.neighbourhood||''}"></td></tr>
            </table>
            
            <br>
            
            <div style="display:flex;flex-direction:column;gap:10px">
                <button class="btn on" id="saveWeatherBtn" onclick="saveWeather()">ğŸ’¾ AyarlarÄ± Kaydet</button>
                <button class="btn" id="refreshWeatherBtn" onclick="refreshWeather()" style="background:#2196F3">ğŸ”„ Hava Durumunu GÃ¼ncelle</button>
            </div>
        </div>`;
        
        document.getElementById("content").innerHTML = html;
    }).catch(err => {
        document.getElementById("content").innerHTML = `
            <div style="text-align:center;padding:40px;color:#cf6679">
                <h3>âŒ Hava durumu yÃ¼klenemedi</h3>
                <p>${err.message}</p>
                <button class="btn" onclick="renderWeather()" style="margin-top:20px;background:#03dac6">
                    Tekrar Dene
                </button>
            </div>
        `;
    });
}

function saveWeather() {
    const cfg = {
        active: document.getElementById('w_active').checked,
        device_name: document.getElementById('w_dev').value,
        relay_id: parseInt(document.getElementById('w_rel').value),
        threshold: parseInt(document.getElementById('w_thr').value),
        action: document.getElementById('w_act').value,
        start_time: document.getElementById('w_start').value,
        end_time: document.getElementById('w_end').value,
        wind_threshold: parseFloat(document.getElementById('w_wind_threshold').value) || 15.0,
        city: (document.getElementById('w_city')?.value || '').trim(),
        district: (document.getElementById('w_district')?.value || '').trim(),
        neighbourhood: (document.getElementById('w_neigh')?.value || '').trim(),
        latitude: "",
        longitude: ""
    };
    
    const saveBtn = document.getElementById('saveWeatherBtn');
    if (!saveBtn) return;
    
    const originalText = saveBtn.textContent;
    
    saveBtn.disabled = true;
    saveBtn.textContent = "â³ Kaydediliyor...";
    
    fetchWithTimeout("/save_weather_config", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(cfg)
    })
    .then(r => {
        if (r.ok) {
            saveBtn.textContent = "âœ… Kaydedildi";
            saveBtn.style.background = "#4CAF50";
            setTimeout(() => {
                if (saveBtn) {
                    saveBtn.textContent = originalText;
                    saveBtn.style.background = "";
                    saveBtn.disabled = false;
                }
                location.reload();
            }, 2000);
        } else {
            saveBtn.textContent = "âŒ Hata";
            saveBtn.style.background = "#cf6679";
            setTimeout(() => {
                if (saveBtn) {
                    saveBtn.textContent = originalText;
                    saveBtn.style.background = "";
                    saveBtn.disabled = false;
                }
            }, 3000);
        }
    })
    .catch(() => {
        saveBtn.textContent = "âŒ BaÄŸlantÄ± HatasÄ±";
        saveBtn.style.background = "#cf6679";
        setTimeout(() => {
            if (saveBtn) {
                saveBtn.textContent = originalText;
                saveBtn.style.background = "";
                saveBtn.disabled = false;
            }
        }, 3000);
    });
}

function refreshWeather() {
    const refreshBtn = document.getElementById('refreshWeatherBtn');
    if (!refreshBtn) return;
    
    const originalText = refreshBtn.textContent;
    
    refreshBtn.disabled = true;
    refreshBtn.textContent = "â³ GÃ¼ncelleniyor...";
    
    fetchWithTimeout("/save_weather_config", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({refresh: true})
    })
    .then(r => {
        if (r.ok) {
            refreshBtn.textContent = "âœ… GÃ¼ncellendi";
            refreshBtn.style.background = "#4CAF50";
            setTimeout(() => {
                if (refreshBtn) {
                    refreshBtn.textContent = originalText;
                    refreshBtn.style.background = "";
                    refreshBtn.disabled = false;
                }
                location.reload();
            }, 2000);
        } else {
            refreshBtn.textContent = "âŒ Hata";
            refreshBtn.style.background = "#cf6679";
            setTimeout(() => {
                if (refreshBtn) {
                    refreshBtn.textContent = originalText;
                    refreshBtn.style.background = "";
                    refreshBtn.disabled = false;
                }
            }, 3000);
        }
    })
    .catch(() => {
        refreshBtn.textContent = "âŒ BaÄŸlantÄ± HatasÄ±";
        refreshBtn.style.background = "#cf6679";
        setTimeout(() => {
            if (refreshBtn) {
                refreshBtn.textContent = originalText;
                refreshBtn.style.background = "";
                refreshBtn.disabled = false;
            }
        }, 3000);
    });
}

// ===================== NAVÄ°GASYON =====================
async function navigate() {
    const path = window.location.pathname;
    
    showLoading();
    
    // Aktif menÃ¼yÃ¼ gÃ¼ncelle
    document.querySelectorAll('.nav a').forEach(a => {
        a.classList.remove('active');
    });
    
    const navMap = {
        '/': 'nav1',
        '/settings': 'nav2',
        '/weather': 'nav3',
        '/mqtt': 'nav4'
    };
    
    const activeNav = navMap[path] || 'nav1';
    document.getElementById(activeNav)?.classList.add('active');
    
    try {
        // CihazlarÄ± yÃ¼kle
        await fetchDevices();
        
        // Ä°lgili sayfayÄ± render et
        switch (path) {
            case '/settings':
                renderSettings();
                break;
            case '/weather':
                renderWeather();
                break;
            case '/mqtt':
                renderMqttControl();
                break;
            default:
                renderControl();
                // Ana sayfa iÃ§in periyodik gÃ¼ncellemeyi baÅŸlat
                if (window.statusUpdateInterval) {
                    clearInterval(window.statusUpdateInterval);
                }
                window.statusUpdateInterval = setInterval(updateDeviceStatus, 3000);
                break;
        }
        
        APP_STATUS.loading = false;
    } catch (error) {
        handleError(error, "Sayfa yÃ¼klenirken");
    }
}

// ===================== SAYFA BAÅLANGICI =====================
document.addEventListener('DOMContentLoaded', function() {
    // ESP32 konfigÃ¼rasyonunu baÅŸlat
    initESP32Config();
    
    // Ä°lk navigasyon
    navigate();
    
    // Global hata yakalama
    window.addEventListener('error', function(event) {
        console.error('Global hata:', event.error);
    });
    
    window.addEventListener('unhandledrejection', function(event) {
        console.error('Promise hatasÄ±:', event.reason);
    });
});
</script>
</body>
</html>
