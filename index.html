<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Merkezi Hub v5.5.2 (GITHUB)</title>
<meta http-equiv="Cache-Control" content="max-age=31536000, must-revalidate"> 

<style>
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
.btn.pulsing { animation: pulse 1s infinite; }
.btn.success { background: #4CAF50 !important; color: white !important; }
.btn.error { background: #cf6679 !important; color: white !important; }
.btn.warning { background: #ff9800 !important; color: black !important; }

/* MQTT Kontrol i√ßin yeni stil */
.mqtt-control {
    background: #1a1a1a;
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
    border: 1px solid #333;
}
.mqtt-status {
    font-size: 0.85em;
    padding: 5px 10px;
    border-radius: 4px;
    margin: 5px 0;
    display: inline-block;
}
.mqtt-connected { background: #2E7D32; color: white; }
.mqtt-disconnected { background: #C62828; color: white; }
.mqtt-topic { font-family: monospace; background: #111; padding: 2px 6px; border-radius: 3px; }

body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #eee; margin: 0; padding-bottom: 20px; }
.header { background: #222; color: #03dac6; padding: 12px; text-align: center; font-size: 1.1em; font-weight: bold; border-bottom: 2px solid #333; display: flex; justify-content: space-between; align-items: center; }
.header span { font-size: 0.8em; color: #888; }
.nav { background: #1a1a1a; padding: 8px; display: flex; justify-content: center; gap: 15px; border-bottom: 1px solid #333; }
.nav a { color: #888; text-decoration: none; font-size: 0.9em; padding: 5px 10px; border-radius: 4px; transition: 0.3s; }
.nav a.active { background: #3700b3; color: #fff; }

.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; padding: 10px; max-width: 800px; margin: 0 auto; }
.card { background: #1e1e1e; border: 1px solid #333; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column; transition: transform 0.2s; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; }
.dev-name { font-weight: bold; font-size: 0.95em; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
.status-dot { width: 10px; height: 10px; border-radius: 50%; background: #555; display: inline-block; margin-right: 5px; }
.online-dot { background: #03dac6; box-shadow: 0 0 5px #03dac6; }
.offline-dot { background: #cf6679; }
.timer-icon-btn { background: transparent; border: none; color: #bb86fc; cursor: pointer; font-size: 1.2em; padding: 0 5px; }

.relay-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; background: #252525; padding: 5px; border-radius: 6px; }
.relay-label { font-size: 0.8em; color: #aaa; font-weight: bold; width: 25px; }
.btn { flex-grow: 1; padding: 8px 5px; border: none; border-radius: 6px; font-weight: bold; font-size: 0.85em; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
.on { background: #03dac6; color: #000; }
.off { background: #333; color: #ccc; border: 1px solid #444; }
.off:hover { background: #444; }
.sched-info { font-size: 0.65em; color: #bb86fc; text-align: center; margin-top: -3px; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.section { margin-top: 5px; background: #2a2a2a; padding: 8px; border-radius: 8px; display: none; border: 1px solid #444; font-size: 0.85em; }
.days { display: flex; justify-content: space-between; gap: 2px; margin: 10px 0; }
.days label { width: 25px; height: 25px; line-height: 25px; background: #444; color: #eee; border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.75em; font-weight: bold; }
.days input[type="checkbox"]:checked + label { background: #bb86fc; color: #000; }
.days input[type="checkbox"] { display: none; }

input[type="time"], input[type="text"], input[type="number"], select { 
    background: #111; border: 1px solid #444; color: #fff; padding: 5px; border-radius: 4px; width: 100%; box-sizing: border-box; 
}
.action-btns { display: flex; gap: 5px; margin-top: 10px; }

.settings-container { max-width: 600px; margin: 10px auto; padding: 15px; background: #1f1f1f; border-radius: 8px; }
table { width: 100%; border-collapse: collapse; }
td { padding: 8px; border-bottom: 1px solid #333; }

.github-info { 
    background: #1a1a1a; 
    padding: 5px 10px; 
    border-radius: 4px; 
    font-size: 0.8em; 
    color: #888; 
    text-align: center;
    margin-top: 10px;
    border: 1px solid #333;
}
.github-info.active { border-color: #4CAF50; color: #4CAF50; }
.github-info.inactive { border-color: #cf6679; color: #cf6679; }

/* MQTT Kontrol Paneli */
.mqtt-panel {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 15px;
    margin: 15px auto;
    max-width: 800px;
    border: 1px solid #333;
}
.mqtt-panel h3 {
    color: #03dac6;
    margin-top: 0;
    border-bottom: 1px solid #333;
    padding-bottom: 8px;
}
.mqtt-topics {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 15px;
}
.mqtt-topic-item {
    background: #252525;
    padding: 10px;
    border-radius: 5px;
    border-left: 4px solid #bb86fc;
}
.mqtt-topic-item h4 {
    margin: 0 0 8px 0;
    color: #bb86fc;
    font-size: 0.9em;
}
.mqtt-topic-value {
    font-family: monospace;
    background: #111;
    padding: 5px;
    border-radius: 3px;
    font-size: 0.85em;
    word-break: break-all;
}

</style>
</head>
<body>

<div class="header">
    <div>MERKEZƒ∞ HUB v5.5.2 (Gƒ∞THUB)</div>
    <span id="clock">00:00</span>
</div>

<div class="nav">
  <a href="/" id="nav1" onclick="route('/');return false;">Panel</a>
  <a href="/settings" id="nav2" onclick="route('/settings');return false;">Cihazlar</a>
  <a href="/weather" id="nav3" onclick="route('/weather');return false;">Oto-Hava</a>
  <a href="/mqtt" id="nav4" onclick="route('/mqtt');return false;">MQTT</a>
</div>

<div id="content">Y√ºkleniyor...</div>

<div id="githubStatus" class="github-info active">GitHub: AKTƒ∞F MOD | MQTT Kontrol Hazƒ±r</div>

<script>
let DEVICES = [], STATUS = {}, CURRENT_WEATHER = {}, WEATHER_CONFIG = {};
let MQTT_STATUS = { connected: false, topics: {}, clientId: '' };
let lastToggleTime = 0;
const daysName = ["Pt","Sa","√áa","Pe","Cu","Ct","Pz"];

// MQTT Topic'ler
const MQTT_TOPICS = {
    RELAY1_SET: 'nejat/relay/1/set',
    RELAY1_STATE: 'nejat/relay/1/state',
    RELAY2_SET: 'nejat/relay/2/set',
    RELAY2_STATE: 'nejat/relay/2/state',
    HUB_ONLINE: 'nejat/hub/online',
    HUB_STATUS: 'nejat/hub/status',
    HUB_GITHUB: 'nejat/hub/github',
    HUB_MODE: 'nejat/hub/mode',
    HUB_IP: 'nejat/hub/ip'
};

// Saat G√∂stergesi
setInterval(() => {
    const d = new Date();
    document.getElementById('clock').innerText = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}, 1000);

// Navigasyon
function route(path) { 
    history.pushState(null, '', path); 
    navigate(); 
}

// API Fonksiyonlarƒ±
function fetchDevices() { 
    return fetch("/get_devices").then(r=>r.json()).then(d=>DEVICES=d); 
}

function fetchStatus() { 
    return fetch("/fetch_status").then(r=>r.json()).then(d=>{ 
        STATUS = d.devices || {}; 
        CURRENT_WEATHER = d.weather || {}; 
        WEATHER_CONFIG = d.weather_config || {}; 
        
        // GitHub durumunu g√ºncelle
        const githubStatus = document.getElementById('githubStatus');
        if (githubStatus && d.github_mode) {
            githubStatus.textContent = `GitHub: ${d.github_mode.toUpperCase()} MOD | MQTT: ${d.mqtt_connected ? 'Baƒülƒ±' : 'Baƒülƒ± Deƒüil'}`;
            githubStatus.className = d.github_mode === 'github' ? 'github-info active' : 'github-info inactive';
            if (d.github_size) {
                githubStatus.textContent += ` (${Math.round(d.github_size/1024)}KB)`;
            }
        }
        
        // MQTT durumunu g√ºncelle
        MQTT_STATUS.connected = d.mqtt_connected || false;
        
        return d; 
    }); 
}

// MQTT Kontrol Fonksiyonlarƒ±
function mqttPublish(topic, message) {
    // MQTT mesajƒ± g√∂ndermek i√ßin proxy kullan
    fetch(`/proxy?ip=${encodeURIComponent('localhost')}&url=/mqtt_publish?topic=${encodeURIComponent(topic)}&message=${encodeURIComponent(message)}`)
        .then(r => r.text())
        .then(response => {
            console.log(`MQTT Published: ${topic} -> ${message}`);
            updateMqttStatus(topic, message);
        })
        .catch(err => console.error('MQTT Publish Error:', err));
}

function updateMqttStatus(topic, message) {
    if (MQTT_STATUS.topics[topic]) {
        MQTT_STATUS.topics[topic].lastValue = message;
        MQTT_STATUS.topics[topic].lastUpdate = new Date().toLocaleTimeString();
    }
    
    // UI'ƒ± g√ºncelle
    if (location.pathname === '/mqtt') {
        renderMqttControl();
    }
}

// GitHub Kontrol√º
function githubControl(action) {
    fetch(`/github_control?action=${action}`)
        .then(r => r.text())
        .then(response => {
            alert(response);
            if (action === 'update' || action === 'enable' || action === 'disable') {
                setTimeout(() => location.reload(), 1000);
            }
        });
}

// Geri bildirim
function feedbackSuccess(btnId) {
    const btn = document.getElementById(btnId); 
    if(!btn) return;
    const t = btn.textContent; 
    const c = btn.className;
    btn.textContent = '‚úì OK'; 
    btn.className = 'btn success';
    setTimeout(() => { 
        btn.textContent = t; 
        btn.className = c; 
    }, 2000);
}

// --- ANA PANEL RENDER ---
function renderControl() {
    let html = `<div class="grid">`;
    
    if(!DEVICES.length) {
        html += `<div style="text-align:center;width:100%;padding:20px;color:#cf6679">
                    <h4>‚ùå Cihaz Yok</h4>
                    <p>Ayarlar > Cihazlar sekmesinden cihaz ekleyin.</p>
                    <button class="btn" onclick="route('/settings')" style="margin-top:10px">Cihaz Ekle</button>
                 </div>`;
    }
    
    DEVICES.forEach((dev, i) => {
        html += `
        <div class="card">
            <div class="card-header">
                <div style="display:flex;align-items:center">
                    <span class="status-dot" id="dot_${i}"></span>
                    <span class="dev-name" title="${dev.ip}">${dev.name}</span>
                </div>
                <button class="timer-icon-btn" onclick="openSect(${i})" title="Zamanlayƒ±cƒ± Ayarlarƒ±">üïí</button>
            </div>

            <div class="relay-row">
                <div class="relay-label">R1</div>
                <button class="btn off" id="b1_${i}" onclick="toggle(${i},1)">...</button>
                <button class="btn" onclick="mqttControl('${dev.name}', 1, 'toggle')" style="background:#bb86fc;margin-left:5px;padding:5px 8px" title="MQTT Kontrol">üì°</button>
            </div>
            <div class="sched-info" id="p1_${i}"></div>

            <div class="relay-row">
                <div class="relay-label">R2</div>
                <button class="btn off" id="b2_${i}" onclick="toggle(${i},2)">...</button>
                <button class="btn" onclick="mqttControl('${dev.name}', 2, 'toggle')" style="background:#bb86fc;margin-left:5px;padding:5px 8px" title="MQTT Kontrol">üì°</button>
            </div>
            <div class="sched-info" id="p2_${i}"></div>

            <div class="section" id="sec_${i}">
                <div style="display:flex;gap:10px;justify-content:center;margin-bottom:10px;">
                    <label><input type="radio" name="r${i}" value="1" checked onchange="loadProgValues(${i})"> R√∂le 1</label>
                    <label><input type="radio" name="r${i}" value="2" onchange="loadProgValues(${i})"> R√∂le 2</label>
                </div>
                
                <div style="display:flex;gap:5px;align-items:center">
                    <input type="time" id="t1_${i}" value="08:00"> 
                    <span>-</span> 
                    <input type="time" id="t2_${i}" value="18:00">
                </div>

                <div class="days">
                    ${daysName.map((d,j)=>`<input type="checkbox" id="d${i}_${j}"><label for="d${i}_${j}">${d}</label>`).join("")}
                </div>
                
                <div class="action-btns">
                    <button class="btn on" id="saveProgBtn_${i}" onclick="saveProg(${i})">KAYDET</button>
                    <button class="btn off" onclick="clearProg(${i})">Sƒ∞L</button>
                </div>
            </div>
        </div>`;
    });
    
    html += `</div>`;
    
    // GitHub ve MQTT kontrol butonlarƒ±
    html += `
    <div style="text-align:center;margin-top:20px;">
        <div class="mqtt-control">
            <h4 style="margin:0 0 10px 0;color:#03dac6">üì° MQTT Hƒ±zlƒ± Kontrol</h4>
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
                <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY1_SET}', 'ON')" style="background:#4CAF50">R√∂le1 A√á</button>
                <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY1_SET}', 'OFF')" style="background:#cf6679">R√∂le1 KAPAT</button>
                <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY2_SET}', 'ON')" style="background:#4CAF50">R√∂le2 A√á</button>
                <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY2_SET}', 'OFF')" style="background:#cf6679">R√∂le2 KAPAT</button>
                <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.HUB_STATUS}', 'Manuel_Kontrol_' + Date.now())" style="background:#2196F3">Durum G√ºncelle</button>
            </div>
        </div>
        
        <div style="margin-top:15px">
            <button class="btn" onclick="githubControl('update')" style="background:#333;margin:5px">üîÑ GitHub G√ºncelle</button>
            <button class="btn" onclick="githubControl('enable')" style="background:#4CAF50;margin:5px">‚úÖ GitHub Aktif</button>
            <button class="btn" onclick="githubControl('disable')" style="background:#cf6679;margin:5px">‚ùå GitHub Pasif</button>
            <button class="btn" onclick="githubControl('status')" style="background:#2196F3;margin:5px">‚ÑπÔ∏è GitHub Durumu</button>
        </div>
    </div>`;
    
    document.getElementById("content").innerHTML = html;
}

// MQTT Kontrol Fonksiyonu
function mqttControl(deviceName, relay, action) {
    const topic = relay === 1 ? MQTT_TOPICS.RELAY1_SET : MQTT_TOPICS.RELAY2_SET;
    let message = 'TOGGLE';
    
    if (action === 'on') message = 'ON';
    else if (action === 'off') message = 'OFF';
    else {
        // Toggle i≈ülemi: mevcut duruma g√∂re tersini g√∂nder
        const btn = document.getElementById(`b${relay}_${DEVICES.findIndex(d => d.name === deviceName)}`);
        if (btn && btn.textContent.includes('A√áIK')) {
            message = 'OFF';
        } else {
            message = 'ON';
        }
    }
    
    mqttPublish(topic, message);
    
    // UI feedback
    alert(`MQTT Komutu G√∂nderildi: ${topic} = ${message}`);
}

// Durum G√ºncelleme
function update() {
    if(location.pathname !== "/") return;
    
    fetchStatus().then(() => {
        DEVICES.forEach((dev, i) => {
            const s = STATUS[dev.name] || {r1_state:"OFFLINE", r2_state:"OFFLINE"};
            
            // Online/Offline Durumu
            const online = s.r1_state !== "OFFLINE";
            const dot = document.getElementById("dot_"+i);
            if(dot) {
                dot.className = "status-dot " + (online ? "online-dot" : "offline-dot");
            }

            // R√∂le Durumlarƒ±
            for(let r = 1; r <= 2; r++) {
                const state = s[`r${r}_state`] || "OFFLINE";
                const btn = document.getElementById("b"+r+"_"+i);
                const prog = document.getElementById("p"+r+"_"+i);

                if(state === "OFFLINE") {
                    if(btn) { 
                        btn.textContent = "‚ùå HATA"; 
                        btn.className = "btn error"; 
                        btn.disabled = true; 
                    }
                } else {
                    if(btn) {
                        btn.textContent = state === "ON" ? "‚úÖ A√áIK" : "‚≠ï KAPALI";
                        btn.className = "btn " + (state === "ON" ? "on" : "off");
                        btn.disabled = false;
                    }
                    // Zamanlayƒ±cƒ± Bilgisi
                    const active = s[`sched_active_r${r}`] === "true";
                    const start = s[`sched_start_r${r}`];
                    if(prog) {
                        prog.innerText = active ? `üïí ${start} - ${s[`sched_end_r${r}`]}` : "";
                    }
                }
            }
        });
    });
}

// Zamanlayƒ±cƒ± B√∂l√ºm√º A√ß/Kapa
function openSect(i) { 
    const sec = document.getElementById("sec_"+i);
    const isVis = sec.style.display === "block";
    
    // Diƒüer b√∂l√ºmleri kapat
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
    
    // ƒ∞steneni a√ß/kapa
    if(!isVis) { 
        sec.style.display = "block"; 
        loadProgValues(i); 
    }
}

// Se√ßili R√∂le
function getRelay(i) { 
    return document.querySelector(`input[name="r${i}"]:checked`).value; 
}

// G√ºn Maskesi
function getMask(i) { 
    let m = 0; 
    for(let j = 0; j < 7; j++) {
        if(document.getElementById("d"+i+"_"+j).checked) {
            m |= 1 << j;
        }
    }
    return m; 
}

// R√∂le Toggle
function toggle(i, r) {
    const dev = DEVICES[i]; 
    const btn = document.getElementById("b"+r+"_"+i);
    const originalText = btn.textContent;
    const originalClass = btn.className;
    
    // Optimistik UI
    btn.textContent = "‚è≥";
    btn.disabled = true;
    
    // Manuel kontrol sinyali
    fetch("/manual_control");
    
    // R√∂le durumunu belirle
    const action = originalText.includes("A√áIK") ? "off" : "on";
    
    fetch(`/proxy?ip=${encodeURIComponent(dev.ip)}&url=${encodeURIComponent("/control?id="+r+"&action="+action)}`)
        .then(response => {
            if (response.ok) {
                btn.textContent = action === "on" ? "‚úÖ A√áIK" : "‚≠ï KAPALI";
                btn.className = action === "on" ? "btn on" : "btn off";
                setTimeout(update, 500);
            } else {
                throw new Error("HTTP hatasƒ±");
            }
        })
        .catch(error => {
            btn.textContent = originalText;
            btn.className = originalClass;
            btn.disabled = false;
            alert(`Hata: ${dev.name} ile ileti≈üim kurulamadƒ±.`);
        });
}

// Zamanlayƒ±cƒ± Kaydet
function saveProg(i) {
    const dev = DEVICES[i];
    const r = getRelay(i);
    const start = document.getElementById("t1_"+i).value;
    const end = document.getElementById("t2_"+i).value;
    const [sh, sm] = start.split(":");
    const [eh, em] = end.split(":");
    const mask = getMask(i);
    
    if(!mask) {
        alert("L√ºtfen en az bir g√ºn se√ßin!");
        return;
    }

    // Local Storage'a kaydet
    localStorage.setItem(`p_${dev.name}_r${r}_s`, start);
    localStorage.setItem(`p_${dev.name}_r${r}_e`, end);
    localStorage.setItem(`p_${dev.name}_r${r}_m`, mask);

    const url = `/save?relay_id=${r}&start_h=${sh}&start_m=${sm}&end_h=${eh}&end_m=${em}&days=${mask}&active=1`;
    fetch(`/proxy?ip=${encodeURIComponent(dev.ip)}&url=${encodeURIComponent(url)}`)
        .then(response => {
            if(response.ok) {
                feedbackSuccess('saveProgBtn_'+i);
                setTimeout(update, 1000);
            } else {
                alert("Zamanlayƒ±cƒ± kaydedilemedi!");
            }
        })
        .catch(() => alert("ƒ∞leti≈üim hatasƒ±!"));
}

// Zamanlayƒ±cƒ± Temizle
function clearProg(i) {
    const dev = DEVICES[i];
    const r = getRelay(i);
    
    if(!confirm(`"${dev.name}" cihazƒ±nƒ±n R${r} r√∂lesi i√ßin zamanlayƒ±cƒ±yƒ± iptal etmek istiyor musunuz?`)) {
        return;
    }

    // Local Storage'dan sil
    localStorage.removeItem(`p_${dev.name}_r${r}_s`);
    localStorage.removeItem(`p_${dev.name}_r${r}_e`);
    localStorage.removeItem(`p_${dev.name}_r${r}_m`);
    
    fetch(`/proxy?ip=${encodeURIComponent(dev.ip)}&url=${encodeURIComponent(`/save?relay_id=${r}&days=0&active=0`)}`)
        .then(() => {
            alert("Zamanlayƒ±cƒ± iptal edildi!");
            setTimeout(update, 800);
        })
        .catch(() => alert("ƒ∞leti≈üim hatasƒ±!"));
}

// Zamanlayƒ±cƒ± Deƒüerlerini Y√ºkle
function loadProgValues(i) {
    const dev = DEVICES[i];
    const r = getRelay(i);
    const s = localStorage.getItem(`p_${dev.name}_r${r}_s`);
    const e = localStorage.getItem(`p_${dev.name}_r${r}_e`);
    const m = localStorage.getItem(`p_${dev.name}_r${r}_m`);

    document.getElementById(`t1_${i}`).value = s || "08:00";
    document.getElementById(`t2_${i}`).value = e || "18:00";
    
    const mask = m ? parseInt(m) : 127; // Varsayƒ±lan: t√ºm g√ºnler
    for(let j = 0; j < 7; j++) {
        document.getElementById(`d${i}_${j}`).checked = (mask & (1 << j)) !== 0;
    }
}

// --- MQTT KONTROL SAYFASI ---
function renderMqttControl() {
    let html = `
    <div class="mqtt-panel">
        <h3>üì° MQTT Uzaktan Kontrol Paneli</h3>
        
        <div class="mqtt-status ${MQTT_STATUS.connected ? 'mqtt-connected' : 'mqtt-disconnected'}">
            ${MQTT_STATUS.connected ? '‚úÖ MQTT Baƒülantƒ±sƒ±: AKTƒ∞F' : '‚ùå MQTT Baƒülantƒ±sƒ±: KAPALI'}
        </div>
        
        <div style="margin:15px 0">
            <h4>MQTT Topic Listesi:</h4>
            <div class="mqtt-topics">
                <div class="mqtt-topic-item">
                    <h4>${MQTT_TOPICS.RELAY1_SET}</h4>
                    <p>R√∂le 1 Kontrol√º</p>
                    <div class="action-btns">
                        <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY1_SET}', 'ON')" style="background:#4CAF50">A√á</button>
                        <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY1_SET}', 'OFF')" style="background:#cf6679">KAPAT</button>
                    </div>
                </div>
                
                <div class="mqtt-topic-item">
                    <h4>${MQTT_TOPICS.RELAY2_SET}</h4>
                    <p>R√∂le 2 Kontrol√º</p>
                    <div class="action-btns">
                        <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY2_SET}', 'ON')" style="background:#4CAF50">A√á</button>
                        <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.RELAY2_SET}', 'OFF')" style="background:#cf6679">KAPAT</button>
                    </div>
                </div>
                
                <div class="mqtt-topic-item">
                    <h4>${MQTT_TOPICS.RELAY1_STATE}</h4>
                    <p>R√∂le 1 Durumu</p>
                    <div class="mqtt-topic-value" id="mqtt_relay1_state">Bekleniyor...</div>
                </div>
                
                <div class="mqtt-topic-item">
                    <h4>${MQTT_TOPICS.RELAY2_STATE}</h4>
                    <p>R√∂le 2 Durumu</p>
                    <div class="mqtt-topic-value" id="mqtt_relay2_state">Bekleniyor...</div>
                </div>
                
                <div class="mqtt-topic-item">
                    <h4>${MQTT_TOPICS.HUB_ONLINE}</h4>
                    <p>Hub √áevrimi√ßi Durumu</p>
                    <div class="mqtt-topic-value" id="mqtt_hub_online">1</div>
                </div>
                
                <div class="mqtt-topic-item">
                    <h4>${MQTT_TOPICS.HUB_IP}</h4>
                    <p>Hub IP Adresi</p>
                    <div class="mqtt-topic-value" id="mqtt_hub_ip">Y√ºkleniyor...</div>
                </div>
                
                <div class="mqtt-topic-item">
                    <h4>${MQTT_TOPICS.HUB_STATUS}</h4>
                    <p>Hub Durum Mesajƒ±</p>
                    <div class="action-btns">
                        <button class="btn" onclick="sendHubStatus()" style="background:#2196F3">Mesaj G√∂nder</button>
                    </div>
                </div>
                
                <div class="mqtt-topic-item">
                    <h4>${MQTT_TOPICS.HUB_GITHUB}</h4>
                    <p>GitHub Durumu</p>
                    <div class="mqtt-topic-value" id="mqtt_hub_github">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>
        
        <div style="margin-top:20px">
            <h4>√ñzel MQTT Komutu:</h4>
            <div style="display:flex;gap:10px;align-items:center">
                <input type="text" id="customTopic" placeholder="nejat/relay/1/set" style="flex:1" value="${MQTT_TOPICS.RELAY1_SET}">
                <input type="text" id="customMessage" placeholder="ON veya OFF" style="flex:1">
                <button class="btn on" onclick="sendCustomMqtt()">G√∂nder</button>
            </div>
        </div>
        
        <div style="margin-top:20px;background:#111;padding:10px;border-radius:5px;">
            <h4>MQTT Test Komutlarƒ±:</h4>
            <div style="display:flex;gap:5px;flex-wrap:wrap">
                <button class="btn" onclick="testMqttSequence()" style="background:#FF9800">Test Dizisi √áalƒ±≈ütƒ±r</button>
                <button class="btn" onclick="mqttPublish('${MQTT_TOPICS.HUB_STATUS}', 'Test_' + Date.now())" style="background:#9C27B0">Test Mesajƒ±</button>
                <button class="btn" onclick="getCurrentMqttStatus()" style="background:#00BCD4">Durumlarƒ± Oku</button>
            </div>
        </div>
    </div>`;
    
    document.getElementById("content").innerHTML = html;
    
    // MQTT durumlarƒ±nƒ± g√ºncelle
    getCurrentMqttStatus();
}

function sendCustomMqtt() {
    const topic = document.getElementById('customTopic').value;
    const message = document.getElementById('customMessage').value;
    
    if (!topic || !message) {
        alert('L√ºtfen topic ve mesaj girin!');
        return;
    }
    
    mqttPublish(topic, message);
    document.getElementById('customMessage').value = '';
}

function sendHubStatus() {
    const message = `Hub_Status_${new Date().toLocaleTimeString()}`;
    mqttPublish(MQTT_TOPICS.HUB_STATUS, message);
}

function testMqttSequence() {
    alert('MQTT Test Dizisi ba≈ülatƒ±lƒ±yor...');
    
    // Test dizisi
    setTimeout(() => mqttPublish(MQTT_TOPICS.RELAY1_SET, 'ON'), 500);
    setTimeout(() => mqttPublish(MQTT_TOPICS.RELAY2_SET, 'ON'), 1000);
    setTimeout(() => mqttPublish(MQTT_TOPICS.HUB_STATUS, 'Test_Sequence_Complete'), 1500);
    setTimeout(() => mqttPublish(MQTT_TOPICS.RELAY1_SET, 'OFF'), 2000);
    setTimeout(() => mqttPublish(MQTT_TOPICS.RELAY2_SET, 'OFF'), 2500);
    
    alert('Test dizisi 3 saniye i√ßinde tamamlanacak.');
}

function getCurrentMqttStatus() {
    // MQTT durumlarƒ±nƒ± g√ºncellemek i√ßin fetch
    fetchStatus().then(data => {
        // MQTT durumunu g√ºncelle
        document.getElementById('mqtt_hub_ip').textContent = data.ip_address || 'Bilinmiyor';
        document.getElementById('mqtt_hub_github').textContent = data.github_mode ? `${data.github_mode.toUpperCase()} (${data.github_size} bayt)` : 'Bilinmiyor';
    });
}

// --- AYARLAR SAYFASI ---
function renderSettings() {
    let html = `
    <div class="settings-container">
        <h3>üì± Cihaz Y√∂netimi</h3>
        <table id="devicesTable">
            <tr style="background:#2a2a2a">
                <th>Cihaz Adƒ±</th>
                <th>IP Adresi</th>
                <th>ƒ∞≈ülem</th>
            </tr>`;
    
    DEVICES.forEach((d, i) => {
        html += `
            <tr>
                <td><input type="text" id="n${i}" value="${d.name}" style="width:100%"></td>
                <td><input type="text" id="i${i}" value="${d.ip}" style="width:100%"></td>
                <td><button class="btn error" onclick="del(${i})" title="Sil">üóëÔ∏è</button></td>
            </tr>`;
    });
    
    html += `</table>
        <br>
        <div style="display:flex;gap:10px;justify-content:center">
            <button class="btn" onclick="add()" style="background:#4CAF50">‚ûï Yeni Cihaz</button>
            <button class="btn on" id="saveDevBtn" onclick="saveDevices()">üíæ Kaydet</button>
        </div>
        
        <hr style="border-top:1px solid #333;margin:20px 0">
        
        <h3>‚öôÔ∏è Sistem ƒ∞≈ülemleri</h3>
        <div style="display:flex;flex-direction:column;gap:10px">
            <button class="btn warning" onclick="restartHub()">üîÑ Hub'ƒ± Yeniden Ba≈ülat</button>
            <button class="btn error" onclick="resetWifi()">üì° WiFi Ayarlarƒ±nƒ± Sƒ±fƒ±rla</button>
            <button class="btn" onclick="handleTestTelegram()" style="background:#0088cc">‚úâÔ∏è Telegram Test</button>
            <button class="btn" onclick="route('/mqtt')" style="background:#9C27B0">üì° MQTT Kontrol Paneli</button>
        </div>
    </div>`;
    
    document.getElementById("content").innerHTML = html;
}

function add() { 
    DEVICES.push({name: `Cihaz_${DEVICES.length+1}`, ip: "192.168.1."}); 
    renderSettings(); 
}

function del(idx) { 
    if(confirm(`"${DEVICES[idx].name}" cihazƒ±nƒ± silmek istiyor musunuz?`)) { 
        DEVICES.splice(idx, 1); 
        renderSettings(); 
    }
}

function saveDevices() {
    const arr = [];
    for(let j = 0; j < DEVICES.length; j++) {
        arr.push({
            name: document.getElementById("n"+j).value.trim(),
            ip: document.getElementById("i"+j).value.trim()
        });
    }
    
    fetch("/save_devices", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(arr)
    }).then(r => feedbackSuccess('saveDevBtn'));
}

function restartHub() { 
    if(confirm("Hub'ƒ± yeniden ba≈ülatmak istiyor musunuz?")) {
        fetch("/restart_hub");
        setTimeout(() => alert("Yeniden ba≈ülatƒ±lƒ±yor..."), 500);
    }
}

function resetWifi() { 
    if(confirm("WiFi ayarlarƒ±nƒ± sƒ±fƒ±rlamak istiyor musunuz? Cihaz yeniden ba≈ülayacak ve WiFi ayarlama moduna ge√ßecek.")) {
        fetch("/reset_wifi");
        setTimeout(() => alert("WiFi sƒ±fƒ±rlanƒ±yor..."), 500);
    }
}

function handleTestTelegram() {
    fetch("/test_telegram")
        .then(() => alert("Test mesajƒ± g√∂nderildi! Telegram'ƒ± kontrol edin."))
        .catch(() => alert("Test mesajƒ± g√∂nderilemedi!"));
}

// --- HAVA DURUMU SAYFASI (aynƒ± kaldƒ±) ---
function renderWeather() {
    fetchStatus().then(() => {
        const c = WEATHER_CONFIG;
        const w = CURRENT_WEATHER;
        
        let statusMessage = "‚úÖ Sistem Aktif";
        let statusColor = "#03dac6";
        let statusIcon = "‚úÖ";
        
        if (w.description === "FETCH_ERROR") {
            statusMessage = "‚ùå Hava verisi alƒ±namadƒ±";
            statusColor = "#cf6679";
            statusIcon = "‚ùå";
        } else if (!w.temp && !w.humidity) {
            statusMessage = "‚è≥ Hava durumu y√ºkleniyor...";
            statusColor = "#bb86fc";
            statusIcon = "‚è≥";
        }
        
        let windInfo = "-";
        if (w.wind_speed) {
            windInfo = `${w.wind_speed} m/s`;
            if (w.wind_direction && w.wind_direction !== "-") {
                windInfo += ` ${w.wind_direction}`;
            }
        }
        
        let scoreInfo = "";
        if (w.lightness_score && w.lightness_score > 0) {
            const score = w.lightness_score;
            let scoreText = "";
            let scoreColor = "";
            
            switch(score) {
                case 1:
                    scoreText = "A√áIK HAVA (Bulut ‚â§%25)";
                    scoreColor = "#4CAF50";
                    break;
                case 2:
                    scoreText = "PAR√áALI BULUTLU (%25-95)";
                    scoreColor = "#FF9800";
                    break;
                case 3:
                    scoreText = "KAPALI/GECE (%95+)";
                    scoreColor = "#2196F3";
                    break;
                default:
                    scoreText = `SKOR: ${score}`;
                    scoreColor = "#9C27B0";
            }
            
            scoreInfo = `
            <div style="background:#1a1a1a;padding:15px;border-radius:8px;margin-bottom:20px;border-left:5px solid ${scoreColor}">
                <div style="font-size:1.2em;font-weight:bold;color:${scoreColor};margin-bottom:5px">
                    üéØ BULUT SKORU: ${score}
                </div>
                <div style="font-size:0.9em;color:#ccc;font-weight:500">
                    ${scoreText}
                </div>
                <div style="font-size:0.8em;color:#888;margin-top:8px">
                    ${c.threshold ? `üìè E≈üik Deƒüer: ${c.threshold}` : ''}
                </div>
            </div>`;
        }
        
        let html = `
        <div class="settings-container">
            <h3>üå§Ô∏è Oto Meteoroloji Kontrol</h3>
            
            <div style="background:#222;padding:15px;border-radius:8px;margin-bottom:20px">
                <div style="font-size:1.1em;font-weight:bold;color:#03dac6;margin-bottom:10px">
                    ${w.city_name || c.city || '-'}
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div>üå°Ô∏è Sƒ±caklƒ±k: <b>${w.temp || '-'}¬∞C</b></div>
                    <div>üíß Nem: <b>%${w.humidity || '-'}</b></div>
                    <div>‚òÅÔ∏è Bulut: <b>%${w.clouds || '-'}</b></div>
                    <div>üå¨Ô∏è R√ºzgar: <b>${windInfo}</b></div>
                </div>
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid #333">
                    üåÖ G√ºn Doƒüumu: <b>${w.sunrise_time || '-'}</b><br>
                    üåá G√ºn Batƒ±mƒ±: <b>${w.sunset_time || '-'}</b>
                </div>
            </div>
            
            ${scoreInfo}
            
            <div style="background:#1a1a1a;padding:10px;border-radius:5px;margin-bottom:20px;border:2px solid ${statusColor};text-align:center">
                <span style="color:${statusColor};font-weight:bold;font-size:1.1em">
                    ${statusIcon} ${statusMessage}
                </span>
            </div>
            
            <table>
                <tr><td>Aktif:</td><td><input type="checkbox" id="w_active" ${c.active?'checked':''}></td></tr>
                <tr><td>Cihaz:</td><td><select id="w_dev">${DEVICES.map(d=>`<option value="${d.name}" ${c.device_name===d.name?'selected':''}>${d.name}</option>`).join('')}</select></td></tr>
                <tr><td>R√∂le:</td><td><select id="w_rel"><option value="1" ${c.relay_id==1?'selected':''}>R√∂le 1</option><option value="2" ${c.relay_id==2?'selected':''}>R√∂le 2</option></select></td></tr>
                <tr><td>ƒ∞≈ülem:</td><td><select id="w_act"><option value="ON" ${c.action=='ON'?'selected':''}>A√á</option><option value="OFF" ${c.action=='OFF'?'selected':''}>KAPAT</option></select></td></tr>
                <tr><td>E≈üik:</td><td><select id="w_thr"><option value="1" ${c.threshold==1?'selected':''}>1-Az Bulutlu</option><option value="2" ${c.threshold==2?'selected':''}>2-Par√ßalƒ±</option><option value="3" ${c.threshold==3?'selected':''}>3-Kapalƒ±/Gece</option></select></td></tr>
                <tr><td>Saat:</td><td><div style="display:flex;gap:5px;align-items:center"><input type="time" id="w_start" value="${c.start_time||'17:00'}">-<input type="time" id="w_end" value="${c.end_time||'23:00'}"></div></td></tr>
                <tr><td>R√ºzgar E≈üiƒüi (m/s):</td><td><input type="number" step="0.1" id="w_wind_threshold" placeholder="15.0" value="${c.wind_threshold||'15.0'}"></td></tr>
                <tr><td>≈ûehir:</td><td><input type="text" id="w_city" placeholder="ƒ∞stanbul" value="${c.city||''}"></td></tr>
                <tr><td>ƒ∞l√ße:</td><td><input type="text" id="w_district" placeholder="Kadƒ±k√∂y" value="${c.district||''}"></td></tr>
                <tr><td>Mahalle:</td><td><input type="text" id="w_neigh" placeholder="Opsiyonel" value="${c.neighbourhood||''}"></td></tr>
            </table>
            
            <br>
            
            <div style="display:flex;flex-direction:column;gap:10px">
                <button class="btn on" id="saveWeatherBtn" onclick="saveWeather()">üíæ Ayarlarƒ± Kaydet</button>
                <button class="btn" id="refreshWeatherBtn" onclick="refreshWeather()" style="background:#2196F3">üîÑ Hava Durumunu G√ºncelle</button>
            </div>
        </div>`;
        
        document.getElementById("content").innerHTML = html;
    });
}

function saveWeather() {
    const cfg = {
        active: document.getElementById('w_active').checked,
        device_name: document.getElementById('w_dev').value,
        relay_id: parseInt(document.getElementById('w_rel').value),
        threshold: parseInt(document.getElementById('w_thr').value),
        action: document.getElementById('w_act').value,
        start_time: document.getElementById('w_start').value,
        end_time: document.getElementById('w_end').value,
        wind_threshold: parseFloat(document.getElementById('w_wind_threshold').value),
        city: document.getElementById('w_city').value.trim(),
        district: document.getElementById('w_district').value.trim(),
        neighbourhood: document.getElementById('w_neigh').value.trim(),
        latitude: "",
        longitude: ""
    };
    
    const saveBtn = document.getElementById('saveWeatherBtn');
    const originalText = saveBtn.textContent;
    
    saveBtn.disabled = true;
    saveBtn.textContent = "‚è≥ Kaydediliyor...";
    
    fetch("/save_weather_config", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(cfg)
    })
    .then(r => {
        if(r.ok) {
            saveBtn.textContent = "‚úÖ Kaydedildi";
            saveBtn.style.background = "#4CAF50";
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = "";
                saveBtn.disabled = false;
                location.reload();
            }, 2000);
        } else {
            saveBtn.textContent = "‚ùå Hata";
            saveBtn.style.background = "#cf6679";
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = "";
                saveBtn.disabled = false;
            }, 3000);
        }
    })
    .catch(() => {
        saveBtn.textContent = "‚ùå Baƒülantƒ± Hatasƒ±";
        saveBtn.style.background = "#cf6679";
        setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtn.style.background = "";
            saveBtn.disabled = false;
        }, 3000);
    });
}

function refreshWeather() {
    const refreshBtn = document.getElementById('refreshWeatherBtn');
    const originalText = refreshBtn.textContent;
    
    refreshBtn.disabled = true;
    refreshBtn.textContent = "‚è≥ G√ºncelleniyor...";
    
    fetch("/save_weather_config", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({refresh: true})
    })
    .then(r => {
        if(r.ok) {
            refreshBtn.textContent = "‚úÖ G√ºncellendi";
            refreshBtn.style.background = "#4CAF50";
            setTimeout(() => {
                refreshBtn.textContent = originalText;
                refreshBtn.style.background = "";
                refreshBtn.disabled = false;
                location.reload();
            }, 2000);
        } else {
            refreshBtn.textContent = "‚ùå Hata";
            refreshBtn.style.background = "#cf6679";
            setTimeout(() => {
                refreshBtn.textContent = originalText;
                refreshBtn.style.background = "";
                refreshBtn.disabled = false;
            }, 3000);
        }
    })
    .catch(() => {
        refreshBtn.textContent = "‚ùå Baƒülantƒ± Hatasƒ±";
        refreshBtn.style.background = "#cf6679";
        setTimeout(() => {
            refreshBtn.textContent = originalText;
            refreshBtn.style.background = "";
            refreshBtn.disabled = false;
        }, 3000);
    });
}

// --- NAVƒ∞GASYON ---
function navigate() {
    const p = location.pathname;
    
    // Aktif men√ºy√º g√ºncelle
    document.querySelectorAll('.nav a').forEach(a => a.className = '');
    if(p === "/") document.getElementById("nav1").className = "active";
    else if(p === "/settings") document.getElementById("nav2").className = "active";
    else if(p === "/weather") document.getElementById("nav3").className = "active";
    else if(p === "/mqtt") document.getElementById("nav4").className = "active";

    // ƒ∞lgili sayfayƒ± render et
    if(p === "/settings") {
        fetchDevices().then(renderSettings);
    } else if(p === "/weather") {
        fetchDevices().then(renderWeather);
    } else if(p === "/mqtt") {
        fetchDevices().then(renderMqttControl);
    } else {
        fetchDevices().then(() => {
            renderControl();
            update();
        });
    }
}

// Sayfa Y√ºklendiƒüinde
window.onload = function() {
    window.onpopstate = navigate;
    navigate();
    setInterval(update, 2000); // Her 2 saniyede bir durum g√ºncelle
};
</script>
</body>
</html>
