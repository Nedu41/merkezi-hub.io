<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Merkezi Hub v5.5.2</title>
<meta http-equiv="Cache-Control" content="max-age=31536000, must-revalidate"> 

<style>

/* Buton animasyonları */
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.btn.pulsing {
  animation: pulse 1s infinite;
}

/* Başarı/başarısızlık renkleri */
.btn.success {
  background: #4CAF50 !important;
  color: white !important;
}

.btn.error {
  background: #cf6679 !important;
  color: white !important;
}

.btn.warning {
  background: #ff9800 !important;
  color: black !important;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #121212; /* Koyu arka plan */
  color: #eee;
  margin: 0;
  padding-bottom: 20px;
}

.header {
  background: #222;
  color: #03dac6; /* Neon yeşili/turkuaz vurgu */
  padding: 12px;
  text-align: center;
  font-size: 1.1em;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
  position: sticky;
  top: 0;
  z-index: 10;
}

.nav {
  display: flex;
  justify-content: space-around;
  background: #1e1e1e;
  padding: 0;
  margin: 0;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}

.nav a {
  flex-grow: 1;
  text-align: center;
  padding: 12px 0;
  text-decoration: none;
  color: #aaa;
  transition: all 0.3s ease;
  font-size: 0.9em;
  border-bottom: 3px solid transparent;
}

.nav a:hover {
  background: #2a2a2a;
  color: #fff;
}

.nav a.active {
  color: #03dac6;
  border-bottom: 3px solid #03dac6;
  background: #2a2a2a;
  font-weight: bold;
}

.container {
  padding: 20px 15px;
  max-width: 600px;
  margin: 0 auto;
}

/* KART STİLİ */
.card {
  background: #1f1f1f;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
  border: 1px solid #333;
}

.card h2 {
  color: #03dac6;
  margin-top: 0;
  margin-bottom: 15px;
  font-size: 1.2em;
  border-bottom: 1px solid #333;
  padding-bottom: 8px;
}

/* FORM/AYARLAR STİLİ */
.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  color: #aaa;
  font-size: 0.9em;
}

.form-group input[type="text"],
.form-group input[type="number"] {
  width: 100%;
  padding: 10px;
  border-radius: 4px;
  border: 1px solid #333;
  background: #2a2a2a;
  color: #fff;
  box-sizing: border-box;
  font-size: 1em;
}

.checkbox-group {
    display: flex;
    align-items: center;
    margin-top: 10px;
}

.checkbox-group input[type="checkbox"] {
    margin-right: 10px;
    width: 20px;
    height: 20px;
    background: #2a2a2a;
    border: 1px solid #03dac6;
    cursor: pointer;
}


/* BUTONLAR */
.btn {
  display: block;
  width: 100%;
  padding: 12px 15px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1em;
  font-weight: bold;
  text-align: center;
  transition: background 0.3s ease, opacity 0.3s ease;
  margin-top: 10px;
  opacity: 0.9;
}

.btn-primary {
  background: #03dac6;
  color: #121212;
}

.btn-secondary {
  background: #333;
  color: #eee;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn:hover:not(:disabled) {
  opacity: 1;
}

/* RÖLE KONTROL STİLİ */
.relay-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding: 10px 0;
  border-bottom: 1px dashed #333;
}

.relay-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.relay-name {
  font-size: 1em;
  font-weight: 500;
}

.relay-status-text {
  font-size: 0.9em;
  margin-top: 5px;
  color: #aaa;
}

.status-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-right: 10px;
  display: inline-block;
}

.status-indicator.on {
  background: #4CAF50; /* Yeşil */
  box-shadow: 0 0 5px #4CAF50;
}

.status-indicator.off {
  background: #cf6679; /* Kırmızı */
  box-shadow: 0 0 5px #cf6679;
}

.status-indicator.loading {
  background: #ff9800; /* Turuncu */
  box-shadow: 0 0 5px #ff9800;
}


/* HAVA DURUMU KARTLARI */
.weather-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 15px;
}

.weather-info-card {
    background: #2a2a2a;
    border-radius: 6px;
    padding: 10px;
    text-align: center;
    border: 1px solid #333;
}

.weather-info-card .label {
    font-size: 0.8em;
    color: #03dac6;
    margin-bottom: 5px;
    text-transform: uppercase;
}

.weather-info-card .value {
    font-size: 1.3em;
    font-weight: bold;
    color: #fff;
}

.main-weather-status {
    text-align: center;
    padding: 10px 0;
    font-size: 1.5em;
    font-weight: 300;
}

.main-weather-status .city {
    font-weight: 600;
    font-size: 0.8em;
    color: #03dac6;
}

/* MESAJ KAPSAYICISI */
#statusMessageContainer {
  text-align: center;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 4px;
  font-weight: 500;
  transition: all 0.5s ease;
}

.message-success {
  background: #4CAF50;
  color: white;
}

.message-error {
  background: #cf6679;
  color: white;
}

.message-info {
  background: #2196F3;
  color: white;
}

/* Ek Stil İyileştirmeleri */
.status-info {
    font-size: 0.8em;
    color: #666;
    text-align: center;
    margin-top: 10px;
}
.status-info span {
    color: #03dac6;
}

</style>
</head>
<body>

<div class="header">Merkezi Hub v5.5.2</div>

<div class="nav">
    <a href="#control" onclick="navigate('control'); return false;" id="nav1">Kontrol</a>
    <a href="#weather" onclick="navigate('weather'); return false;" id="nav3">Hava Durumu</a>
    <a href="#settings" onclick="navigate('settings'); return false;" id="nav2">Ayarlar</a>
</div>

<div class="container">
    <div id="statusMessageContainer"></div>
    <div id="content">Yükleniyor...</div>
</div>


<script>
// ====================================================================
// --- HUB IP ADRESİ AYARI ---
const HUB_IP = "http://esp32hub.local"; 
// ====================================================================

let deviceStates = {
    R1: { id: 'R1', name: 'Güneşlik Motoru (R1)', state: -1 },
    R2: { id: 'R2', name: 'Bahçe Aydınlatma (R2)', state: -1 } 
};

let weatherStatus = {
    city_name: 'Yükleniyor...',
    temp: '?',
    humidity: '?',
    wind_speed: '?',
    wind_direction: '?',
    description: 'Veri bekleniyor...',
    timestamp: 0
};

let weatherConfig = {
    city: '',
    country: 'TR',
    wind_threshold: 15.0,
    telegram_enabled: false
};

let isRelayUpdating = { R1: false, R2: false };

// Gecikme fonksiyonu
const delay = ms => new Promise(res => setTimeout(res, ms));

// Durum mesajı gösterme fonksiyonu
function showStatusMessage(type, message) {
    const container = document.getElementById('statusMessageContainer');
    if (!container) return;
    container.innerHTML = message;
    container.className = ''; 
    container.classList.add(`message-${type}`);
    
    if (type === 'success' || type === 'info') {
        // Hata mesajı değilse 4 saniye sonra temizle
        setTimeout(() => {
            container.innerHTML = '';
            container.className = '';
        }, 4000);
    }
}

/**
 * Tüm cihazların ve hava durumunun son durumunu Hub'dan çeker (Retry Mekanizmalı)
 * @param {number} retries - Deneme sayısı.
 * @param {number} delayTime - İlk deneme sonrası bekleme süresi (ms).
 */
async function fetchDevices(retries = 3, delayTime = 1000) {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(`${HUB_IP}/get_all_status`, { cache: 'no-store' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            
            // Veri işleme
            if (data.R1 !== undefined) updateDeviceState('R1', parseInt(data.R1));
            if (data.R2 !== undefined) updateDeviceState('R2', parseInt(data.R2));
            
            if (data.weather_status) {
                weatherStatus = {
                    timestamp: data.weather_status.timestamp || weatherStatus.timestamp,
                    city_name: data.weather_status.city_name || weatherStatus.city_name,
                    temp: data.weather_status.temp || weatherStatus.temp,
                    humidity: data.weather_status.humidity || weatherStatus.humidity,
                    wind_speed: data.weather_status.wind_speed || weatherStatus.wind_speed,
                    wind_direction: data.weather_status.wind_direction || weatherStatus.wind_direction,
                    description: data.weather_status.description || weatherStatus.description
                };
            }
            if (data.weather_config) {
                weatherConfig = {
                    city: data.weather_config.city || weatherConfig.city,
                    country: data.weather_config.country || weatherConfig.country,
                    // Değerin sayısal olduğundan emin ol
                    wind_threshold: parseFloat(data.weather_config.wind_threshold) || weatherConfig.wind_threshold,
                    telegram_enabled: data.weather_config.telegram_enabled === 'true' || data.weather_config.telegram_enabled === true
                };
            }
            return data; // Başarılı dönüş

        } catch (err) {
            // Son deneme değilse bekle ve tekrar dene
            if (i < retries - 1) {
                console.warn(`Veri çekme hatası (Deneme ${i+1}/${retries}). Tekrar deneniyor...`, err);
                await delay(delayTime * (i + 1)); // Exponential backoff benzeri
            } else {
                // Son denemede de hata varsa fırlat
                throw new Error(`BAĞLANTI HATASI: Hub'a ulaşılamıyor. ${err.message}`);
            }
        }
    }
}

// Cihaz durumunu günceller ve arayüzü kısmen render eder
function updateDeviceState(id, newState) {
    if (deviceStates[id].state !== newState) {
        deviceStates[id].state = newState;
        // Eğer kontrol sayfasındaysak durumu hemen güncelle
        if (location.hash === '#control' || location.hash === '') {
            renderControl(); 
        }
    }
}

// Cihaz kontrolü gönderir
async function sendControl(id, state) {
    if(isRelayUpdating[id]) return;

    // Butonu bul
    const btn = document.querySelector(`#control-btn-${id}`);
    
    // UI'daki durumu hemen loading olarak ayarla
    const previousState = deviceStates[id].state;
    deviceStates[id].state = -1; 
    renderControl();

    // Butonu disable et ve animasyonu başlat
    if(btn) {
        btn.disabled = true;
        btn.classList.add('pulsing');
        isRelayUpdating[id] = true;
    }

    try {
        const response = await fetch(`${HUB_IP}/manual_control?relay=${id.slice(1)}&state=${state}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        // Başarılı olursa son durumu çek ve UI'ı güncelle
        // Hızlı bir tek deneme yap (hata olursa yutulur)
        await fetchDevices(1, 0).catch(e => console.error("Hızlı durum çekme başarısız:", e.message)); 
        
        showStatusMessage('success', `${deviceStates[id].name} durumu ${state === 1 ? 'AÇIK' : 'KAPALI'} olarak güncellendi.`);

    } catch (err) {
        // Hata durumunda eski bilinen duruma geri dön (eğer varsa) ve hata mesajı göster
        console.error(`Kontrol gönderme hatası (${id}):`, err);
        showStatusMessage('error', `Kontrol hatası: ${deviceStates[id].name} güncellenemedi. Lütfen Hub bağlantısını kontrol edin.`);
        deviceStates[id].state = previousState; // Eski duruma geri dön
    } finally {
        if(btn) {
            btn.disabled = false;
            btn.classList.remove('pulsing');
            isRelayUpdating[id] = false;
        }
        renderControl(); // Son durumu yansıt
    }
}

// Hava durumu yenileme isteği gönderir
async function refreshWeather() {
    const refreshBtn = document.getElementById('refreshWeatherBtn');
    const originalText = refreshBtn.textContent;
    
    refreshBtn.textContent = "Güncelleniyor...";
    refreshBtn.disabled = true;
    refreshBtn.classList.add('pulsing');
    
    try {
        // Hub'a yenileme isteği gönder
        const response = await fetch(`${HUB_IP}/refresh_weather`);
        if (!response.ok) throw new Error('HTTP hatası');
        
        const data = await response.json();
        if (data.status === 'success') {
            showStatusMessage('info', 'Hava durumu isteği Hub tarafından alındı. Veri çekiliyor...');
            // Verilerin Hub'a inmesini beklemek için biraz gecikme ekleyelim
            await delay(3000); 
            // Yeni verileri çekmek için fetchDevices'ı yeniden deneme mekanizmasıyla çağır
            await fetchDevices(3, 1000); 
            renderWeather();
            showStatusMessage('success', 'Hava durumu verileri güncellendi.');
        } else {
            throw new Error(data.message || 'Bilinmeyen güncelleme hatası.');
        }
    } catch (err) {
        showStatusMessage('error', `Hava durumu yenileme hatası: ${err.message}`);
    } finally {
        refreshBtn.textContent = originalText;
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('pulsing');
    }
}

// Hava durumu ayarlarını kaydeder
async function saveWeatherConfig() {
    const saveBtn = document.getElementById('saveConfigBtn');
    const originalText = saveBtn.textContent;
    
    const city = document.getElementById('cityInput').value.trim();
    const country = document.getElementById('countryInput').value.trim();
    const windThreshold = document.getElementById('windThresholdInput').value.trim();
    const telegramEnabled = document.getElementById('telegramEnabledCheck').checked;
    
    if (!city || !country || !windThreshold || isNaN(parseFloat(windThreshold))) {
        showStatusMessage('error', 'Lütfen tüm alanları doğru şekilde doldurunuz.');
        return;
    }


    saveBtn.textContent = "Kaydediliyor...";
    saveBtn.disabled = true;
    saveBtn.classList.add('pulsing');
    
    // URLSearchParams ile verileri güvenli şekilde kodla
    const params = new URLSearchParams({
        city: city,
        country: country,
        wind_threshold: windThreshold,
        telegram_enabled: telegramEnabled ? 'true' : 'false'
    });
    
    const url = `${HUB_IP}/save_weather_config?${params.toString()}`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('HTTP hatası');
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showStatusMessage('success', 'Ayarlar başarıyla kaydedildi ve uygulandı.');
            // Güncel konfigürasyonu çek ve ayarlar sayfasını yeniden render et
            await fetchDevices(1, 0); 
            renderSettings();
        } else {
            throw new Error(data.message || 'Bilinmeyen kaydetme hatası.');
        }

    } catch (err) {
        showStatusMessage('error', `Ayarları kaydetme hatası: ${err.message}. Hub'a erişilemiyor.`);
    } finally {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
        saveBtn.classList.remove('pulsing');
    }
}

// WiFi sıfırlama
async function resetWiFi() {
    // ALERT KULLANILMIYOR: Özel modal yerine şimdilik tarayıcının yerleşik onay kutusu kullanılıyor
    if (!window.confirm("UYARI: WiFi ayarlarını sıfırlamak ve Hub'ı yapılandırma moduna almak istediğinizden emin misiniz?")) {
        return;
    }

    try {
        const response = await fetch(`${HUB_IP}/reset_wifi`);
        if (response.ok) {
            showStatusMessage('warning', "WiFi sıfırlama isteği gönderildi. Hub yeniden başlatılacak ve yeni WiFi ağına bağlanmanız gerekecek.");
        } else {
            showStatusMessage('error', "WiFi sıfırlama isteği gönderilemedi. Bağlantı hatası.");
        }
    } catch (err) {
        showStatusMessage('error', "WiFi sıfırlama isteği gönderilemedi. Hata: " + err.message);
    }
}

// Hub yeniden başlatma
async function restartHub() {
    // ALERT KULLANILMIYOR: Özel modal yerine şimdilik tarayıcının yerleşik onay kutusu kullanılıyor
    if (!window.confirm("UYARI: Hub'ı şimdi yeniden başlatmak istediğinizden emin misiniz?")) {
        return;
    }

    try {
        const response = await fetch(`${HUB_IP}/restart_hub`);
        if (response.ok) {
            showStatusMessage('warning', "Yeniden başlatma isteği gönderildi. Hub yeniden başlıyor... Birkaç saniye sonra tekrar deneyin.");
        } else {
            showStatusMessage('error', "Yeniden başlatma isteği gönderilemedi. Bağlantı hatası.");
        }
    } catch (err) {
        showStatusMessage('error', "Yeniden başlatma isteği gönderilemedi. Hata: " + err.message);
    }
}


// --- RENDER FONKSİYONLARI ---

function renderControl() {
    const content = document.getElementById('content');
    if (!content) return;

    let html = '<div class="card"><h2>Röle Kontrol Paneli</h2>';
    
    // Röleler
    Object.values(deviceStates).forEach(device => {
        const isOn = device.state === 1;
        const isOffline = device.state === -1;
        const statusText = isOffline ? 'YÜKLENİYOR...' : (isOn ? 'AÇIK' : 'KAPALI');
        const statusClass = isOffline ? 'loading' : (isOn ? 'on' : 'off');
        const nextState = isOn ? 0 : 1;
        const nextAction = isOn ? 'KAPAT' : 'AÇ';

        html += `
        <div class="relay-item">
            <div>
                <span class="relay-name">${device.name}</span>
                <div class="relay-status-text">
                    <span class="status-indicator ${statusClass}"></span> 
                    Mevcut Durum: ${statusText}
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button 
                    id="control-btn-${device.id}" 
                    data-state="${nextState}"
                    class="btn ${isOffline ? 'btn-secondary' : (isOn ? 'btn-secondary' : 'btn-primary')}" 
                    style="width: 80px;" 
                    onclick="sendControl('${device.id}', ${nextState})"
                    ${isOffline || isRelayUpdating[device.id] ? 'disabled' : ''}
                >
                    ${nextAction}
                </button>
            </div>
        </div>
        `;
    });

    html += '</div>';
    
    html += '<p class="status-info">Hub IP: <span>' + HUB_IP + '</span></p>';
    
    content.innerHTML = html;
}

function renderWeather() {
    const content = document.getElementById('content');
    if (!content) return;

    const windSpeedValue = parseFloat(weatherStatus.wind_speed);
    const windThresholdValue = parseFloat(weatherConfig.wind_threshold);

    const isWindy = !isNaN(windSpeedValue) && !isNaN(windThresholdValue) && windSpeedValue >= windThresholdValue;

    const windIcon = isWindy 
        ? '⚠️ Yüksek Rüzgar Uyarısı' 
        : (!isNaN(windSpeedValue) ? '✅ Normal Rüzgar Seviyesi' : 'Rüzgar Bilgisi Yok');
    
    const lastUpdate = weatherStatus.timestamp 
        ? new Date(weatherStatus.timestamp * 1000).toLocaleString('tr-TR') 
        : 'Bilinmiyor';

    let html = `
    <div class="card">
        <h2>Hava Durumu Bilgileri</h2>
        
        <div class="main-weather-status">
            <div class="city">${weatherStatus.city_name}</div>
            ${weatherStatus.description}
        </div>

        <div class="weather-grid">
            <div class="weather-info-card">
                <div class="label">Sıcaklık</div>
                <div class="value">${weatherStatus.temp}°C</div>
            </div>
            <div class="weather-info-card">
                <div class="label">Nem</div>
                <div class="value">${weatherStatus.humidity}%</div>
            </div>
            <div class="weather-info-card">
                <div class="label">Rüzgar Hızı</div>
                <div class="value">${weatherStatus.wind_speed} m/s</div>
            </div>
            <div class="weather-info-card">
                <div class="label">Rüzgar Yönü</div>
                <div class="value">${weatherStatus.wind_direction}</div>
            </div>
        </div>

        <p class="status-info" style="margin-top: 20px;">
            Son Güncelleme: <span>${lastUpdate}</span>
        </p>
        
        <button id="refreshWeatherBtn" class="btn btn-secondary" onclick="refreshWeather()">HAVA DURUMUNU ŞİMDİ GÜNCELLE</button>
    </div>

    <div class="card">
        <h2>Rüzgar Kontrol Durumu</h2>
        <div style="text-align: center; font-size: 1.1em; padding: 10px;">
            <p style="color: ${isWindy ? '#ff9800' : '#4CAF50'}; font-weight: bold;">${windIcon}</p>
            <p style="font-size: 0.9em; color: #aaa;">Güneşlik Kapatma Eşiği: <b>${weatherConfig.wind_threshold} m/s</b></p>
            <p style="font-size: 0.8em; color: #666;">Telegram Bildirimi: ${weatherConfig.telegram_enabled ? 'AÇIK' : 'KAPALI'}</p>
        </div>
    </div>
    `;
    content.innerHTML = html;
}


function renderSettings() {
    const content = document.getElementById('content');
    if (!content) return;

    let html = `
    <div class="card">
        <h2>Hava Durumu Ayarları</h2>
        <div class="form-group">
            <label for="cityInput">Şehir Adı (OpenWeatherMap için)</label>
            <input type="text" id="cityInput" value="${weatherConfig.city}" placeholder="Örn: Istanbul">
        </div>
        <div class="form-group">
            <label for="countryInput">Ülke Kodu (Örn: TR)</label>
            <input type="text" id="countryInput" value="${weatherConfig.country}" placeholder="Örn: TR">
        </div>
        <div class="form-group">
            <label for="windThresholdInput">Rüzgar Hızı Eşiği (m/s)</label>
            <input type="number" step="0.1" id="windThresholdInput" value="${weatherConfig.wind_threshold}" placeholder="Örn: 15.0">
        </div>
        
        <div class="form-group">
            <label for="telegramEnabledCheck" style="margin-bottom: 10px;">Telegram Bildirimi</label>
            <div class="checkbox-group">
                <input type="checkbox" id="telegramEnabledCheck" ${weatherConfig.telegram_enabled ? 'checked' : ''}>
                <label for="telegramEnabledCheck" style="margin: 0; color: #fff;">Rüzgar eşiği aşıldığında Telegram uyarısı gönderilsin.</label>
            </div>
        </div>
        
        <button id="saveConfigBtn" class="btn btn-primary" onclick="saveWeatherConfig()">AYARLARI KAYDET VE UYGULA</button>
    </div>

    <div class="card">
        <h2>Hub Yönetimi</h2>
        <p class="status-info" style="text-align: left; margin-bottom: 20px; color: #eee;">
            Cihazınızın WiFi bağlantısını sıfırlayabilir veya Hub'ı yeniden başlatabilirsiniz.
        </p>
        <button class="btn btn-secondary" onclick="restartHub()">Hub'ı Yeniden Başlat</button>
        <button class="btn btn-error" onclick="resetWiFi()" style="margin-top: 15px;">WiFi Ayarlarını Sıfırla (Yapılandırma Modu)</button>
    </div>
    `;
    content.innerHTML = html;
}


// --- PERİYODİK GÜNCELLEME VE NAVİGASYON ---

/**
 * Navigasyon işlemini yönetir. Önce iskeleti render eder, sonra arka planda veri çeker.
 * @param {string} page - Gidilecek sayfa (control, weather, settings).
 */
async function navigate(page) {
    // URL'deki hash'i ayarlar (boşsa 'control' varsay)
    const targetPage = page || location.hash.replace('#', '') || 'control';
    location.hash = targetPage;
    
    // Aktif menüyü güncelle
    document.querySelectorAll('.nav a').forEach(a => a.className = '');
    const activeNavId = targetPage === 'control' ? 'nav1' : (targetPage === 'settings' ? 'nav2' : 'nav3');
    const activeNav = document.getElementById(activeNavId);
    if(activeNav) activeNav.className = 'active';

    // 1. Sayfayı mevcut/eski verilerle hemen render et (iskeleti göster)
    if (targetPage === 'settings') {
        renderSettings();
    } else if (targetPage === 'weather') {
        renderWeather();
    } else {
        renderControl();
    }
    
    // Hata mesajını temizle
    document.getElementById('statusMessageContainer').innerHTML = '';


    // 2. Verileri arka planda güncelle (3 denemeli)
    try {
        await fetchDevices(3, 1000);
        
        // Veri geldikten sonra tekrar render et (güncel verilerle)
        if (targetPage === 'settings') renderSettings();
        else if (targetPage === 'weather') renderWeather();
        else renderControl();
        
    } catch (err) {
        console.error("Navigasyon sonrası veri güncelleme hatası:", err.message);
        // Kontrol sayfasında net bir hata göster
        if(targetPage === 'control') {
             showStatusMessage('error', err.message);
        } else {
             // Diğer sayfalarda daha az rahatsız edici bir uyarı
             showStatusMessage('info', 'Hub ile bağlantı kurulamadı. Veriler güncel olmayabilir.');
        }
    }
}

// Sayfa Yüklendiğinde
window.onload = function() {
    const hash = location.hash.replace('#', '');
    const defaultPage = hash || 'control'; 
    
    // Varsayılan sayfa navigasyonunu tetikle
    navigate(defaultPage);
    
    // Durum güncellemelerini periyodik olarak çek (Her 5 saniyede bir)
    setInterval(() => {
        // Periyodik güncelleme hatasını yut (tek deneme, 0ms bekleme)
        fetchDevices(1, 0) 
            .then(() => {
                // Sadece kontrol sayfasındaysak durumu güncelle
                const currentPage = location.hash.replace('#', '') || 'control';
                if(currentPage === 'control') renderControl(); 
            })
            .catch(err => {
                 // Konsolda uyarı mesajı bırak (UI'da gösterme, arayüzün kilitlenmesini engelle)
                 console.log('Periyodik güncelleme atlandı:', err.message);
            });
    }, 5000);
    
    // Hash (URL'deki #) değiştiğinde navigasyonu tekrar çağır
    window.onhashchange = () => navigate();
}
</script>
</body>
</html>
