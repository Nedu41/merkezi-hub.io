<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MQTT Cihaz Kontrol Hub</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#121212;color:#eee}
header{background:#1e1e1e;padding:12px;text-align:center;color:#03dac6;font-weight:bold}
.container{padding:10px;max-width:1100px;margin:auto}
.box{background:#1f1f1f;border:1px solid #333;border-radius:8px;padding:12px;margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
.device{background:#181818;border:1px solid #333;border-radius:8px;padding:10px}
.dev-head{display:flex;justify-content:space-between;align-items:center}
.dot{width:10px;height:10px;border-radius:50%}
.on{background:#4CAF50}
.off{background:#cf6679}
.btn{width:100%;padding:8px;margin-top:6px;border:none;border-radius:5px;font-size:14px;cursor:pointer}
.btn-on{background:#03dac6;color:#000}
.btn-off{background:#333;color:#eee}
.btn-del{background:#cf6679;color:#fff}
input{width:100%;padding:6px;margin-top:5px;background:#111;color:#fff;border:1px solid #333;border-radius:4px}
small{color:#888;font-size:12px}
</style>
</head>

<body>
<header>üîå MQTT MERKEZƒ∞ KONTROL HUB</header>

<div class="container">

<div class="box">
<h3>MQTT Baƒülantƒ±</h3>
<input id="broker" value="wss://broker.hivemq.com:8884/mqtt">
<input id="user" placeholder="Kullanƒ±cƒ± (opsiyonel)">
<input id="pass" type="password" placeholder="≈ûifre (opsiyonel)">
<button class="btn btn-on" onclick="mqttConnect()">Baƒülan</button>
</div>

<div class="box">
<h3>Cihaz Ekle / D√ºzenle</h3>
<input id="devName" placeholder="Cihaz Adƒ±">
<input id="devMac" placeholder="MAC ID (k√º√ß√ºk harf, :) yok)">
<input id="devIp" placeholder="IP Adresi (bilgi ama√ßlƒ±)">
<button class="btn btn-on" onclick="addOrUpdate()">Kaydet</button>
</div>

<div class="grid" id="deviceList"></div>

</div>

<script>
let client;
let devices = JSON.parse(localStorage.getItem("devices") || "[]");
let states = {};
let lastSeen = {};
let editIndex = -1;

function save(){ localStorage.setItem("devices", JSON.stringify(devices)); }

function mqttConnect(){
 client = mqtt.connect(broker.value,{
   username:user.value || undefined,
   password:pass.value || undefined,
   reconnectPeriod:3000
 });

 client.on("connect", ()=>{
   devices.forEach(d=>{
     client.subscribe(`esp01/${d.mac}/r1/state`);
     client.subscribe(`esp01/${d.mac}/r2/state`);
   });
 });

 client.on("message",(topic,payload)=>{
   const msg = payload.toString();
   const parts = topic.split("/");
   const mac = parts[1];
   const relay = topic.includes("r1") ? 1 : 2;

   states[mac] = states[mac] || {};
   states[mac][relay] = msg;
   lastSeen[mac] = Date.now();
   render();
 });
}

function addOrUpdate(){
 const name = devName.value.trim();
 const mac = devMac.value.trim();
 const ip  = devIp.value.trim();
 if(!name || !mac) return alert("Ad ve MAC zorunlu");

 if(editIndex >= 0){
   devices[editIndex] = {name, mac, ip};
   editIndex = -1;
 } else {
   devices.push({name, mac, ip});
   if(client){
     client.subscribe(`esp01/${mac}/r1/state`);
     client.subscribe(`esp01/${mac}/r2/state`);
   }
 }
 save();
 clearForm();
 render();
}

function clearForm(){
 devName.value=""; devMac.value=""; devIp.value="";
}

function toggle(mac, relay){
 const current = states[mac]?.[relay] === "1";
 client.publish(`esp01/${mac}/r${relay}/set`, current ? "0" : "1", {retain:true});
}

function isOnline(mac){
 return lastSeen[mac] && (Date.now() - lastSeen[mac] < 15000);
}

function editDevice(i){
 const d = devices[i];
 devName.value=d.name;
 devMac.value=d.mac;
 devIp.value=d.ip;
 editIndex=i;
}

function deleteDevice(i){
 if(confirm("Cihaz silinsin mi?")){
   devices.splice(i,1);
   save();
   render();
 }
}

function render(){
 const list = document.getElementById("deviceList");
 list.innerHTML="";
 devices.forEach((d,i)=>{
   const s = states[d.mac] || {};
   list.innerHTML += `
   <div class="device">
     <div class="dev-head">
       <b>${d.name}</b>
       <div class="dot ${isOnline(d.mac)?"on":"off"}"></div>
     </div>
     <small>MAC: ${d.mac}</small><br>
     <small>IP: ${d.ip || "-"}</small>

     <button class="btn ${s[1]==="1"?"btn-on":"btn-off"}"
       onclick="toggle('${d.mac}',1)">R√∂le 1 ${s[1]==="1"?"A√áIK":"KAPALI"}</button>

     <button class="btn ${s[2]==="1"?"btn-on":"btn-off"}"
       onclick="toggle('${d.mac}',2)">R√∂le 2 ${s[2]==="1"?"A√áIK":"KAPALI"}</button>

     <button class="btn" onclick="editDevice(${i})">‚úèÔ∏è D√ºzenle</button>
     <button class="btn btn-del" onclick="deleteDevice(${i})">üóë Sil</button>
   </div>`;
 });
}

render();
</script>
</body>
</html>
