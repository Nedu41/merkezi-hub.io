<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MQTT HUB</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body{margin:0;background:#121212;color:#eee;font-family:Segoe UI}
.header{background:#1e1e1e;padding:12px;text-align:center;color:#03dac6;font-weight:bold}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;padding:10px}
.card{background:#1f1f1f;border-radius:10px;padding:12px;border:1px solid #333}
.title{display:flex;justify-content:space-between;align-items:center}
.dot{width:10px;height:10px;border-radius:50%}
.on{background:#4CAF50}
.off{background:#cf6679}
button{width:100%;padding:10px;margin-top:6px;border:none;border-radius:6px;font-size:14px}
.btn-on{background:#03dac6;color:#000}
.btn-off{background:#333;color:#fff}
.btn-warn{background:#ff9800;color:#000}
input,select{width:100%;padding:6px;background:#111;color:#fff;border:1px solid #333;border-radius:4px;margin-top:5px}
.log{background:#111;padding:8px;border-radius:6px;height:120px;overflow:auto;font-size:12px}
.small{font-size:12px;color:#888}
</style>
</head>

<body>

<div class="header">üåê MQTT MERKEZƒ∞ HUB</div>

<div class="card">
<b>MQTT Ayarlarƒ±</b>
<input id="broker" value="wss://broker.hivemq.com:8884/mqtt">
<input id="user" placeholder="Kullanƒ±cƒ± (opsiyonel)">
<input id="pass" type="password" placeholder="≈ûifre (opsiyonel)">
<button class="btn-on" onclick="connect()">üîå Baƒülan</button>
</div>

<div class="card">
<b>Cihaz Ekle</b>
<input id="dname" placeholder="Cihaz Adƒ±">
<input id="dmac" placeholder="MAC (a1b2c3...)">
<button onclick="addDevice()">‚ûï Ekle</button>
</div>

<div class="grid" id="devices"></div>

<div class="card">
<b>üìú Loglar</b>
<div id="log" class="log"></div>
</div>

<script>
let client;
let devices = JSON.parse(localStorage.getItem("devices")||"[]");
let states = {};
let lastSeen = {};

function log(t){
 const l=document.getElementById("log");
 l.innerHTML+=`<div>${new Date().toLocaleTimeString()} ${t}</div>`;
 l.scrollTop=l.scrollHeight;
}

function save(){ localStorage.setItem("devices",JSON.stringify(devices)); }

function connect(){
 client=mqtt.connect(document.getElementById("broker").value,{
   username:document.getElementById("user").value,
   password:document.getElementById("pass").value,
   reconnectPeriod:3000
 });

 client.on("connect",()=>{
   log("MQTT baƒülƒ±");
   devices.forEach(d=>{
     client.subscribe(`esp01/${d.mac}/+/state`);
     client.subscribe(`esp01/${d.mac}/status`);
   });
 });

 client.on("message",(t,p)=>{
   const msg=p.toString();
   const parts=t.split("/");
   const mac=parts[1];
   lastSeen[mac]=Date.now();

   if(t.endsWith("/status")) return;
   const r=t.includes("r1")?1:2;
   states[mac]=states[mac]||{};
   states[mac][r]=msg;
   render();
 });
}

function addDevice(){
 const n=dname.value.trim(), m=dmac.value.trim();
 if(!n||!m) return;
 devices.push({name:n,mac:m});
 save();
 if(client){
   client.subscribe(`esp01/${m}/+/state`);
   client.subscribe(`esp01/${m}/status`);
 }
 render();
}

function toggle(mac,r){
 const val = states[mac]?.[r]==="1"?"0":"1";
 client.publish(`esp01/${mac}/r${r}/set`,val,{retain:true});
 log(`${mac} R${r} ‚Üí ${val}`);
}

function online(mac){
 return lastSeen[mac] && Date.now()-lastSeen[mac]<15000;
}

function render(){
 const c=document.getElementById("devices");
 c.innerHTML="";
 devices.forEach(d=>{
   const s=states[d.mac]||{};
   c.innerHTML+=`
   <div class="card">
     <div class="title">
       <b>${d.name}</b>
       <div class="dot ${online(d.mac)?"on":"off"}"></div>
     </div>
     <button class="${s[1]==="1"?"btn-on":"btn-off"}" onclick="toggle('${d.mac}',1)">
       R√∂le 1 ${s[1]==="1"?"A√áIK":"KAPALI"}
     </button>
     <button class="${s[2]==="1"?"btn-on":"btn-off"}" onclick="toggle('${d.mac}',2)">
       R√∂le 2 ${s[2]==="1"?"A√áIK":"KAPALI"}
     </button>
     <div class="small">${d.mac}</div>
   </div>`;
 });
}

render();
</script>
</body>
</html>
