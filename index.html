<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Merkezi Hub - Cihaz Kontrol (MQTT + Proxy)</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  :root{--bg:#0f1720;--card:#0b1220;--muted:#9aa4b2;--accent:#03dac6;}
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#e6eef6}
  header{padding:12px 16px;background:#071127;display:flex;align-items:center;justify-content:space-between}
  header h1{font-size:16px;margin:0;color:var(--accent)}
  .container{padding:12px;max-width:980px;margin:0 auto}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .card{background:var(--card);border-radius:10px;padding:12px;border:1px solid #122033}
  button{cursor:pointer;border:0;padding:10px;border-radius:8px;font-weight:600}
  .btn-on{background:var(--accent);color:#012}
  .btn-off{background:#1f2b3a;color:var(--muted)}
  .small{font-size:12px;color:var(--muted)}
  .settings-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  input,select{padding:8px;border-radius:8px;border:1px solid #122033;background:#081426;color:#e6eef6}
  .topbar{display:flex;gap:8px;align-items:center}
  .status-dot{width:12px;height:12px;border-radius:50%}
  .stat-online{background:#10b981}
  .stat-offline{background:#ef4444}
  .muted{color:var(--muted)}
  footer{padding:12px;text-align:center;color:var(--muted)}
  .controls{display:flex;gap:8px;margin-top:10px}
  .dev-controls{display:flex;gap:6px;margin-top:8px}
  .row{display:flex;gap:8px;align-items:center;margin-top:8px}
  .full-width{width:100%}
  .danger{background:#7f1d1d;color:#fff}
  .pill{padding:6px 10px;border-radius:20px;background:#071827;color:var(--muted);font-size:12px}
  @media (max-width:520px){header h1{font-size:14px}}
</style>
</head>
<body>
<header>
  <h1>Merkezi Hub ‚Äî T√ºm Cihazlar (MQTT + Proxy)</h1>
  <div class="topbar">
    <div id="connStatus" style="display:flex;align-items:center;gap:8px">
      <div id="connDot" class="status-dot stat-offline"></div>
      <div class="small" id="connText">MQTT: Kapalƒ±</div>
    </div>
  </div>
</header>

<div class="container">
  <div class="card" id="settingsCard">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Ayarlar</strong>
      <div class="small muted">Cihazlar localStorage'da saklanƒ±r</div>
    </div>

    <div class="settings-row" style="margin-top:8px">
      <input id="mqttUrl" placeholder="MQTT WSS URL (√∂rn: wss://broker.hivemq.com:8884/mqtt)" class="full-width" />
    </div>
    <div class="settings-row">
      <input id="hubIp" placeholder="Hub local IP (opsiyonel, proxy i√ßin) - √∂rn 192.168.1.100" />
      <input id="hubPort" placeholder="Hub port (opsiyonel, default 80)" style="width:120px" />
      <select id="controlMode">
        <option value="auto">√ñnce MQTT, sonra Proxy</option>
        <option value="mqtt">Sadece MQTT</option>
        <option value="proxy">Sadece Proxy</option>
      </select>
      <button id="btnConnect" class="full-width">Baƒülan / Ayarlarƒ± Kaydet</button>
    </div>
    <div class="small muted" style="margin-top:6px">
      Not: Eƒüer cihazlarda doƒürudan MQTT topicleri varsa kullan; deƒüilse IP + relay id ile proxy √ºzerinden g√∂nder.
    </div>
  </div>

  <div style="height:12px"></div>

  <div style="display:flex;gap:12px;flex-wrap:wrap">
    <div class="card" style="flex:1;min-width:320px">
      <strong>Cihazlar</strong>
      <div class="small muted">Ekle, d√ºzenle veya sil. Her cihaz i√ßin MQTT topic veya IP+Relay se√ßebilirsin.</div>

      <div id="devicesList" style="margin-top:10px"></div>

      <div style="margin-top:12px">
        <button id="btnAdd" class="">+ Yeni Cihaz Ekle</button>
        <button id="btnImport" class="small" style="margin-left:8px">JSON Import</button>
        <button id="btnExport" class="small" style="margin-left:6px">Export</button>
      </div>
    </div>

    <div class="card" style="width:320px">
      <strong>Kƒ±sa Kontroller</strong>
      <div class="small muted">Hub bilgileri ve anlƒ±k durumlar</div>
      <div class="row">
        <div class="pill">Hub IP: <span id="showHubIp" class="muted">‚Äî</span></div>
        <div class="pill">Mode: <span id="showMode" class="muted">‚Äî</span></div>
      </div>
      <div style="margin-top:8px">
        <button id="btnRefreshStates" class="">Durumlarƒ± Yenile</button>
        <button id="btnPingHub" class="">Hub'a Ping</button>
      </div>
      <div id="log" class="small muted" style="margin-top:10px;max-height:220px;overflow:auto"></div>
    </div>
  </div>

  <div style="height:12px"></div>

  <div id="devicesGrid" class="grid"></div>

</div>

<footer>
  <small>Kaydetme => Tarayƒ±cƒ±ya (localStorage). Dƒ±≈ü eri≈üim i√ßin GitHub Pages + MQTT broker + hub gerekli.</small>
</footer>

<!-- Modals / Templates (hidden) -->
<template id="deviceRowTpl">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="small muted device-name">NAME</div>
        <div class="small muted device-sub">MQTT: topicState / IP: ip</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <div class="dev-controls">
          <button class="btn-toggle btn-off">...</button>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn-edit small">D√ºzenle</button>
          <button class="btn-del small danger">Sil</button>
        </div>
      </div>
    </div>
  </div>
</template>

<template id="deviceCardTpl">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong class="dname">NAME</strong>
        <div class="small muted dsub">topicState | ip</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div class="small muted">Durum: <span class="dstate">‚Äî</span></div>
        <div class="dev-controls">
          <button class="btn-toggle btn-off">A√á</button>
          <button class="btn-refresh small">üîÅ</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
/*
  index.html - Merkezi Hub kontrol panel
  - localStorage key: 'mh_devices' -> JSON array of devices
  device structure:
  {
    id: 'uuid',
    name: 'Bah√ße1',
    mqttSet: 'nejat/relay/1/set',
    mqttState: 'nejat/relay/1/state',
    ip: '192.168.1.55',
    relayId: 1,
    invert: false  // eƒüer r√∂le logic ters ise
  }
*/

const LS_KEY = 'mh_devices_v1';
const SETTINGS_KEY = 'mh_settings_v1';

let devices = [];
let settings = { mqttUrl:'wss://broker.hivemq.com:8884/mqtt', hubIp:'', hubPort:'80', controlMode:'auto' };
let client = null;
let connected = false;

// Utils
function uid(){ return Math.random().toString(36).slice(2,10); }
function log(s){ const l=document.getElementById('log'); l.innerText = (new Date()).toLocaleTimeString() + ' ¬∑ ' + s + '\n' + l.innerText; }
function saveDevices(){ localStorage.setItem(LS_KEY, JSON.stringify(devices)); renderDevices(); }
function loadDevices(){ const j=localStorage.getItem(LS_KEY); if(j){ devices=JSON.parse(j);} else devices=[]; renderDevices(); }
function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }
function loadSettings(){ const j=localStorage.getItem(SETTINGS_KEY); if(j) settings=JSON.parse(j); 
 document.getElementById('mqttUrl').value = settings.mqttUrl || '';
 document.getElementById('hubIp').value = settings.hubIp || '';
 document.getElementById('hubPort').value = settings.hubPort || '';
 document.getElementById('controlMode').value = settings.controlMode || 'auto';
 updateHeaders();
}

// UI render
function renderDevices(){
  const list = document.getElementById('devicesList');
  const grid = document.getElementById('devicesGrid');
  list.innerHTML=''; grid.innerHTML='';
  devices.forEach(dev => {
    // Row
    const rowT = document.getElementById('deviceRowTpl').content.cloneNode(true);
    rowT.querySelector('.device-name').innerText = dev.name;
    rowT.querySelector('.device-sub').innerText = (dev.mqttState||'') + '  /  ' + (dev.ip||'‚Äî');
    const btnToggleRow = rowT.querySelector('.btn-toggle');
    btnToggleRow.innerText = '...';
    btnToggleRow.onclick = ()=>{ toggleDevice(dev.id); };
    rowT.querySelector('.btn-edit').onclick = ()=>{ openEdit(dev.id); };
    rowT.querySelector('.btn-del').onclick = ()=>{ if(confirm('Silinsin mi?')){ devices = devices.filter(d=>d.id!==dev.id); saveDevices(); } };
    list.appendChild(rowT);

    // Card
    const cardT = document.getElementById('deviceCardTpl').content.cloneNode(true);
    cardT.querySelector('.dname').innerText = dev.name;
    cardT.querySelector('.dsub').innerText = (dev.mqttState||'') + ' | ' + (dev.ip||'‚Äî');
    const stateEl = cardT.querySelector('.dstate');
    stateEl.innerText = '‚Äî';
    const btnToggle = cardT.querySelector('.btn-toggle');
    btnToggle.onclick = ()=> toggleDevice(dev.id);
    cardT.querySelector('.btn-refresh').onclick = ()=> refreshDeviceState(dev.id);
    grid.appendChild(cardT);

    // attach state updater
    dev._ui_stateEl = stateEl;
    dev._ui_cardSub = cardT.querySelector('.dsub');
    // set initial text
    updateDeviceUI(dev);
  });
}

// update a single device UI
function updateDeviceUI(dev){
  if(!dev) return;
  const el = dev._ui_stateEl;
  if(!el) return;
  // assume dev.lastState stored
  const s = dev.lastState;
  el.innerText = (s===undefined? '‚Äî' : (s===true?'A√áIK':'KAPALI'));
  const sub = dev._ui_cardSub;
  if(sub) sub.innerText = (dev.mqttState||'') + ' | ' + (dev.ip||'‚Äî');
}

// Toggle device: tries MQTT first, then proxy fallback depending on settings
function toggleDevice(id){
  const dev = devices.find(d=>d.id===id);
  if(!dev) return;
  const current = dev.lastState===true;
  const newState = !current;
  sendCommand(dev, newState);
}

// send command to device (MQTT or Proxy depending on controlMode)
function sendCommand(dev, state){
  const mode = settings.controlMode || 'auto';
  const preferMQTT = (mode==='mqtt' || (mode==='auto' && client && connected && dev.mqttSet));
  const preferProxy = (mode==='proxy' || (mode==='auto' && (!client || !connected) && dev.ip));
  const actionStr = state ? '1' : '0';

  if(preferMQTT && dev.mqttSet && client && connected){
    client.publish(dev.mqttSet, actionStr, {retain:true});
    log(`MQTT g√∂nderildi ${dev.name} -> ${dev.mqttSet} : ${actionStr}`);
    // optimistically set - will be corrected by state topic when arrives
    dev.lastState = state;
    updateDeviceUI(dev);
    saveDevices();
    return;
  }

  if((preferProxy || !client || !connected) && dev.ip){
    // use hub proxy if hubIp set; else try direct fetch to device ip
    const hubIp = settings.hubIp;
    const hubPort = settings.hubPort || '80';
    const relayId = dev.relayId || 1;
    const action = state ? 'on' : 'off';

    if(hubIp){
      const url = `http://${hubIp}:${hubPort}/proxy?ip=${dev.ip}&url=/control?id=${relayId}&action=${action}`;
      fetch(url).then(r=>r.text()).then(t=>{
        log(`Proxy g√∂nderildi via HUB -> ${dev.name}: ${action}`);
        dev.lastState = state;
        updateDeviceUI(dev);
        saveDevices();
      }).catch(e=>{
        log(`Proxy hata: ${e}`);
      });
      return;
    } else {
      // direct device HTTP control (if device accessible)
      const url = `http://${dev.ip}/control?id=${relayId}&action=${action}`;
      fetch(url).then(r=>r.text()).then(t=>{
        log(`Direct HTTP g√∂nderildi -> ${dev.name}: ${action}`);
        dev.lastState = state;
        updateDeviceUI(dev);
        saveDevices();
      }).catch(e=>{
        log(`Direct HTTP hata: ${e}`);
      });
      return;
    }
  }

  log('Komut g√∂nderilemedi: uygun y√∂ntem yok veya ayarlƒ± deƒüil');
}

// refresh device state (try MQTT retained or HTTP status)
function refreshDeviceState(id){
  const dev = devices.find(d=>d.id===id);
  if(!dev) return;
  // If MQTT state topic exists and client connected, hope retained message exists; otherwise try direct /status endpoint via proxy
  if(client && connected && dev.mqttState){
    // we rely on broker sending retained state to us (subscribe already)
    log('MQTT retained state bekleniyor: ' + dev.mqttState);
    // re-subscribe once to ensure we get retained
    client.subscribe(dev.mqttState);
    return;
  }

  if(dev.ip){
    const hubIp = settings.hubIp;
    const hubPort = settings.hubPort || '80';
    const relayId = dev.relayId || 1;
    if(hubIp){
      const url = `http://${hubIp}:${hubPort}/proxy?ip=${dev.ip}&url=/status`;
      fetch(url).then(r=>r.json()).then(j=>{
        // expecting format {"r1_state":"on","r2_state":"off"} or similar
        const s = j['r' + relayId + '_state'] || j['state'] || null;
        if(s!==null){
          const st = (String(s).toLowerCase().includes('on') || String(s)==='1');
          dev.lastState = st;
          updateDeviceUI(dev);
          saveDevices();
          log(`Proxy status alƒ±ndƒ±: ${dev.name} = ${st?'A√áIK':'KAPALI'}`);
        } else log('Status parse edilemedi');
      }).catch(e=>log('Proxy status hatasƒ±: ' + e));
    } else {
      const url = `http://${dev.ip}/status`;
      fetch(url).then(r=>r.json()).then(j=>{
        const s = j['r' + relayId + '_state'] || j['state'] || null;
        if(s!==null){
          const st = (String(s).toLowerCase().includes('on') || String(s)==='1');
          dev.lastState = st;
          updateDeviceUI(dev);
          saveDevices();
          log(`Direct status alƒ±ndƒ±: ${dev.name} = ${st?'A√áIK':'KAPALI'}`);
        } else log('Direct status parse edilemedi');
      }).catch(e=>log('Direct status hata: ' + e));
    }
  }
}

// MQTT connection management
function connectMQTT(url){
  if(client && client.connected) try{ client.end(); }catch(e){}
  try {
    client = mqtt.connect(url, {reconnectPeriod:4000});
    client.on('connect', ()=>{ connected=true; document.getElementById('connDot').className='status-dot stat-online'; document.getElementById('connText').innerText='MQTT: Baƒülƒ±'; log('MQTT baƒülandƒ±'); 
      // subscribe all state topics
      devices.forEach(d=>{ if(d.mqttState) client.subscribe(d.mqttState); });
    });
    client.on('reconnect', ()=>{ connected=false; document.getElementById('connDot').className='status-dot stat-offline'; document.getElementById('connText').innerText='MQTT: Yeniden baƒülanƒ±yor'; log('MQTT yeniden baƒülanƒ±yor'); });
    client.on('error', (err)=>{ connected=false; document.getElementById('connDot').className='status-dot stat-offline'; document.getElementById('connText').innerText='MQTT: Hata'; log('MQTT HATA: ' + err.message); });
    client.on('close', ()=>{ connected=false; document.getElementById('connDot').className='status-dot stat-offline'; document.getElementById('connText').innerText='MQTT: Kapalƒ±'; log('MQTT kapandƒ±'); });
    client.on('message', (topic, message) => {
      const msg = message.toString();
      // find device by state topic
      const dev = devices.find(d=>d.mqttState===topic);
      if(dev){
        const st = (msg==='1' || msg.toLowerCase()==='on' || msg==='true');
        dev.lastState = !!st;
        updateDeviceUI(dev);
        saveDevices();
        log(`MQTT gelen -> ${topic} : ${msg}`);
      } else {
        // try to match by topic ending
        const dev2 = devices.find(d=> topic.endsWith(d.mqttState) );
        if(dev2){
          const st = (msg==='1' || msg.toLowerCase()==='on' || msg==='true');
          dev2.lastState = !!st;
          updateDeviceUI(dev2);
          saveDevices();
          log(`MQTT gelen -> ${topic} : ${msg} (fuzzy match)`);
        } else {
          log(`MQTT gelen bilinmeyen topic: ${topic} : ${msg}`);
        }
      }
    });
  } catch(e){
    log('MQTT connect hata: ' + e);
  }
}

// UI actions
document.getElementById('btnConnect').onclick = ()=>{
  settings.mqttUrl = document.getElementById('mqttUrl').value.trim();
  settings.hubIp = document.getElementById('hubIp').value.trim();
  settings.hubPort = document.getElementById('hubPort').value.trim() || '80';
  settings.controlMode = document.getElementById('controlMode').value;
  saveSettings();
  updateHeaders();
  if(settings.mqttUrl) connectMQTT(settings.mqttUrl);
};

document.getElementById('btnAdd').onclick = ()=>{
  openEdit(); // blank
};

document.getElementById('btnImport').onclick = ()=>{
  const raw = prompt('Cihaz JSON yapƒ±≈ütƒ±r (array):');
  try{
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)){ devices = arr; saveDevices(); }
  } catch(e){ alert('JSON parse hatasƒ±: ' + e); }
};

document.getElementById('btnExport').onclick = ()=>{
  const s = JSON.stringify(devices, null, 2);
  prompt('Cihaz JSON (kopyalayƒ±n):', s);
};

document.getElementById('btnRefreshStates').onclick = ()=>{
  devices.forEach(d=>refreshDeviceState(d.id));
};

document.getElementById('btnPingHub').onclick = ()=>{
  const hubIp = settings.hubIp;
  if(!hubIp){ alert('Hub IP yok'); return; }
  const hubPort = settings.hubPort||80;
  fetch(`http://${hubIp}:${hubPort}/fetch_status`).then(r=>r.json()).then(j=>{
    log('Hub fetch_status OK');
    console.log(j);
  }).catch(e=>log('Hub ping hata: ' + e));
};

// edit / add modal (simple prompt-based)
function openEdit(id){
  const isNew = !id;
  const dev = devices.find(d=>d.id===id) || { id: uid(), name:'Yeni Cihaz', mqttSet:'', mqttState:'', ip:'', relayId:1, invert:false };
  const name = prompt('Cihaz adƒ±:', dev.name);
  if(name===null) return;
  const mqttSet = prompt('MQTT set topic (√∂rn nejat/relay/1/set) - bo≈ü bƒ±rak to use proxy:', dev.mqttSet || '');
  const mqttState = prompt('MQTT state topic (√∂rn nejat/relay/1/state):', dev.mqttState || '');
  const ip = prompt('Cihaz IP (√∂rn 192.168.1.55) - proxy i√ßin:', dev.ip || '');
  const relayId = parseInt(prompt('Relay ID (√∂rnek 1 veya 2):', dev.relayId || 1) || '1',10);
  const invert = confirm('R√∂le mantƒ±ƒüƒ± ters mi? (OK = ters, Cancel = normal)');

  const newDev = { id: dev.id, name, mqttSet: mqttSet||'', mqttState: mqttState||'', ip: ip||'', relayId:relayId||1, invert:invert||false };
  // replace or add
  devices = devices.filter(d=>d.id!==newDev.id);
  devices.push(newDev);
  saveDevices();
  // subscribe if mqttState exists
  if(client && connected && newDev.mqttState) client.subscribe(newDev.mqttState);
}

function updateHeaders(){
  document.getElementById('showHubIp').innerText = settings.hubIp || '‚Äî';
  document.getElementById('showMode').innerText = settings.controlMode || 'auto';
}

// initial load
loadSettings();
loadDevices();
// auto connect mqtt if url present
if(settings.mqttUrl) connectMQTT(settings.mqttUrl);

</script>
</body>
</html>
