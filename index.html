<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP01 Merkezi Kontrol v2.0</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #121212; 
            color: #eee; 
            padding-bottom: 20px;
        }
        
        /* Header */
        .header { 
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            color: #03dac6; 
            padding: 15px 20px; 
            text-align: center; 
            font-size: 1.3em; 
            font-weight: bold; 
            border-bottom: 3px solid #03dac6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title { flex: 1; }
        
        .clock { 
            font-size: 0.7em; 
            color: #bb86fc; 
            background: rgba(187, 134, 252, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #bb86fc;
        }
        
        /* Navigation */
        .nav { 
            background: #1a1a1a; 
            padding: 12px; 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            border-bottom: 1px solid #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .nav a { 
            color: #888; 
            text-decoration: none; 
            font-size: 0.95em; 
            padding: 8px 20px; 
            border-radius: 20px; 
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .nav a:hover {
            color: #03dac6;
            border-color: #03dac6;
            background: rgba(3, 218, 198, 0.1);
        }
        
        .nav a.active { 
            background: linear-gradient(135deg, #03dac6 0%, #bb86fc 100%);
            color: #000; 
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(3, 218, 198, 0.3);
        }
        
        /* Content Container */
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 15px;
        }
        
        /* Connection Status Bar */
        .connection-status {
            background: #1a1a1a;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .connection-status.connected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .connection-status.disconnected {
            border-color: #cf6679;
            background: rgba(207, 102, 121, 0.1);
        }
        
        .status-text {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.online {
            background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }
        
        .status-dot.offline {
            background: #cf6679;
            box-shadow: 0 0 10px #cf6679;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Device Management Section */
        .device-management {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .section-title {
            font-size: 1.2em;
            color: #03dac6;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .device-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input[type="text"], select {
            background: #2a2a2a;
            border: 2px solid #444;
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #03dac6;
            background: #333;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #03dac6 0%, #0097a7 100%);
            color: #000;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: #fff;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #cf6679 0%, #b00020 100%);
            color: #fff;
        }
        
        .btn-secondary {
            background: #444;
            color: #fff;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Device Cards Grid */
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .device-card {
            background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
            border: 2px solid #333;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: all 0.3s;
        }
        
        .device-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            border-color: #03dac6;
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #333;
        }
        
        .device-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #03dac6;
        }
        
        .device-mac {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #bb86fc;
            background: rgba(187, 134, 252, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #bb86fc;
        }
        
        /* Relay Controls */
        .relay-section {
            margin: 15px 0;
        }
        
        .relay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .relay-label {
            font-weight: bold;
            color: #fff;
            font-size: 1em;
        }
        
        .relay-status {
            font-size: 0.85em;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
        }
        
        .relay-status.on {
            background: #4CAF50;
            color: #000;
        }
        
        .relay-status.off {
            background: #666;
            color: #fff;
        }
        
        .relay-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* Schedule Section */
        .schedule-toggle {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #444;
            transition: all 0.3s;
        }
        
        .schedule-toggle:hover {
            background: #333;
            border-color: #bb86fc;
        }
        
        .schedule-content {
            display: none;
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #444;
        }
        
        .schedule-content.active {
            display: block;
        }
        
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }
        
        input[type="time"] {
            background: #1a1a1a;
            border: 2px solid #444;
            color: #fff;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.95em;
        }
        
        .days-selector {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin: 15px 0;
        }
        
        .day-btn {
            padding: 10px 5px;
            background: #333;
            border: 2px solid #444;
            color: #aaa;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.3s;
        }
        
        .day-btn.active {
            background: #bb86fc;
            color: #000;
            border-color: #bb86fc;
        }
        
        /* Log Console */
        .log-console {
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            margin-top: 20px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #333;
            padding-left: 10px;
        }
        
        .log-entry.success {
            color: #4CAF50;
            border-left-color: #4CAF50;
        }
        
        .log-entry.error {
            color: #cf6679;
            border-left-color: #cf6679;
        }
        
        .log-entry.info {
            color: #03dac6;
            border-left-color: #03dac6;
        }
        
        .log-entry.warning {
            color: #ff9800;
            border-left-color: #ff9800;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .device-form {
                grid-template-columns: 1fr;
            }
            
            .devices-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">üéõÔ∏è ESP01 Merkezi Kontrol Paneli v2.0</div>
        <div class="clock" id="clock">00:00:00</div>
    </div>

    <div class="nav">
        <a href="#" class="active" onclick="showTab('control')">üè† Kontrol Paneli</a>
        <a href="#" onclick="showTab('devices')">üì± Cihaz Y√∂netimi</a>
        <a href="#" onclick="showTab('logs')">üìä G√ºnl√ºk Kayƒ±tlarƒ±</a>
    </div>

    <div class="container">
        <!-- Connection Status -->
        <div class="connection-status" id="connectionStatus">
            <div class="status-text">
                <div class="status-dot offline" id="statusDot"></div>
                <span id="statusText">MQTT Broker'a Baƒülanƒ±yor...</span>
            </div>
            <div style="font-size: 0.85em; color: #888;">
                broker.hivemq.com:8884
            </div>
        </div>

        <!-- Control Panel Tab -->
        <div id="controlTab" class="tab-content">
            <div class="devices-grid" id="devicesGrid">
                <div style="text-align: center; padding: 40px; color: #888;">
                    <h3>üì± Hen√ºz Cihaz Eklenmedi</h3>
                    <p style="margin: 10px 0;">Cihaz Y√∂netimi sekmesinden cihaz ekleyebilirsiniz.</p>
                    <button class="btn btn-primary" onclick="showTab('devices')">Cihaz Ekle</button>
                </div>
            </div>
        </div>

        <!-- Device Management Tab -->
        <div id="devicesTab" class="tab-content" style="display: none;">
            <div class="device-management">
                <div class="section-title">
                    <span>üì±</span>
                    <span>Cihaz Ekle</span>
                </div>
                
                <div class="device-form">
                    <input type="text" id="deviceName" placeholder="Cihaz Adƒ± (√∂rn: Salon R√∂le)">
                    <input type="text" id="deviceMac" placeholder="MAC Adresi (12 karakter, k√º√ß√ºk harf)">
                    <input type="text" id="deviceIp" placeholder="IP Adresi (opsiyonel)">
                    <button class="btn btn-success" onclick="addDevice()">‚ûï Ekle</button>
                </div>

                <div id="savedDevicesList"></div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logsTab" class="tab-content" style="display: none;">
            <div class="device-management">
                <div class="section-title">
                    <span>üìä</span>
                    <span>Sistem G√ºnl√ºk Kayƒ±tlarƒ±</span>
                    <button class="btn btn-secondary" onclick="clearLogs()" style="margin-left: auto; padding: 5px 15px; font-size: 0.85em;">üóëÔ∏è Temizle</button>
                </div>
                
                <div class="log-console" id="logConsole">
                    <div class="log-entry info">Sistem ba≈ülatƒ±ldƒ±...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let client = null;
        let devices = JSON.parse(localStorage.getItem('esp01_devices') || '[]');
        const daysNames = ["Pt", "Sa", "√áa", "Pe", "Cu", "Ct", "Pz"];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeMQTT();
            updateClock();
            setInterval(updateClock, 1000);
            renderDevices();
            renderSavedDevices();
        });

        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('tr-TR');
        }

        // MQTT Connection
        function initializeMQTT() {
            addLog('MQTT Broker\'a baƒülanƒ±lƒ±yor...', 'info');
            
            client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');
            
            client.on('connect', function() {
                addLog('‚úì MQTT Broker\'a ba≈üarƒ±yla baƒülandƒ±!', 'success');
                updateConnectionStatus(true);
                subscribeToDevices();
            });
            
            client.on('error', function(err) {
                addLog('‚úó MQTT Hatasƒ±: ' + err.message, 'error');
                updateConnectionStatus(false);
            });
            
            client.on('message', function(topic, message) {
                handleMQTTMessage(topic, message.toString());
            });

            client.on('offline', function() {
                addLog('‚ö† MQTT Baƒülantƒ±sƒ± Kesildi', 'warning');
                updateConnectionStatus(false);
            });

            client.on('reconnect', function() {
                addLog('üîÑ MQTT Yeniden Baƒülanƒ±yor...', 'info');
            });
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const dotEl = document.getElementById('statusDot');
            const textEl = document.getElementById('statusText');
            
            if (connected) {
                statusEl.className = 'connection-status connected';
                dotEl.className = 'status-dot online';
                textEl.textContent = '‚úì MQTT Broker Baƒülƒ±';
            } else {
                statusEl.className = 'connection-status disconnected';
                dotEl.className = 'status-dot offline';
                textEl.textContent = '‚úó MQTT Broker Baƒülantƒ±sƒ± Yok';
            }
        }

        function subscribeToDevices() {
            devices.forEach(device => {
                const topics = [
                    `esp01/${device.mac}/r1/state`,
                    `esp01/${device.mac}/r2/state`
                ];
                
                topics.forEach(topic => {
                    client.subscribe(topic);
                    addLog(`üîî Abone olundu: ${topic}`, 'info');
                });
            });
        }

        function handleMQTTMessage(topic, message) {
            addLog(`üì® Mesaj: ${topic} = ${message}`, 'info');
            
            const parts = topic.split('/');
            if (parts.length === 4) {
                const mac = parts[1];
                const relay = parts[2]; // r1 or r2
                const device = devices.find(d => d.mac === mac);
                
                if (device) {
                    updateRelayStatus(device, relay, message);
                }
            }
        }

        function updateRelayStatus(device, relay, state) {
            const statusEl = document.getElementById(`status-${device.mac}-${relay}`);
            if (statusEl) {
                statusEl.textContent = state === '1' ? 'A√áIK' : 'KAPALI';
                statusEl.className = 'relay-status ' + (state === '1' ? 'on' : 'off');
            }
        }

        // Device Management
        function addDevice() {
            const name = document.getElementById('deviceName').value.trim();
            const mac = document.getElementById('deviceMac').value.trim().toLowerCase();
            const ip = document.getElementById('deviceIp').value.trim();
            
            if (!name || !mac) {
                alert('Cihaz adƒ± ve MAC adresi gereklidir!');
                return;
            }
            
            if (mac.length !== 12 || !/^[a-f0-9]+$/.test(mac)) {
                alert('MAC adresi 12 karakterli hexadecimal olmalƒ±dƒ±r! (√∂rn: aabbcc112233)');
                return;
            }
            
            if (devices.find(d => d.mac === mac)) {
                alert('Bu MAC adresi zaten kayƒ±tlƒ±!');
                return;
            }
            
            const device = { 
                name, 
                mac, 
                ip: ip || '',
                schedules: {
                    r1: { active: false, start: '08:00', end: '18:00', days: 127 },
                    r2: { active: false, start: '08:00', end: '18:00', days: 127 }
                }
            };
            
            devices.push(device);
            saveDevices();
            
            addLog(`‚úì Cihaz eklendi: ${name} (${mac})`, 'success');
            
            document.getElementById('deviceName').value = '';
            document.getElementById('deviceMac').value = '';
            document.getElementById('deviceIp').value = '';
            
            subscribeToDevices();
            renderDevices();
            renderSavedDevices();
            showTab('control');
        }

        function removeDevice(mac) {
            if (!confirm('Bu cihazƒ± silmek istediƒüinizden emin misiniz?')) return;
            
            devices = devices.filter(d => d.mac !== mac);
            saveDevices();
            
            addLog(`‚úì Cihaz silindi: ${mac}`, 'warning');
            
            renderDevices();
            renderSavedDevices();
        }

        function saveDevices() {
            localStorage.setItem('esp01_devices', JSON.stringify(devices));
        }

        // Rendering
        function renderDevices() {
            const grid = document.getElementById('devicesGrid');
            
            if (devices.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <h3>üì± Hen√ºz Cihaz Eklenmedi</h3>
                        <p style="margin: 10px 0;">Cihaz Y√∂netimi sekmesinden cihaz ekleyebilirsiniz.</p>
                        <button class="btn btn-primary" onclick="showTab('devices')">Cihaz Ekle</button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = devices.map(device => `
                <div class="device-card">
                    <div class="device-header">
                        <div class="device-name">${device.name}</div>
                        <div class="device-mac">${device.mac}</div>
                    </div>
                    
                    ${['r1', 'r2'].map((relay, index) => `
                        <div class="relay-section">
                            <div class="relay-header">
                                <span class="relay-label">üîå R√∂le ${index + 1}</span>
                                <span class="relay-status off" id="status-${device.mac}-${relay}">Bƒ∞Lƒ∞NMƒ∞YOR</span>
                            </div>
                            
                            <div class="relay-controls">
                                <button class="btn btn-success" onclick="sendCommand('${device.mac}', '${relay}', '1')">
                                    ‚úÖ A√á
                                </button>
                                <button class="btn btn-danger" onclick="sendCommand('${device.mac}', '${relay}', '0')">
                                    ‚≠ï KAPAT
                                </button>
                            </div>
                            
                            <div class="schedule-toggle" onclick="toggleSchedule('${device.mac}', '${relay}')">
                                <span>‚è∞ Zamanlayƒ±cƒ± Ayarlarƒ±</span>
                                <span>‚ñº</span>
                            </div>
                            
                            <div class="schedule-content" id="schedule-${device.mac}-${relay}">
                                ${renderScheduleControls(device, relay)}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function renderScheduleControls(device, relay) {
            const schedule = device.schedules[relay];
            
            return `
                <div class="time-inputs">
                    <input type="time" id="start-${device.mac}-${relay}" value="${schedule.start}">
                    <span style="color: #888;">‚Üí</span>
                    <input type="time" id="end-${device.mac}-${relay}" value="${schedule.end}">
                </div>
                
                <div class="days-selector" id="days-${device.mac}-${relay}">
                    ${daysNames.map((day, index) => `
                        <div class="day-btn ${(schedule.days & (1 << index)) ? 'active' : ''}" 
                             onclick="toggleDay('${device.mac}', '${relay}', ${index})">
                            ${day}
                        </div>
                    `).join('')}
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-success" onclick="saveSchedule('${device.mac}', '${relay}')">
                        üíæ KAYDET
                    </button>
                    <button class="btn btn-secondary" onclick="clearSchedule('${device.mac}', '${relay}')">
                        üóëÔ∏è TEMƒ∞ZLE
                    </button>
                </div>
            `;
        }

        function renderSavedDevices() {
            const list = document.getElementById('savedDevicesList');
            
            if (devices.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Kayƒ±tlƒ± cihaz yok</p>';
                return;
            }
            
            list.innerHTML = `
                <div style="margin-top: 20px;">
                    <h4 style="color: #bb86fc; margin-bottom: 15px;">Kayƒ±tlƒ± Cihazlar</h4>
                    ${devices.map(device => `
                        <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; color: #03dac6;">${device.name}</div>
                                <div style="font-size: 0.85em; color: #888; font-family: monospace;">${device.mac}</div>
                                ${device.ip ? `<div style="font-size: 0.85em; color: #888;">IP: ${device.ip}</div>` : ''}
                            </div>
                            <button class="btn btn-danger" onclick="removeDevice('${device.mac}')" style="padding: 5px 15px;">
                                üóëÔ∏è Sil
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Commands
        function sendCommand(mac, relay, value) {
            if (!client || !client.connected) {
                alert('MQTT baƒülantƒ±sƒ± yok!');
                return;
            }
            
            const topic = `esp01/${mac}/${relay}/set`;
            
            client.publish(topic, value, { qos: 0, retain: true }, (err) => {
                if (err) {
                    addLog(`‚úó Komut g√∂nderilemedi: ${err.message}`, 'error');
                } else {
                    addLog(`‚úì Komut g√∂nderildi: ${topic} = ${value}`, 'success');
                }
            });
        }

        // Schedule Management
        function toggleSchedule(mac, relay) {
            const el = document.getElementById(`schedule-${mac}-${relay}`);
            el.classList.toggle('active');
        }

        function toggleDay(mac, relay, dayIndex) {
            const device = devices.find(d => d.mac === mac);
            if (!device) return;
            
            device.schedules[relay].days ^= (1 << dayIndex);
            saveDevices();
            renderDevices();
        }

        function saveSchedule(mac, relay) {
            const device = devices.find(d => d.mac === mac);
            if (!device) return;
            
            const start = document.getElementById(`start-${mac}-${relay}`).value;
            const end = document.getElementById(`end-${mac}-${
