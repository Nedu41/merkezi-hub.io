<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Merkezi Hub - MAC BazlÄ± MQTT Kontrol</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#0f0f0f; color:#eee; margin:0; }
header { background:#222; padding:16px; text-align:center; font-size:22px; color:#00e5ff; font-weight:bold; }
.container { padding:10px; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:14px; padding:10px; }
.card { background:#1b1b1b; border-radius:14px; padding:16px; border:1px solid #333; box-shadow:0 0 8px #000; }
.card h3 { margin:0 0 8px 0; font-size:18px; color:#00e5ff; }
.card h4 { margin:5px 0; font-size:13px; color:#aaa; }
.btn { width:100%; padding:12px; border:none; border-radius:10px; font-size:16px; cursor:pointer; font-weight:bold; margin:5px 0; }
.on { background:#00e676; color:#000; }
.off { background:#333; color:#ccc; }
.groupBox { margin:12px 0; padding:10px; background:#111; border-radius:10px; border:1px solid #333; }
.groupBox h2 { margin:0 0 10px 0; font-size:18px; color:#ff9800; }
.addBox { background:#111; padding:12px; border-radius:10px; margin:10px; border:1px solid #333; }
.addBox input { width:100%; padding:10px; margin:5px 0; border-radius:8px; border:1px solid #555; background:#222; color:#fff; }
.addBox button { width:100%; padding:12px; margin-top:10px; background:#2196f3; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:15px; }
.topic-info { font-size:11px; color:#888; background:#111; padding:4px 8px; border-radius:4px; margin:5px 0; font-family:monospace; word-break:break-all; }
</style>
</head>
<body>
<header>MAC BazlÄ± MQTT Kontrol</header>
<div class="container">
<div class="all-buttons" style="display:flex; gap:12px; padding:12px;">
  <button onclick="turnAll(1)" style="flex:1; background:#00e676;color:#000">TÃœMÃœNÃœ AÃ‡</button>
  <button onclick="turnAll(0)" style="flex:1; background:#ff5252;color:#fff">TÃœMÃœNÃœ KAPAT</button>
</div>
<div id="groupArea"></div>
<div class="addBox">
  <h3>Yeni Cihaz Ekle (Masa LambasÄ± vs.)</h3>
  <input id="devName" placeholder="Cihaz AdÄ± (Ã¶rn: Masa LambasÄ±)">
  <input id="devIP" placeholder="IP Adresi (Ã¶rn: 192.168.1.113)">
  <input id="devGroup" placeholder="Grup (Ã¶rn: Ã‡alÄ±ÅŸma OdasÄ±)">
  <button onclick="addDevice()">MAC'Ä° AL VE EKLE</button>
  <p style="font-size:11px;color:#bb86fc;margin-top:10px;">
    â†’ IP girildikten sonra otomatik /mac endpoint'inden MAC alÄ±nÄ±r<br>
    â†’ Topic: esp01/5CCF7F69093D/set gibi olur
  </p>
</div>
<div id="deviceGrid" class="grid"></div>
</div>

<script>
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

let devices = JSON.parse(localStorage.getItem("mac_devices") || "[]");

async function addDevice(){
    const name = document.getElementById('devName').value.trim();
    const ip = document.getElementById('devIP').value.trim();
    const group = document.getElementById('devGroup').value.trim() || "Genel";
    
    if(!name || !ip){
        alert("Cihaz adÄ± ve IP gereklidir!");
        return;
    }
    
    // MAC al
    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "MAC alÄ±nÄ±yor...";
    
    try {
        const response = await fetch(`http://${ip}/mac`, {timeout: 5000});
        if(!response.ok) throw new Error("MAC alÄ±namadÄ±");
        let mac = await response.text();
        mac = mac.trim().toUpperCase().replace(/:/g, "");
        
        if(mac.length !== 12){
            throw new Error("GeÃ§ersiz MAC");
        }
        
        if(devices.some(d => d.mac === mac)){
            alert("Bu MAC adresi zaten ekli!");
            return;
        }
        
        const topicSet = `esp01/${mac}/set`;
        const topicState = `esp01/${mac}/state`;
        
        devices.push({name, ip, mac, topicSet, topicState, group, status: "unknown"});
        localStorage.setItem("mac_devices", JSON.stringify(devices));
        
        client.subscribe(topicState);
        alert(`BaÅŸarÄ±lÄ±! MAC: ${mac}\nTopic: ${topicSet}`);
        
        document.getElementById('devName').value = "";
        document.getElementById('devIP').value = "";
        document.getElementById('devGroup').value = "";
        
        buildUI();
    } catch(err) {
        alert("Hata: " + (err.message || "MAC alÄ±namadÄ±. IP doÄŸru mu? Cihaz aÃ§Ä±k mÄ±?"));
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

function buildUI(){
    const grid = document.getElementById("deviceGrid");
    const groupArea = document.getElementById("groupArea");
    grid.innerHTML = "";
    groupArea.innerHTML = "";
    
    const groups = {};
    devices.forEach(d => {
        if(!groups[d.group]) groups[d.group] = [];
        groups[d.group].push(d);
    });
    
    for(const g in groups){
        const box = document.createElement("div");
        box.className = "groupBox";
        box.innerHTML = `<h2>${g} (${groups[g].length} cihaz)</h2>`;
        const buttons = document.createElement("div");
        buttons.style.display = "flex";
        buttons.style.gap = "10px";
        buttons.innerHTML = `
            <button onclick="turnGroup('${g}',1)" style="flex:1;background:#00e676;color:#000;padding:10px;font-size:14px;">AÃ‡</button>
            <button onclick="turnGroup('${g}',0)" style="flex:1;background:#ff5252;color:#fff;padding:10px;font-size:14px;">KAPAT</button>
        `;
        box.appendChild(buttons);
        groupArea.appendChild(box);
    }
    
    devices.forEach((d, i) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
            <h3>${d.name}</h3>
            <h4>ğŸ†” MAC: ${d.mac}</h4>
            <h4>ğŸ“¡ IP: ${d.ip}</h4>
            <h4>ğŸ“Š Durum: <span id="status${i}">${d.status === "1" ? "AÃ‡IK" : d.status === "0" ? "KAPALI" : "BEKLENÄ°YOR"}</span></h4>
            <div class="topic-info">
                <div>Set: ${d.topicSet}</div>
                <div>State: ${d.topicState}</div>
            </div>
            <button id="btn${i}" class="btn ${d.status === "1" ? "on" : "off"}" onclick="toggle(${i})">
                ${d.status === "1" ? "AÃ‡IK" : d.status === "0" ? "KAPALI" : "YÃœKLENÄ°YOR"}
            </button>
            <div style="display:flex;gap:10px;margin-top:10px;">
                <button onclick="deleteDevice(${i})" style="flex:1;padding:8px;background:#ff5252;color:#fff;border:none;border-radius:8px;font-size:12px;">ğŸ—‘ï¸ Sil</button>
                <button onclick="copyTopic('${d.topicSet}')" style="flex:1;padding:8px;background:#2196f3;color:#fff;border:none;border-radius:8px;font-size:12px;">ğŸ“‹ Kopyala</button>
            </div>
        `;
        grid.appendChild(card);
    });
}

client.on("connect", () => {
    console.log("MQTT BaÄŸlandÄ±");
    devices.forEach(d => client.subscribe(d.topicState));
});

client.on("message", (topic, msg) => {
    const val = msg.toString().trim();
    devices.forEach((d, i) => {
        if(topic === d.topicState){
            d.status = val;
            const btn = document.getElementById("btn"+i);
            const span = document.getElementById("status"+i);
            if(btn){
                btn.textContent = val === "1" ? "AÃ‡IK" : "KAPALI";
                btn.className = "btn " + (val === "1" ? "on" : "off");
            }
            if(span) span.textContent = val === "1" ? "AÃ‡IK" : "KAPALI";
        }
    });
});

function toggle(i){
    const d = devices[i];
    const newState = d.status === "1" ? "0" : "1";
    d.status = newState;
    client.publish(d.topicSet, newState, {retain: true});
    buildUI();
}

function turnAll(state){
    devices.forEach(d => client.publish(d.topicSet, String(state), {retain: true}));
    setTimeout(buildUI, 500);
}

function turnGroup(group, state){
    devices.forEach(d => {
        if(d.group === group) client.publish(d.topicSet, String(state), {retain: true});
    });
    setTimeout(buildUI, 500);
}

function deleteDevice(i){
    if(confirm("Bu cihazÄ± silmek istediÄŸinize emin misiniz?")){
        client.unsubscribe(devices[i].topicState);
        devices.splice(i, 1);
        localStorage.setItem("mac_devices", JSON.stringify(devices));
        buildUI();
    }
}

function copyTopic(topic){
    navigator.clipboard.writeText(topic).then(() => alert("KopyalandÄ±: " + topic));
}

buildUI();
</script>
</body>
</html>
