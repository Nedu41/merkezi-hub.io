<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>ESP01 Debug Kontrol</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 20px; }
        .log-box { background: black; color: #00ff00; padding: 10px; height: 150px; overflow-y: scroll; font-family: monospace; font-size: 12px; border: 1px solid #333; }
        .device-card { background: #1e1e1e; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 5px solid #2196f3; }
        button { padding: 10px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ESP01 Kontrol Test Paneli</h2>
    
    <div id="status">MQTT Bağlantısı Bekleniyor...</div>
    <div class="log-box" id="log">Sistem başlatıldı...<br></div>

    <div class="device-card">
        <h3>Cihaz Testi</h3>
        <input type="text" id="macInput" placeholder="MAC (Örn: aabbcc112233)" style="padding:8px; width:200px;">
        <button onclick="sendTest('1')" style="background: green; color: white;">AÇ (1 Gönder)</button>
        <button onclick="sendTest('0')" style="background: red; color: white;">KAPAT (0 Gönder)</button>
        <p style="font-size: 11px; color: #888;">Not: MAC adresini küçük harfle ve iki noktasız girin.</p>
    </div>

    <script>
        const logEl = document.getElementById('log');
        const statusEl = document.getElementById('status');
        
        // Broker Bağlantısı
        const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

        function addLog(msg) {
            logEl.innerHTML += "> " + msg + "<br>";
            logEl.scrollTop = logEl.scrollHeight;
        }

        client.on("connect", () => {
            statusEl.innerText = "BAĞLANDI: broker.hivemq.com";
            statusEl.style.color = "#00ff00";
            addLog("MQTT Broker'a bağlanıldı.");
        });

        client.on("error", (err) => {
            addLog("HATA: " + err);
        });

        function sendTest(val) {
            const mac = document.getElementById('macInput').value.trim().toLowerCase();
            if(!mac) { alert("Önce MAC girin!"); return; }
            
            const topic = "esp01/" + mac + "/set";
            addLog("Gönderiliyor: " + topic + " -> Değer: " + val);
            
            client.publish(topic, val, { qos: 0, retain: true }, (err) => {
                if(err) addLog("Gönderim HATASI: " + err);
                else addLog("Mesaj başarıyla iletildi.");
            });
        }

        // ESP'den gelen yanıtları dinle
        client.on("message", (topic, message) => {
            addLog("GERİ BİLDİRİM GELDİ: " + topic + " = " + message.toString());
        });
        
        // Tüm state kanallarını dinle
        client.subscribe("esp01/+/state");
    </script>
</body>
</html>
