<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>ESP01 MAC Kontrol Paneli</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
    body { font-family: sans-serif; background:#0f0f0f; color:#eee; margin:0; padding: 20px; }
    header { background:#222; padding:15px; text-align:center; color:#00e5ff; font-weight:bold; border-radius: 10px; margin-bottom: 20px; }
    .card { background:#1b1b1b; border:1px solid #333; padding:15px; border-radius:12px; margin-bottom: 10px; }
    .btn { width:100%; padding:12px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin-top: 10px; }
    .on { background:#00e676; color:#000; }
    .off { background:#444; color:#ccc; }
    .addBox { background:#1b1b1b; padding:20px; border-radius:12px; border:1px solid #00e5ff; margin-bottom: 20px; }
    input { width:100%; padding:10px; margin:5px 0; border-radius:5px; border:1px solid #444; background:#222; color:#fff; box-sizing: border-box; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:15px; }
</style>
</head>
<body>

<header>ESP01 MERKEZİ KONTROL</header>

<div class="addBox">
  <h3>Yeni Cihaz Ekle</h3>
  <input id="devName" placeholder="Cihaz Adı (Örn: Mutfak)">
  <input id="devMAC" placeholder="MAC Adresi (Örn: AABBCCDDEEFF)">
  <input id="devGroup" placeholder="Grup (Örn: Alt Kat)">
  <button onclick="addDevice()" style="width:100%; padding:12px; background:#2196f3; color:#fff; border:none; border-radius:8px; cursor:pointer;">EKLE</button>
</div>

<div class="grid" id="deviceGrid"></div>

<script>
// MQTT Bağlantısı
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

// Yerel depolamadan cihazları çek
let devices = JSON.parse(localStorage.getItem("esp_devices") || "[]");

// CİHAZ EKLEME FONKSİYONU
function addDevice() {
    const name = document.getElementById('devName').value.trim();
    const macInput = document.getElementById('devMAC').value.trim();
    const group = document.getElementById('devGroup').value.trim() || "Genel";

    if (!name || !macInput) {
        alert("Lütfen isim ve MAC adresini girin!");
        return;
    }

    // MAC adresini temizle (İki noktaları sil ve küçült)
    const mac = macInput.replace(/:/g, "").toLowerCase();
    
    // ESP01 .ino dosyasındaki yapıya uyumlu topicler 
    const topicSet = "esp01/" + mac + "/set";
    const topicState = "esp01/" + mac + "/state";

    devices.push({ name, mac, topicSet, topicState, group, status: "0" });
    localStorage.setItem("esp_devices", JSON.stringify(devices));

    // Formu temizle
    document.getElementById('devName').value = "";
    document.getElementById('devMAC').value = "";

    client.subscribe(topicState);
    buildUI();
}

// ARAYÜZÜ ÇİZ
function buildUI() {
    const grid = document.getElementById("deviceGrid");
    grid.innerHTML = "";

    devices.forEach((d, index) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <span style="color:#aaa; font-size:12px;">${d.group}</span>
                <span style="color:${d.status === "1" ? "#00e676" : "#ff5252"}">● ${d.status === "1" ? "AÇIK" : "KAPALI"}</span>
            </div>
            <h3 style="margin:10px 0;">${d.name}</h3>
            <div style="font-size:10px; color:#666; font-family:monospace;">${d.topicSet}</div>
            <button class="btn ${d.status === "1" ? 'on' : 'off'}" onclick="toggle(${index})">
                ${d.status === "1" ? "KAPAT" : "AÇ"}
            </button>
            <button onclick="deleteDevice(${index})" style="background:none; border:none; color:#ff5252; cursor:pointer; margin-top:10px; font-size:12px;">Cihazı Sil</button>
        `;
        grid.appendChild(card);
    });
}

// DURUM DEĞİŞTİR
function toggle(index) {
    const d = devices[index];
    const newState = d.status === "1" ? "0" : "1";
    // MQTT'ye gönder [cite: 40, 41, 42]
    client.publish(d.topicSet, newState, { retain: true });
}

// CİHAZ SİL
function deleteDevice(index) {
    if (confirm("Bu cihazı silmek istediğinize emin misiniz?")) {
        client.unsubscribe(devices[index].topicState);
        devices.splice(index, 1);
        localStorage.setItem("esp_devices", JSON.stringify(devices));
        buildUI();
    }
}

// MQTT MESAJLARINI DİNLE
client.on("message", (topic, msg) => {
    const val = msg.toString().trim();
    devices.forEach(d => {
        if (topic === d.topicState) {
            d.status = val;
            buildUI();
        }
    });
});

client.on("connect", () => {
    console.log("MQTT Bağlandı!");
    devices.forEach(d => client.subscribe(d.topicState));
});

// Sayfa açıldığında arayüzü oluştur
buildUI();

</script>
</body>
</html>
