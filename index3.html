<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Merkezi Hub v5.5 (MQTT - Çoklu Röle)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body { font-family: Arial; background:#121212; color:#eee; margin:0; }
.header { background:#222; color:#03dac6; padding:14px; text-align:center; font-size:20px; font-weight:bold; }
.grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); gap:12px; padding:12px; }
.card { background:#1e1e1e; border-radius:12px; padding:10px; border:1px solid #333; }
.btn { padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; width:100%; font-size:16px; }
.on { background:#03dac6; color:#000; }
.off { background:#333; color:#ccc; }
.all-buttons { display:flex; gap:10px; padding:10px; }
.all-buttons button { flex:1; padding:10px; font-size:15px; border:none; border-radius:8px; cursor:pointer; }
</style>
</head>
<body>

<div class="header">MERKEZİ HUB (MQTT - Çoklu Röle Kontrolü)</div>

<!-- Toplu kontrol butonları -->
<div class="all-buttons">
  <button onclick="turnAll(1)" style="background:#03dac6;color:#000">TÜMÜNÜ AÇ</button>
  <button onclick="turnAll(0)" style="background:#f55;color:#fff">TÜMÜNÜ KAPAT</button>
</div>

<div class="grid" id="deviceGrid"></div>

<script>
// MQTT BAĞLANTI
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

// -------------------------
// CİHAZ LİSTESİ
// -------------------------
const devices = [
  { name: "Röle 1", topicSet:"nejat/relay/1/set", topicState:"nejat/relay/1/state" },
  { name: "Röle 2", topicSet:"nejat/relay/2/set", topicState:"nejat/relay/2/state" },

  // Buraya istediğin kadar cihaz ekleyebilirsin:
  // { name:"Salon Lamba", topicSet:"nejat/relay/salon/set", topicState:"nejat/relay/salon/state" },
  // { name:"Bahçe", topicSet:"nejat/relay/bahce/set", topicState:"nejat/relay/bahce/state" },
  // { name:"Priz", topicSet:"nejat/relay/priz/set", topicState:"nejat/relay/priz/state" },
];

// -------------------------
// ARAYÜZ OLUŞTUR
// -------------------------
function renderDevices(){
  const grid = document.getElementById("deviceGrid");
  grid.innerHTML = "";

  devices.forEach((d, index) => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h4>${d.name}</h4>
      <button id="btn${index}" class="btn off" onclick="toggle(${index})">...</button>
    `;

    grid.appendChild(card);
  });
}

// -------------------------
// MQTT BAĞLANINCA
// -------------------------
client.on("connect", () => {
  console.log("MQTT bağlandı");

  // Tüm STATE topic'lerini dinle
  devices.forEach(d => {
    client.subscribe(d.topicState);
  });
});

// -------------------------
// STATE MESAJLARI
// -------------------------
client.on("message", (topic, message) => {
  const val = message.toString();

  devices.forEach((d, index) => {
    if (topic === d.topicState) {
      const btn = document.getElementById("btn" + index);

      if(val === "1"){
        btn.textContent = "AÇIK";
        btn.className = "btn on";
      } else {
        btn.textContent = "KAPALI";
        btn.className = "btn off";
      }
    }
  });
});

// -------------------------
// TEK CİHAZI AÇ/KAPA
// -------------------------
function toggle(index){
  const d = devices[index];
  const btn = document.getElementById("btn" + index);
  const newState = btn.textContent === "AÇIK" ? "0" : "1";
  client.publish(d.topicSet, newState, { retain:true });
}

// -------------------------
// TÜM CİHAZLARI AÇ/KAPA
// -------------------------
function turnAll(state){
  devices.forEach(d => {
    client.publish(d.topicSet, String(state), { retain:true });
  });
}

renderDevices();
</script>

</body>
</html>
