<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP01 MQTT Kontrol</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #fff;
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

h1 {
    text-align: center;
    color: #03dac6;
    margin-bottom: 10px;
    font-size: 2em;
}

.mqtt-status {
    text-align: center;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 30px;
    font-weight: bold;
    font-size: 1.1em;
}

.mqtt-status.connected {
    background: #4CAF50;
    color: white;
}

.mqtt-status.disconnected {
    background: #cf6679;
    color: white;
}

.mqtt-status.connecting {
    background: #ff9800;
    color: white;
}

.add-device-section {
    background: rgba(30, 30, 30, 0.95);
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 30px;
    border: 1px solid rgba(255,255,255,0.1);
}

.add-device-section h3 {
    color: #03dac6;
    margin-bottom: 15px;
}

.input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.input-group {
    flex: 1;
    min-width: 200px;
}

.input-group label {
    display: block;
    margin-bottom: 5px;
    color: #aaa;
    font-size: 0.85em;
}

.input-group input, .input-group select {
    width: 100%;
    padding: 10px;
    background: #252525;
    color: #fff;
    border: 1px solid #444;
    border-radius: 8px;
    font-size: 1em;
}

.input-group input:focus, .input-group select:focus {
    outline: none;
    border-color: #03dac6;
}

.btn-add {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    padding: 12px 30px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-add:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
}

.devices-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.device-card {
    background: rgba(30, 30, 30, 0.95);
    padding: 20px;
    border-radius: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    position: relative;
}

.device-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #333;
}

.device-name {
    font-size: 1.2em;
    font-weight: bold;
    color: #03dac6;
}

.device-info {
    font-size: 0.75em;
    color: #888;
    margin-top: 3px;
}

.btn-delete {
    background: #cf6679;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.85em;
}

.btn-delete:hover {
    background: #b00020;
}

.relay-item {
    background: #1a1a1a;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
}

.relay-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.relay-label {
    font-weight: bold;
    color: #fff;
}

.relay-status {
    font-size: 0.85em;
    padding: 3px 10px;
    border-radius: 12px;
    background: #333;
    color: #aaa;
}

.relay-status.on {
    background: #4CAF50;
    color: white;
}

.relay-status.off {
    background: #666;
    color: white;
}

.btn-toggle {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
}

.btn-toggle.state-on {
    background: linear-gradient(135deg, #03dac6 0%, #00b8a9 100%);
    color: #000;
}

.btn-toggle.state-off {
    background: #333;
    color: #ccc;
    border: 2px solid #555;
}

.btn-toggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(3, 218, 198, 0.3);
}

.btn-toggle:active {
    transform: translateY(0);
}

.no-devices {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 1.1em;
}

.error-message {
    background: #cf6679;
    color: white;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    text-align: center;
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.mode-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 0.7em;
    font-weight: bold;
    margin-left: 5px;
}

.mode-mqtt {
    background: #2196F3;
    color: white;
}

.mode-local {
    background: #ff9800;
    color: white;
}
</style>
</head>
<body>

<div class="container">
    <h1>üéõÔ∏è ESP01 Merkezi Kontrol</h1>
    
    <div id="mqttStatus" class="mqtt-status connecting">
        ‚è≥ MQTT Broker'a baƒülanƒ±yor...
    </div>
    
    <!-- Cihaz Ekleme B√∂l√ºm√º -->
    <div class="add-device-section">
        <h3>‚ûï Yeni Cihaz Ekle</h3>
        <div id="addError" class="error-message" style="display:none"></div>
        <div class="input-row">
            <div class="input-group">
                <label>üìù Cihaz Adƒ±:</label>
                <input type="text" id="newDeviceName" placeholder="√ñrn: Salon, Mutfak">
            </div>
            <div class="input-group">
                <label>üåê IP Adresi (Opsiyonel - Yerel kontrol i√ßin):</label>
                <input type="text" id="newDeviceIP" placeholder="192.168.1.100">
            </div>
            <div class="input-group">
                <label>üéØ Kontrol Modu:</label>
                <select id="newDeviceMode">
                    <option value="mqtt">MQTT (Dƒ±≈üarƒ±dan Eri≈üim)</option>
                    <option value="local">HTTP (Sadece Yerel Aƒü)</option>
                    <option value="both">ƒ∞kisi de (Hybrid)</option>
                </select>
            </div>
        </div>
        <button class="btn-add" onclick="addDevice()">‚ûï Cihaz Ekle</button>
    </div>

    <!-- Cihazlar Grid -->
    <div id="devicesContainer" class="devices-grid"></div>
</div>

<script>
// MQTT Baƒülantƒ±sƒ±
const MQTT_BROKER = 'wss://broker.hivemq.com:8884/mqtt';
let mqttClient = null;

// MQTT Topic'leri (ESP32 kodunuzdaki ile AYNI olmalƒ±)
const TOPICS = {
    relay1Set: 'nejat/relay/1/set',
    relay2Set: 'nejat/relay/2/set',
    relay1State: 'nejat/relay/1/state',
    relay2State: 'nejat/relay/2/state',
    hubOnline: 'nejat/hub/online'
};

// Cihazlar listesi
let devices = [];

// MQTT Baƒülan
function connectMQTT() {
    updateMQTTStatus('connecting');
    
    mqttClient = mqtt.connect(MQTT_BROKER, {
        clientId: 'WebClient_' + Math.random().toString(16).substr(2, 8),
        clean: true,
        reconnectPeriod: 5000
    });
    
    mqttClient.on('connect', () => {
        console.log('‚úÖ MQTT Broker\'a baƒülandƒ±');
        updateMQTTStatus('connected');
        
        // Topic'lere abone ol
        mqttClient.subscribe(TOPICS.relay1State);
        mqttClient.subscribe(TOPICS.relay2State);
        mqttClient.subscribe(TOPICS.hubOnline);
    });
    
    mqttClient.on('error', (err) => {
        console.error('‚ùå MQTT Hatasƒ±:', err);
        updateMQTTStatus('disconnected');
    });
    
    mqttClient.on('close', () => {
        console.log('üîå MQTT Baƒülantƒ±sƒ± kesildi');
        updateMQTTStatus('disconnected');
    });
    
    // Gelen mesajlarƒ± dinle
    mqttClient.on('message', (topic, message) => {
        const msg = message.toString();
        console.log(`üì© ${topic}: ${msg}`);
        
        // R√∂le durumlarƒ±nƒ± g√ºncelle
        if (topic === TOPICS.relay1State) {
            updateRelayStatusFromMQTT(1, msg === '1' ? 'ON' : 'OFF');
        } else if (topic === TOPICS.relay2State) {
            updateRelayStatusFromMQTT(2, msg === '1' ? 'ON' : 'OFF');
        }
    });
}

// MQTT Durum G√ºncelle
function updateMQTTStatus(status) {
    const statusEl = document.getElementById('mqttStatus');
    if (status === 'connected') {
        statusEl.className = 'mqtt-status connected';
        statusEl.textContent = '‚úÖ MQTT Baƒülƒ± - Dƒ±≈üarƒ±dan Kontrol Aktif';
    } else if (status === 'disconnected') {
        statusEl.className = 'mqtt-status disconnected';
        statusEl.textContent = '‚ùå MQTT Baƒülantƒ±sƒ± Kesildi - Sadece Yerel Kontrol';
    } else {
        statusEl.className = 'mqtt-status connecting';
        statusEl.textContent = '‚è≥ MQTT Broker\'a baƒülanƒ±yor...';
    }
}

// MQTT'den gelen r√∂le durumunu g√ºncelle
function updateRelayStatusFromMQTT(relay, state) {
    devices.forEach((device, index) => {
        if (device.mode === 'mqtt' || device.mode === 'both') {
            device[`r${relay}_state`] = state;
            updateUI(index, relay, state);
        }
    });
}

// Sayfa y√ºklendiƒüinde
window.onload = () => {
    loadDevices();
    renderDevices();
    connectMQTT();
    
    // Yerel cihazlar i√ßin durum g√ºncellemesi
    setInterval(updateLocalDevices, 5000);
};

// Cihazlarƒ± y√ºkle
function loadDevices() {
    const saved = localStorage.getItem('esp_devices_mqtt');
    if (saved) {
        devices = JSON.parse(saved);
    }
}

// Cihazlarƒ± kaydet
function saveDevices() {
    localStorage.setItem('esp_devices_mqtt', JSON.stringify(devices));
}

// Yeni cihaz ekle
function addDevice() {
    const name = document.getElementById('newDeviceName').value.trim();
    const ip = document.getElementById('newDeviceIP').value.trim();
    const mode = document.getElementById('newDeviceMode').value;
    
    if (!name) {
        showAddError('‚ùå L√ºtfen cihaz adƒ± girin!');
        return;
    }
    
    if ((mode === 'local' || mode === 'both') && !ip) {
        showAddError('‚ùå Yerel kontrol i√ßin IP adresi gerekli!');
        return;
    }
    
    if (ip) {
        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipPattern.test(ip)) {
            showAddError('‚ùå Ge√ßersiz IP adresi formatƒ±!');
            return;
        }
    }
    
    if (devices.some(d => d.name === name)) {
        showAddError('‚ùå Bu isimde bir cihaz zaten var!');
        return;
    }
    
    devices.push({
        name: name,
        ip: ip || '',
        mode: mode,
        r1_state: 'OFF',
        r2_state: 'OFF'
    });
    
    saveDevices();
    renderDevices();
    
    document.getElementById('newDeviceName').value = '';
    document.getElementById('newDeviceIP').value = '';
    
    console.log(`‚úÖ Cihaz eklendi: ${name} (${mode.toUpperCase()} modu)`);
}

// Cihaz sil
function deleteDevice(index) {
    const device = devices[index];
    if (confirm(`"${device.name}" cihazƒ±nƒ± silmek istediƒüinize emin misiniz?`)) {
        devices.splice(index, 1);
        saveDevices();
        renderDevices();
    }
}

// Cihazlarƒ± render et
function renderDevices() {
    const container = document.getElementById('devicesContainer');
    
    if (devices.length === 0) {
        container.innerHTML = '<div class="no-devices">üì± Hen√ºz cihaz eklenmedi.<br>Yukarƒ±dan yeni cihaz ekleyin.</div>';
        return;
    }
    
    container.innerHTML = devices.map((device, index) => {
        const modeBadge = device.mode === 'mqtt' ? 'MQTT' : 
                         device.mode === 'local' ? 'YEREL' : 'HYBRƒ∞D';
        const modeClass = device.mode === 'mqtt' ? 'mode-mqtt' : 'mode-local';
        
        return `
        <div class="device-card">
            <div class="device-header">
                <div>
                    <div class="device-name">
                        ${device.name}
                        <span class="mode-badge ${modeClass}">${modeBadge}</span>
                    </div>
                    <div class="device-info">
                        ${device.ip ? 'üìç ' + device.ip : 'üì° MQTT Kontrol'}
                    </div>
                </div>
                <button class="btn-delete" onclick="deleteDevice(${index})">üóëÔ∏è</button>
            </div>
            
            <div class="relay-item">
                <div class="relay-header">
                    <span class="relay-label">R√∂le 1</span>
                    <span id="status_${index}_1" class="relay-status">-</span>
                </div>
                <button id="btn_${index}_1" class="btn-toggle state-off" onclick="toggleRelay(${index}, 1)">
                    üü¢ A√á
                </button>
            </div>
            
            <div class="relay-item">
                <div class="relay-header">
                    <span class="relay-label">R√∂le 2</span>
                    <span id="status_${index}_2" class="relay-status">-</span>
                </div>
                <button id="btn_${index}_2" class="btn-toggle state-off" onclick="toggleRelay(${index}, 2)">
                    üü¢ A√á
                </button>
            </div>
        </div>
    `}).join('');
    
    updateLocalDevices();
}

// Tek butonla toggle
async function toggleRelay(deviceIndex, relay) {
    const device = devices[deviceIndex];
    const currentState = device[`r${relay}_state`];
    const newAction = currentState === 'ON' ? 'OFF' : 'ON';
    
    const btn = document.getElementById(`btn_${deviceIndex}_${relay}`);
    btn.disabled = true;
    
    // MQTT ile kontrol
    if (device.mode === 'mqtt' || device.mode === 'both') {
        if (mqttClient && mqttClient.connected) {
            const topic = relay === 1 ? TOPICS.relay1Set : TOPICS.relay2Set;
            const message = newAction === 'ON' ? '1' : '0';
            
            mqttClient.publish(topic, message, { qos: 1 }, (err) => {
                if (!err) {
                    console.log(`‚úÖ MQTT: ${device.name} - R√∂le ${relay} ‚Üí ${newAction}`);
                    device[`r${relay}_state`] = newAction;
                    updateUI(deviceIndex, relay, newAction);
                } else {
                    console.error('‚ùå MQTT G√∂nderim hatasƒ±:', err);
                    alert('MQTT komutu g√∂nderilemedi!');
                }
                btn.disabled = false;
            });
        } else {
            alert('‚ùå MQTT baƒülantƒ±sƒ± yok!');
            btn.disabled = false;
        }
    }
    
    // HTTP ile kontrol (yerel)
    if (device.mode === 'local' || device.mode === 'both') {
        if (device.ip) {
            try {
                const action = newAction === 'ON' ? 'on' : 'off';
                const url = `http://${device.ip}/control?id=${relay}&action=${action}`;
                await fetch(url, { method: 'GET', mode: 'no-cors' });
                console.log(`‚úÖ HTTP: ${device.name} - R√∂le ${relay} ‚Üí ${newAction}`);
                
                setTimeout(() => updateLocalDeviceStatus(deviceIndex), 500);
            } catch (error) {
                console.error('‚ùå HTTP Hatasƒ±:', error);
            }
        }
        btn.disabled = false;
    }
}

// Yerel cihaz durumu g√ºncelle
async function updateLocalDeviceStatus(deviceIndex) {
    const device = devices[deviceIndex];
    if (!device.ip || (device.mode !== 'local' && device.mode !== 'both')) return;
    
    try {
        const response = await fetch(`http://${device.ip}/status`);
        if (response.ok) {
            const data = await response.json();
            device.r1_state = data.r1_state || 'OFF';
            device.r2_state = data.r2_state || 'OFF';
            updateUI(deviceIndex, 1, device.r1_state);
            updateUI(deviceIndex, 2, device.r2_state);
        }
    } catch (error) {
        console.log(`‚ö†Ô∏è ${device.name} yerel baƒülantƒ± hatasƒ±`);
    }
}

// T√ºm yerel cihazlarƒ± g√ºncelle
async function updateLocalDevices() {
    for (let i = 0; i < devices.length; i++) {
        if (devices[i].mode === 'local' || devices[i].mode === 'both') {
            await updateLocalDeviceStatus(i);
        }
    }
}

// UI g√ºncelle
function updateUI(deviceIndex, relay, state) {
    const statusEl = document.getElementById(`status_${deviceIndex}_${relay}`);
    const btnEl = document.getElementById(`btn_${deviceIndex}_${relay}`);
    
    if (!statusEl || !btnEl) return;
    
    if (state === 'ON') {
        statusEl.textContent = 'üü¢ A√áIK';
        statusEl.className = 'relay-status on';
        btnEl.textContent = 'üî¥ KAPAT';
        btnEl.className = 'btn-toggle state-on';
    } else {
        statusEl.textContent = '‚ö´ KAPALI';
        statusEl.className = 'relay-status off';
        btnEl.textContent = 'üü¢ A√á';
        btnEl.className = 'btn-toggle state-off';
    }
}

// Hata mesajƒ±
function showAddError(message) {
    const errorDiv = document.getElementById('addError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => errorDiv.style.display = 'none', 3000);
}
</script>

</body>
</html>
