<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Merkezi Hub v6.5 - ESP01 Kontrol Paneli</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body { font-family: Arial; background:#0f0f0f; color:#eee; margin:0; }
header { background:#222; padding:16px; text-align:center; font-size:22px; color:#00e5ff; font-weight:bold; }
.container { padding:10px; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:14px; padding:10px; }
.card { background:#1b1b1b; border-radius:14px; padding:16px; border:1px solid #333; box-shadow:0 0 8px #000; }
.card h3 { margin:0 0 10px 0; font-size:18px; color:#00e5ff; }
.card-info { font-size:13px; color:#aaa; margin:6px 0; display:flex; justify-content:space-between; }
.mqtt-info { font-size:11px; color:#888; background:#111; padding:4px 8px; border-radius:4px; margin:5px 0; font-family:monospace; word-break:break-all; }
.relay-container { background:#252525; padding:12px; border-radius:8px; margin:10px 0; border-left:4px solid #444; }
.relay-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.relay-title { font-size:14px; font-weight:bold; color:#bbb; }
.relay-status { font-size:12px; padding:2px 8px; border-radius:10px; background:#333; }
.status-on { background:#00e676; color:#000; }
.status-off { background:#333; color:#ccc; }
.status-error { background:#ff5252; color:#fff; }
.btn-group { display:flex; gap:8px; margin-top:10px; }
.btn { flex:1; padding:10px; border:none; border-radius:8px; font-size:13px; cursor:pointer; font-weight:bold; text-align:center; }
.btn-on { background:#00e676; color:#000; }
.btn-off { background:#333; color:#ccc; }
.btn-on.active { background:#00c853; box-shadow:0 0 10px #00e676; }
.btn-off.active { background:#444; box-shadow:0 0 10px #666; }
.btn-mqtt { background:#bb86fc; color:#000; font-size:12px; padding:8px; }
.addBox { background:#111; padding:12px; border-radius:10px; margin:10px; border:1px solid #333; }
.addBox input, .addBox select { width:100%; padding:10px; margin:5px 0; border-radius:8px; border:1px solid #555; background:#222; color:#fff; }
.addBox button { width:100%; padding:12px; margin-top:5px; background:#2196f3; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:15px; }
.all-buttons { display:flex; gap:12px; padding:12px; flex-wrap:wrap; }
.all-buttons button { flex:1; min-width:150px; padding:12px; border:none; border-radius:10px; font-size:14px; cursor:pointer; font-weight:bold; }
.device-count { text-align:center; padding:10px; color:#888; font-size:14px; }
.tab-buttons { display:flex; gap:5px; padding:10px; background:#1a1a1a; border-radius:10px; margin:10px; }
.tab-btn { flex:1; padding:10px; background:#222; border:1px solid #333; color:#ccc; border-radius:8px; cursor:pointer; }
.tab-btn.active { background:#3700b3; color:#fff; border-color:#6200ee; }
.connection-status { position:fixed; top:10px; right:10px; padding:5px 10px; border-radius:5px; font-size:12px; }
.status-connected { background:#00e676; color:#000; }
.status-disconnected { background:#ff5252; color:#fff; }
</style>
</head>
<body>

<header>MERKEZƒ∞ HUB v6.5 - ESP01 R√∂le Kontrol Paneli</header>

<!-- Baƒülantƒ± Durumu -->
<div id="mqttStatus" class="connection-status status-disconnected">MQTT: Baƒülanƒ±yor...</div>

<div class="container">

<!-- TAB Butonlarƒ± -->
<div class="tab-buttons">
  <button class="tab-btn active" onclick="showTab('http')">HTTP Kontrol</button>
  <button class="tab-btn" onclick="showTab('mqtt')">MQTT Kontrol</button>
  <button class="tab-btn" onclick="showTab('settings')">Ayarlar</button>
</div>

<!-- HTTP TAB -->
<div id="httpTab" class="tab-content">
  <!-- Mevcut HTTP kontrol aray√ºz√º buraya gelecek -->
  <div id="httpContent"></div>
</div>

<!-- MQTT TAB -->
<div id="mqttTab" class="tab-content" style="display:none">
  <div class="all-buttons">
    <button onclick="mqttTurnAll(1)" style="background:#00e676;color:#000">MQTT: T√úM√ú A√á</button>
    <button onclick="mqttTurnAll(0)" style="background:#ff5252;color:#fff">MQTT: T√úM√ú KAPAT</button>
    <button onclick="mqttRefreshAll()" style="background:#2196f3;color:#fff">üîÅ Durumlarƒ± Yenile</button>
  </div>
  
  <div class="device-count" id="mqttDeviceCount">MQTT Cihazlarƒ±: 0</div>
  
  <!-- MQTT Cihaz Grid -->
  <div id="mqttDeviceGrid" class="grid"></div>
  
  <!-- MQTT Cihaz Ekleme -->
  <div class="addBox">
    <h3>‚ûï Yeni MQTT Cihaz Ekle</h3>
    <input id="mqttDevName" placeholder="Cihaz Adƒ± (√∂rn: Salon ESP01)">
    <input id="mqttBaseTopic" placeholder="Base Topic (√∂rn: nejat/esp01_1)">
    <input id="mqttDevIP" placeholder="IP Adresi (aynƒ± cihaz i√ßin)">
    <select id="mqttRelayCount">
      <option value="1">1 R√∂le</option>
      <option value="2" selected>2 R√∂le</option>
      <option value="4">4 R√∂le</option>
      <option value="8">8 R√∂le</option>
    </select>
    <button onclick="addMqttDevice()">MQTT Cƒ∞HAZI EKLE</button>
  </div>
</div>

<!-- AYARLAR TAB -->
<div id="settingsTab" class="tab-content" style="display:none">
  <div class="addBox">
    <h3>‚öôÔ∏è MQTT Ayarlarƒ±</h3>
    <input id="mqttBroker" placeholder="MQTT Broker (wss://broker.hivemq.com:8884/mqtt)" value="wss://broker.hivemq.com:8884/mqtt">
    <input id="mqttUsername" placeholder="Kullanƒ±cƒ± Adƒ± (opsiyonel)">
    <input id="mqttPassword" placeholder="≈ûifre (opsiyonel)" type="password">
    <button onclick="saveMqttSettings()">MQTT AYARLARINI KAYDET</button>
  </div>
  
  <div style="background:#111; padding:15px; border-radius:10px; margin:10px;">
    <h3>üìä Sistem Bilgileri</h3>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <div>Toplam HTTP Cihaz: <span id="httpCount">0</span></div>
      <div>Toplam MQTT Cihaz: <span id="mqttCount">0</span></div>
      <div>MQTT Baƒülantƒ±: <span id="mqttConnStatus">‚ùå</span></div>
      <div>Son G√ºncelleme: <span id="lastUpdate">-</span></div>
    </div>
  </div>
</div>

</div>

<script>
// --------------------------------------------------
// MQTT BAƒûLANTI AYARLARI
// --------------------------------------------------
let mqttClient = null;
let mqttSettings = JSON.parse(localStorage.getItem("mqttSettings") || '{"broker":"wss://broker.hivemq.com:8884/mqtt"}');
let mqttDevices = JSON.parse(localStorage.getItem("mqttDevices") || "[]");
let httpDevices = []; // HTTP cihazlarƒ± buraya gelecek

// --------------------------------------------------
// TAB G√ñSTERME
// --------------------------------------------------
function showTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
  
  event.target.classList.add('active');
  document.getElementById(tabName + 'Tab').style.display = 'block';
  
  if(tabName === 'mqtt') {
    mqttConnect();
    renderMqttDevices();
  } else if(tabName === 'http') {
    loadHttpDevices();
  }
}

// --------------------------------------------------
// MQTT BAƒûLANTISI
// --------------------------------------------------
function mqttConnect() {
  if(mqttClient && mqttClient.connected) return;
  
  const broker = mqttSettings.broker || "wss://broker.hivemq.com:8884/mqtt";
  const options = {
    clientId: 'merkezihub_' + Math.random().toString(16).substr(2, 8),
    clean: true,
    reconnectPeriod: 1000,
    connectTimeout: 4000
  };
  
  if(mqttSettings.username) {
    options.username = mqttSettings.username;
    options.password = mqttSettings.password;
  }
  
  try {
    mqttClient = mqtt.connect(broker, options);
    
    mqttClient.on('connect', () => {
      console.log("MQTT Baƒülandƒ±");
      document.getElementById('mqttStatus').className = 'connection-status status-connected';
      document.getElementById('mqttStatus').textContent = 'MQTT: Baƒülƒ±';
      document.getElementById('mqttConnStatus').innerHTML = '‚úÖ';
      
      // T√ºm topic'lere subscribe ol
      mqttDevices.forEach(device => {
        for(let i = 1; i <= device.relayCount; i++) {
          mqttClient.subscribe(`${device.baseTopic}/r√∂le${i}/state`);
        }
      });
    });
    
    mqttClient.on('error', (err) => {
      console.error("MQTT Error:", err);
      document.getElementById('mqttStatus').className = 'connection-status status-disconnected';
      document.getElementById('mqttStatus').textContent = 'MQTT: Hata';
      document.getElementById('mqttConnStatus').innerHTML = '‚ùå';
    });
    
    mqttClient.on('message', (topic, message) => {
      const msg = message.toString();
      console.log(`MQTT Mesaj: ${topic} = ${msg}`);
      
      // Cihaz durumlarƒ±nƒ± g√ºncelle
      mqttDevices.forEach((device, devIndex) => {
        for(let i = 1; i <= device.relayCount; i++) {
          if(topic === `${device.baseTopic}/r√∂le${i}/state`) {
            device[`relay${i}_status`] = msg;
            updateMqttRelayUI(devIndex, i, msg);
          }
        }
      });
    });
    
    mqttClient.on('close', () => {
      document.getElementById('mqttStatus').className = 'connection-status status-disconnected';
      document.getElementById('mqttStatus').textContent = 'MQTT: Baƒülantƒ± Kapandƒ±';
      document.getElementById('mqttConnStatus').innerHTML = '‚ùå';
    });
    
  } catch(err) {
    console.error("MQTT Baƒülantƒ± Hatasƒ±:", err);
  }
}

// --------------------------------------------------
// MQTT Cƒ∞HAZ EKLEME
// --------------------------------------------------
function addMqttDevice() {
  const name = document.getElementById('mqttDevName').value.trim();
  const baseTopic = document.getElementById('mqttBaseTopic').value.trim();
  const ip = document.getElementById('mqttDevIP').value.trim();
  const relayCount = parseInt(document.getElementById('mqttRelayCount').value);
  
  if(!name || !baseTopic) {
    alert("Cihaz adƒ± ve Base Topic gereklidir!");
    return;
  }
  
  // Topic formatƒ±nƒ± d√ºzenle
  const cleanTopic = baseTopic.replace(/\/+$/,''); // Sondaki slash'ƒ± temizle
  
  const newDevice = {
    id: Date.now(),
    name: name,
    baseTopic: cleanTopic,
    ip: ip,
    relayCount: relayCount,
    // Her r√∂le i√ßin ba≈ülangƒ±√ß durumu
    ...Array.from({length: relayCount}, (_, i) => ({[`relay${i+1}_status`]: "0"}))
  };
  
  mqttDevices.push(newDevice);
  localStorage.setItem("mqttDevices", JSON.stringify(mqttDevices));
  
  // Alanlarƒ± temizle
  document.getElementById('mqttDevName').value = "";
  document.getElementById('mqttBaseTopic').value = "";
  document.getElementById('mqttDevIP').value = "";
  
  // MQTT'ye subscribe ol
  if(mqttClient && mqttClient.connected) {
    for(let i = 1; i <= relayCount; i++) {
      mqttClient.subscribe(`${cleanTopic}/r√∂le${i}/state`);
    }
  }
  
  renderMqttDevices();
}

// --------------------------------------------------
// MQTT Cƒ∞HAZLARI G√ñSTER
// --------------------------------------------------
function renderMqttDevices() {
  const grid = document.getElementById('mqttDeviceGrid');
  const count = document.getElementById('mqttDeviceCount');
  
  count.textContent = `MQTT Cihazlarƒ±: ${mqttDevices.length}`;
  grid.innerHTML = '';
  
  if(mqttDevices.length === 0) {
    grid.innerHTML = `
      <div style="text-align:center; padding:40px; grid-column:1/-1; color:#888;">
        <h3>üì≠ MQTT Cihazƒ± Yok</h3>
        <p>A≈üaƒüƒ±dan MQTT cihazƒ± ekleyin.</p>
      </div>`;
    return;
  }
  
  mqttDevices.forEach((device, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    
    let relaysHtml = '';
    for(let i = 1; i <= device.relayCount; i++) {
      const status = device[`relay${i}_status`] || "0";
      const isOn = status === "1";
      
      relaysHtml += `
        <div class="relay-container">
          <div class="relay-header">
            <div class="relay-title">R√∂le ${i}</div>
            <div class="relay-status ${isOn ? 'status-on' : 'status-off'}">
              ${isOn ? 'A√áIK' : 'KAPALI'}
            </div>
          </div>
          
          <div class="mqtt-info">
            <div>Set: ${device.baseTopic}/r√∂le${i}/set</div>
            <div>State: ${device.baseTopic}/r√∂le${i}/state</div>
          </div>
          
          <div class="btn-group">
            <button class="btn btn-on ${isOn ? 'active' : ''}" 
                    onclick="mqttControlRelay(${index}, ${i}, '1')">
              üîÜ A√á
            </button>
            <button class="btn btn-off ${!isOn ? 'active' : ''}" 
                    onclick="mqttControlRelay(${index}, ${i}, '0')">
              üåô KAPAT
            </button>
          </div>
        </div>`;
    }
    
    card.innerHTML = `
      <h3>${device.name}</h3>
      <div class="card-info">
        <span>IP: ${device.ip || '-'}</span>
        <span>${device.relayCount} R√∂le</span>
      </div>
      <div class="mqtt-info" style="margin-bottom:10px;">
        Base Topic: ${device.baseTopic}
      </div>
      ${relaysHtml}
      <div style="margin-top:10px; text-align:center;">
        <button class="btn" onclick="deleteMqttDevice(${index})" 
                style="background:transparent; color:#ff5252; border:1px solid #ff5252; font-size:12px;">
          üóëÔ∏è Cihazƒ± Sil
        </button>
      </div>`;
    
    grid.appendChild(card);
  });
}

// --------------------------------------------------
// MQTT R√ñLE KONTROL√ú
// --------------------------------------------------
function mqttControlRelay(deviceIndex, relayNum, state) {
  const device = mqttDevices[deviceIndex];
  const topic = `${device.baseTopic}/r√∂le${relayNum}/set`;
  
  if(mqttClient && mqttClient.connected) {
    mqttClient.publish(topic, state, { retain: true });
    
    // Optimistik UI g√ºncellemesi
    device[`relay${relayNum}_status`] = state;
    updateMqttRelayUI(deviceIndex, relayNum, state);
    
    console.log(`MQTT G√∂nderildi: ${topic} = ${state}`);
  } else {
    alert("MQTT baƒülantƒ±sƒ± yok!");
  }
}

function updateMqttRelayUI(deviceIndex, relayNum, state) {
  const isOn = state === "1";
  const card = document.getElementById('mqttDeviceGrid').children[deviceIndex];
  if(!card) return;
  
  const relayContainer = card.querySelectorAll('.relay-container')[relayNum - 1];
  if(relayContainer) {
    const statusDiv = relayContainer.querySelector('.relay-status');
    const onBtn = relayContainer.querySelector('.btn-on');
    const offBtn = relayContainer.querySelector('.btn-off');
    
    if(statusDiv) {
      statusDiv.className = `relay-status ${isOn ? 'status-on' : 'status-off'}`;
      statusDiv.textContent = isOn ? 'A√áIK' : 'KAPALI';
    }
    
    if(onBtn) onBtn.classList.toggle('active', isOn);
    if(offBtn) offBtn.classList.toggle('active', !isOn);
  }
}

// --------------------------------------------------
// TOPLU MQTT KONTROLLERƒ∞
// --------------------------------------------------
function mqttTurnAll(state) {
  if(!mqttClient || !mqttClient.connected) {
    alert("MQTT baƒülantƒ±sƒ± yok!");
    return;
  }
  
  mqttDevices.forEach(device => {
    for(let i = 1; i <= device.relayCount; i++) {
      const topic = `${device.baseTopic}/r√∂le${i}/set`;
      mqttClient.publish(topic, String(state), { retain: true });
      device[`relay${i}_status`] = String(state);
    }
  });
  
  setTimeout(() => renderMqttDevices(), 500);
  alert(`T√ºm r√∂leler ${state ? 'A√áILDI' : 'KAPANDI'}`);
}

function mqttRefreshAll() {
  if(!mqttClient || !mqttClient.connected) {
    alert("MQTT baƒülantƒ±sƒ± yok!");
    return;
  }
  
  // State topic'lerine bo≈ü mesaj g√∂ndererek g√ºncelleme iste
  mqttDevices.forEach(device => {
    for(let i = 1; i <= device.relayCount; i++) {
      const topic = `${device.baseTopic}/r√∂le${i}/state`;
      mqttClient.publish(topic + "/get", "");
    }
  });
  
  setTimeout(() => renderMqttDevices(), 1000);
  alert("Durumlar yenileniyor...");
}

// --------------------------------------------------
// MQTT Cƒ∞HAZ Sƒ∞LME
// --------------------------------------------------
function deleteMqttDevice(index) {
  if(confirm(`"${mqttDevices[index].name}" cihazƒ±nƒ± silmek istiyor musunuz?`)) {
    mqttDevices.splice(index, 1);
    localStorage.setItem("mqttDevices", JSON.stringify(mqttDevices));
    renderMqttDevices();
  }
}

// --------------------------------------------------
// MQTT AYARLARI
// --------------------------------------------------
function saveMqttSettings() {
  mqttSettings.broker = document.getElementById('mqttBroker').value;
  mqttSettings.username = document.getElementById('mqttUsername').value;
  mqttSettings.password = document.getElementById('mqttPassword').value;
  
  localStorage.setItem("mqttSettings", JSON.stringify(mqttSettings));
  
  // Yeniden baƒülan
  if(mqttClient) {
    mqttClient.end();
    mqttClient = null;
  }
  
  alert("MQTT ayarlarƒ± kaydedildi. Yeniden baƒülanƒ±lƒ±yor...");
  setTimeout(mqttConnect, 1000);
}

// --------------------------------------------------
// HTTP Cƒ∞HAZLARINI Y√úKLE
// --------------------------------------------------
function loadHttpDevices() {
  // Bu kƒ±sƒ±m mevcut HTTP sisteminden cihazlarƒ± √ßekecek
  // √ñrnek:
  fetch('/get_devices')
    .then(r => r.json())
    .then(devices => {
      httpDevices = devices;
      document.getElementById('httpCount').textContent = devices.length;
      renderHttpDevices();
    });
}

function renderHttpDevices() {
  const content = document.getElementById('httpContent');
  // Mevcut HTTP aray√ºz√ºn√º buraya y√ºkle
  content.innerHTML = "<h3>HTTP Kontrol Paneli Y√ºkleniyor...</h3>";
}

// --------------------------------------------------
// SAYFA Y√úKLENƒ∞NCE
// --------------------------------------------------
document.addEventListener('DOMContentLoaded', function() {
  // MQTT ayarlarƒ±nƒ± y√ºkle
  document.getElementById('mqttBroker').value = mqttSettings.broker || "wss://broker.hivemq.com:8884/mqtt";
  document.getElementById('mqttUsername').value = mqttSettings.username || "";
  document.getElementById('mqttPassword').value = mqttSettings.password || "";
  
  // ƒ∞statistikleri g√ºncelle
  document.getElementById('mqttCount').textContent = mqttDevices.length;
  document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
  
  // HTTP cihazlarƒ±nƒ± y√ºkle
  loadHttpDevices();
});

// --------------------------------------------------
// PERƒ∞YODƒ∞K G√úNCELLEME
// --------------------------------------------------
setInterval(() => {
  document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
}, 60000);
</script>
</body>
</html>
