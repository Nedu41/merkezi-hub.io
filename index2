<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Merkezi Hub v5.5 (Proxy Mode)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
 body {background:#111;color:#eee;font-family:Arial;margin:0;padding:0;}
 header {background:#222;padding:15px;text-align:center;font-size:20px;color:#0ff;}
 .grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;padding:12px;}
 .card {background:#1e1e1e;padding:12px;border-radius:10px;border:1px solid #333;}
 .btn {width:100%;padding:10px;border:none;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;}
 .on {background:#03dac6;color:#000;}
 .off {background:#333;color:#ccc;}
 .ipbar {background:#000;padding:10px;font-size:14px;text-align:center;color:#0f0;}
</style>
</head>
<body>
<header>MERKEZİ HUB (HTTPS → ESP32 PROXY MODU)</header>
<div class="ipbar" id="ipInfo">ESP32 IP: (Ayarlanmadı)</div>
<div class="grid" id="deviceGrid"></div>

<script>
//--------------------------------------------------
// CONFIG
//--------------------------------------------------
let ESP32_IP = localStorage.getItem("esp32_ip") || "";
const PROXY_URL = "https://merkezi-hub.io/proxy.php";  // SENİN SUNUCUN

updateIPBar();
//--------------------------------------------------
// IP AYAR FONKSIYONU
//--------------------------------------------------
function updateIPBar(){
    const bar = document.getElementById("ipInfo");
    if(!ESP32_IP){ bar.textContent = "ESP32 IP: Ayarlanmadı"; bar.style.color="#f33"; return; }
    bar.textContent = "ESP32 IP: " + ESP32_IP;
    bar.style.color="#0f0";
}

function setESP32IP(){
    const ip = prompt("ESP32 IP Adresini Giriniz", ESP32_IP || "192.168.1.113");
    if(!ip) return;
    ESP32_IP = ip.trim();
    localStorage.setItem("esp32_ip", ESP32_IP);
    updateIPBar();
    loadDevices();
}

//--------------------------------------------------
// PROXY ÜZERİNDEN FETCH
//--------------------------------------------------
async function espFetch(path){
    if(!ESP32_IP) return alert("Önce ESP32 IP ayarla");

    const url = `${PROXY_URL}?ip=${ESP32_IP}&url=${encodeURIComponent(path)}`;

    const res = await fetch(url, {method:"GET"});
    return res.text();
}
//--------------------------------------------------
// CİHAZLARI YÜKLE
//--------------------------------------------------
async function loadDevices(){
    try{
        const raw = await espFetch("/get_devices");
        const list = JSON.parse(raw);
        renderDevices(list);
    }catch(e){
        console.error(e);
        alert("Cihaz listesi alınamadı. IP yanlış olabilir.");
    }
}
//--------------------------------------------------
// ARAYÜZE CİHAZLARI BAS
//--------------------------------------------------
function renderDevices(list){
    const grid = document.getElementById("deviceGrid");
    grid.innerHTML = "";

    list.forEach((dev,i)=>{
        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
            <h4>${dev.name}</h4>
            <button class="btn off" id="dev${i}" onclick="toggle(${i}, '${dev.ip}')">YÜKLENİYOR...</button>
        `;
        grid.appendChild(div);
        fetchStatus(i, dev.ip);
    });
}
//--------------------------------------------------
// DURUM ÇEK
//--------------------------------------------------
async function fetchStatus(index, ip){
    try{
        const raw = await espFetch(`/proxy?ip=${ip}&url=/status`);
        const state = raw.trim();
        const btn = document.getElementById("dev"+index);
        if(state === "1"){
            btn.textContent = "AÇIK";
            btn.className = "btn on";
        } else {
            btn.textContent = "KAPALI";
            btn.className = "btn off";
        }
    } catch(e){ console.warn("Durum alınamadı", e); }
}
//--------------------------------------------------
// AÇ/KAPA
//--------------------------------------------------
async function toggle(index, ip){
    const btn = document.getElementById("dev"+index);
    const isOn = btn.textContent === "AÇIK";
    const cmd = isOn ? "0" : "1";

    await espFetch(`/proxy?ip=${ip}&url=/control?set=${cmd}`);
    fetchStatus(index, ip);
}
//--------------------------------------------------
// BAŞLAT
//--------------------------------------------------
if(!ESP32_IP){ setTimeout(()=>{ setESP32IP(); }, 500); }
else loadDevices();
</script>

</body>
</html>
