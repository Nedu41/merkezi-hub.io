<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>ESP01 Debug Kontrol</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 20px; }
        .log-box { background: black; color: #00ff00; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px; border: 1px solid #333; }
        .device-card { background: #1e1e1e; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 5px solid #2196f3; }
        .relay-card { background: #2a2a2a; padding: 10px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px; cursor: pointer; font-weight: bold; margin: 5px; }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 3px; font-size: 12px; }
        .status-on { background: green; }
        .status-off { background: red; }
    </style>
</head>
<body>
    <h2>ESP01 Kontrol Test Paneli</h2>
    
    <div id="status">MQTT BaÄŸlantÄ±sÄ± Bekleniyor...</div>
    <div class="log-box" id="log">Sistem baÅŸlatÄ±ldÄ±...<br></div>
    
    <div class="device-card">
        <h3>Cihaz AyarlarÄ±</h3>
        <input type="text" id="macInput" placeholder="MAC (Ã–rn: aabbcc112233)" style="padding:8px; width:250px;">
        <button onclick="connectDevice()" style="background: #2196f3; color: white;">BaÄŸlan</button>
        <p style="font-size: 11px; color: #888;">Not: MAC adresini kÃ¼Ã§Ã¼k harfle ve iki noktasÄ±z girin.</p>
    </div>
    
    <div class="device-card" id="controlPanel" style="display:none;">
        <h3>RÃ¶le KontrolÃ¼</h3>
        
        <div class="relay-card">
            <h4>RÃ¶le 1 <span class="status-badge status-off" id="r1status">Bilinmiyor</span></h4>
            <button onclick="sendCommand('r1', '1')" style="background: green; color: white;">AÃ‡</button>
            <button onclick="sendCommand('r1', '0')" style="background: red; color: white;">KAPAT</button>
        </div>
        
        <div class="relay-card">
            <h4>RÃ¶le 2 <span class="status-badge status-off" id="r2status">Bilinmiyor</span></h4>
            <button onclick="sendCommand('r2', '1')" style="background: green; color: white;">AÃ‡</button>
            <button onclick="sendCommand('r2', '0')" style="background: red; color: white;">KAPAT</button>
        </div>
    </div>
    
    <script>
        const logEl = document.getElementById('log');
        const statusEl = document.getElementById('status');
        let currentMac = "";
        let subscribedTopics = [];
        
        const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");
        
        function addLog(msg) {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${msg}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        client.on("connect", () => {
            statusEl.innerText = "BAÄžLANDI: broker.hivemq.com";
            statusEl.style.color = "#00ff00";
            addLog("âœ“ MQTT Broker'a baÄŸlanÄ±ldÄ±.");
        });
        
        client.on("error", (err) => {
            addLog("âœ— HATA: " + err);
            statusEl.style.color = "#ff0000";
        });
        
        client.on("message", (topic, message) => {
            const msg = message.toString();
            addLog(`ðŸ“¨ GERÄ° BÄ°LDÄ°RÄ°M: ${topic} = ${msg}`);
            
            // Durum gÃ¼ncelleme
            if(topic.includes("/r1/state")) {
                updateStatus('r1', msg);
            } else if(topic.includes("/r2/state")) {
                updateStatus('r2', msg);
            }
        });
        
        function connectDevice() {
            const mac = document.getElementById('macInput').value.trim().toLowerCase();
            if(!mac) { 
                alert("LÃ¼tfen MAC adresini girin!"); 
                return; 
            }
            
            currentMac = mac;
            
            // Eski abonelikleri iptal et
            subscribedTopics.forEach(topic => client.unsubscribe(topic));
            subscribedTopics = [];
            
            // Yeni abonelikler
            const topics = [
                `esp01/${mac}/r1/state`,
                `esp01/${mac}/r2/state`
            ];
            
            topics.forEach(topic => {
                client.subscribe(topic);
                subscribedTopics.push(topic);
                addLog(`ðŸ”” Abone olundu: ${topic}`);
            });
            
            document.getElementById('controlPanel').style.display = 'block';
            addLog(`âœ“ Cihaz baÄŸlandÄ±: ${mac}`);
        }
        
        function sendCommand(relay, value) {
            if(!currentMac) { 
                alert("Ã–nce cihaza baÄŸlanÄ±n!"); 
                return; 
            }
            
            const topic = `esp01/${currentMac}/${relay}/set`;
            addLog(`ðŸ“¤ GÃ¶nderiliyor: ${topic} = ${value}`);
            
            client.publish(topic, value, { qos: 0, retain: true }, (err) => {
                if(err) addLog(`âœ— GÃ¶nderim HATASI: ${err}`);
                else addLog(`âœ“ Komut gÃ¶nderildi.`);
            });
        }
        
        function updateStatus(relay, value) {
            const statusEl = document.getElementById(relay + 'status');
            if(value === "1") {
                statusEl.textContent = "AÃ‡IK";
                statusEl.className = "status-badge status-on";
            } else {
                statusEl.textContent = "KAPALI";
                statusEl.className = "status-badge status-off";
            }
        }
    </script>
</body>
</html>
