<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>ESP01 Merkezi Hub v7.0</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #0f0f12; color: #eee; padding: 20px; }
        .card { background: #1a1a1f; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        input { background: #222; border: 1px solid #444; color: #fff; padding: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; border-radius: 6px; }
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: bold; padding: 10px; }
        .btn-relay { width: 48%; margin: 1%; }
        .on { background: #00e676; color: #000; }
        .off { background: #333; color: #aaa; }
        #log { background: #000; color: #00ff00; height: 120px; overflow-y: auto; font-family: monospace; font-size: 11px; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="card">
        <h3>MQTT Sunucu Ayarları</h3>
        <input type="text" id="mqttHost" value="broker.hivemq.com">
        <button onclick="initMQTT()" style="background: #2196f3; color: white;">SUNUCUYA BAĞLAN</button>
    </div>

    <div class="card">
        <h3 id="formTitle">Cihaz Ekle / Düzenle</h3>
        <input type="hidden" id="editIdx" value="-1">
        <input type="text" id="dName" placeholder="Cihaz Adı">
        <input type="text" id="dMAC" placeholder="MAC (AABBCCDDEEFF)">
        <button onclick="saveDevice()" style="background: #00e5ff; width: 100%; color: #000;">KAYDET</button>
    </div>

    <div class="grid" id="grid"></div>

    <h4>Sistem Logları</h4>
    <div id="log"></div>

<script>
    let client;
    let devices = JSON.parse(localStorage.getItem("hub_v7") || "[]");

    function addLog(m) {
        const l = document.getElementById('log');
        l.innerHTML += `> ${m}<br>`;
        l.scrollTop = l.scrollHeight;
    }

    function initMQTT() {
        if(client) client.end();
        const host = document.getElementById('mqttHost').value;
        client = mqtt.connect(`wss://${host}:8884/mqtt`);
        
        client.on("connect", () => {
            addLog("Bağlantı kuruldu: " + host);
            devices.forEach(d => {
                client.subscribe(`esp01/${d.mac}/r1/state`);
                client.subscribe(`esp01/${d.mac}/r2/state`);
            });
        });

        client.on("message", (topic, msg) => {
            const val = msg.toString();
            addLog(`Geri Bildirim: ${topic} = ${val}`);
            devices.forEach(d => {
                if(topic === `esp01/${d.mac}/r1/state`) d.r1 = val;
                if(topic === `esp01/${d.mac}/r2/state`) d.r2 = val;
            });
            render();
        });
    }

    function saveDevice() {
        const name = document.getElementById('dName').value;
        const mac = document.getElementById('dMAC').value.toLowerCase().replace(/:/g, "");
        const idx = parseInt(document.getElementById('editIdx').value);

        if(idx === -1) devices.push({name, mac, r1:"0", r2:"0"});
        else devices[idx] = { ...devices[idx], name, mac };

        localStorage.setItem("hub_v7", JSON.stringify(devices));
        location.reload();
    }

    function render() {
        const g = document.getElementById('grid');
        g.innerHTML = "";
        devices.forEach((d, i) => {
            const c = document.createElement("div");
            c.className = "card";
            c.innerHTML = `
                <strong>${d.name}</strong> <small>(${d.mac})</small>
                <div style="margin-top:10px;">
                    <button class="btn-relay ${d.r1==='1'?'on':'off'}" onclick="send(${i}, 1)">R1: ${d.r1==='1'?'AÇIK':'KAPALI'}</button>
                    <button class="btn-relay ${d.r2==='1'?'on':'off'}" onclick="send(${i}, 2)">R2: ${d.r2==='1'?'AÇIK':'KAPALI'}</button>
                </div>
                <button onclick="edit(${i})" style="font-size:10px; color:#aaa; background:none;">Düzenle</button>
            `;
            g.appendChild(c);
        });
    }

    function send(i, r) {
        const d = devices[i];
        const next = (r === 1 ? d.r1 : d.r2) === "1" ? "0" : "1";
        client.publish(`esp01/${d.mac}/r${r}/set`, next, {retain: true});
    }

    function edit(i) {
        document.getElementById('dName').value = devices[i].name;
        document.getElementById('dMAC').value = devices[i].mac;
        document.getElementById('editIdx').value = i;
        document.getElementById('formTitle').innerText = "Cihazı Güncelle";
    }

    initMQTT();
    render();
</script>
</body>
</html>
